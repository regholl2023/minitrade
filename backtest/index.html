
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-8.5.10">
    
    
      
        <title>minitrade.backtest - Minitrade</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-HK9C9K1N4Q"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-HK9C9K1N4Q",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-HK9C9K1N4Q",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#minitradebacktest" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Minitrade" class="md-header__button md-logo" aria-label="Minitrade" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Minitrade
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              minitrade.backtest
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/dodid/minitrade" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        API Reference
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../examples/" class="md-tabs__link">
        Examples
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Minitrade" class="md-nav__button md-logo" aria-label="Minitrade" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Minitrade
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dodid/minitrade" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="..">Home</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../backtesting/" class="md-nav__link">
        Backtesting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../strategy/" class="md-nav__link">
        Writing strategy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../trading/" class="md-nav__link">
        Trading
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        Command Line
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../compatibility/" class="md-nav__link">
        Compatibility
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          minitrade.backtest
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        minitrade.backtest
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#minitradebacktestcore" class="md-nav__link">
    minitrade.backtest.core
  </a>
  
    <nav class="md-nav" aria-label="minitrade.backtest.core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting" class="md-nav__link">
    backtesting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation" class="md-nav__link">
    Allocation
  </a>
  
    <nav class="md-nav" aria-label="Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.current" class="md-nav__link">
    current
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.delta" class="md-nav__link">
    delta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.modified" class="md-nav__link">
    modified
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.previous" class="md-nav__link">
    previous
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.selected" class="md-nav__link">
    selected
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.add" class="md-nav__link">
    add()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.drop" class="md-nav__link">
    drop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.equal_weight" class="md-nav__link">
    equal_weight()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest" class="md-nav__link">
    Backtest
  </a>
  
    <nav class="md-nav" aria-label="Backtest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.optimize" class="md-nav__link">
    optimize()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.plot" class="md-nav__link">
    plot()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order" class="md-nav__link">
    Order
  </a>
  
    <nav class="md-nav" aria-label="Order">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.entry_time" class="md-nav__link">
    entry_time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.is_contingent" class="md-nav__link">
    is_contingent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.is_long" class="md-nav__link">
    is_long
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.is_short" class="md-nav__link">
    is_short
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.limit" class="md-nav__link">
    limit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.size" class="md-nav__link">
    size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.sl" class="md-nav__link">
    sl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.stop" class="md-nav__link">
    stop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.tag" class="md-nav__link">
    tag
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.tp" class="md-nav__link">
    tp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.cancel" class="md-nav__link">
    cancel()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position" class="md-nav__link">
    Position
  </a>
  
    <nav class="md-nav" aria-label="Position">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.is_long" class="md-nav__link">
    is_long
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.is_short" class="md-nav__link">
    is_short
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.pl" class="md-nav__link">
    pl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.pl_pct" class="md-nav__link">
    pl_pct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.size" class="md-nav__link">
    size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy" class="md-nav__link">
    Strategy
  </a>
  
    <nav class="md-nav" aria-label="Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.alloc" class="md-nav__link">
    alloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.closed_trades" class="md-nav__link">
    closed_trades
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.data" class="md-nav__link">
    data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.equity" class="md-nav__link">
    equity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.orders" class="md-nav__link">
    orders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.I" class="md-nav__link">
    I()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.buy" class="md-nav__link">
    buy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.init" class="md-nav__link">
    init()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.next" class="md-nav__link">
    next()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.position" class="md-nav__link">
    position()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.rebalance" class="md-nav__link">
    rebalance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.record" class="md-nav__link">
    record()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.sell" class="md-nav__link">
    sell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.trades" class="md-nav__link">
    trades()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade" class="md-nav__link">
    Trade
  </a>
  
    <nav class="md-nav" aria-label="Trade">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.entry_bar" class="md-nav__link">
    entry_bar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.entry_price" class="md-nav__link">
    entry_price
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.entry_time" class="md-nav__link">
    entry_time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.exit_bar" class="md-nav__link">
    exit_bar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.exit_price" class="md-nav__link">
    exit_price
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.exit_time" class="md-nav__link">
    exit_time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.is_long" class="md-nav__link">
    is_long
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.is_short" class="md-nav__link">
    is_short
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.pl" class="md-nav__link">
    pl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.pl_pct" class="md-nav__link">
    pl_pct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.size" class="md-nav__link">
    size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.sl" class="md-nav__link">
    sl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.tag" class="md-nav__link">
    tag
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.tp" class="md-nav__link">
    tp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.value" class="md-nav__link">
    value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minitradebacktestutils" class="md-nav__link">
    minitrade.backtest.utils
  </a>
  
    <nav class="md-nav" aria-label="minitrade.backtest.utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils" class="md-nav__link">
    utils
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.backtest_strategy_on_portfolios" class="md-nav__link">
    backtest_strategy_on_portfolios()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.backtest_strategy_parameters" class="md-nav__link">
    backtest_strategy_parameters()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.calculate_positions" class="md-nav__link">
    calculate_positions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.calculate_trade_stats" class="md-nav__link">
    calculate_trade_stats()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.generate_random_portfolios" class="md-nav__link">
    generate_random_portfolios()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.plot_heatmap" class="md-nav__link">
    plot_heatmap()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../datasource/" class="md-nav__link">
        minitrade.datasource
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../broker/" class="md-nav__link">
        minitrade.broker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../trader/" class="md-nav__link">
        minitrade.trader
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../examples/">Original from Backtesting.py</a>
          
            <label for="__nav_3_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Original from Backtesting.py" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Original from Backtesting.py
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/Quick%20Start%20User%20Guide/" class="md-nav__link">
        Backtesting.py Quick Start User Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/Strategies%20Library/" class="md-nav__link">
        Library of Composable Base Strategies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/Multiple%20Time%20Frames/" class="md-nav__link">
        Multiple Time Frames
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/Parameter%20Heatmap%20%26%20Optimization/" class="md-nav__link">
        Parameter Heatmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/Trading%20with%20Machine%20Learning/" class="md-nav__link">
        Trading with Machine Learning Models
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#minitradebacktestcore" class="md-nav__link">
    minitrade.backtest.core
  </a>
  
    <nav class="md-nav" aria-label="minitrade.backtest.core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting" class="md-nav__link">
    backtesting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation" class="md-nav__link">
    Allocation
  </a>
  
    <nav class="md-nav" aria-label="Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.current" class="md-nav__link">
    current
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.delta" class="md-nav__link">
    delta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.modified" class="md-nav__link">
    modified
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.previous" class="md-nav__link">
    previous
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.selected" class="md-nav__link">
    selected
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.add" class="md-nav__link">
    add()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.drop" class="md-nav__link">
    drop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Allocation.equal_weight" class="md-nav__link">
    equal_weight()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest" class="md-nav__link">
    Backtest
  </a>
  
    <nav class="md-nav" aria-label="Backtest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.optimize" class="md-nav__link">
    optimize()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.plot" class="md-nav__link">
    plot()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Backtest.run" class="md-nav__link">
    run()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order" class="md-nav__link">
    Order
  </a>
  
    <nav class="md-nav" aria-label="Order">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.entry_time" class="md-nav__link">
    entry_time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.is_contingent" class="md-nav__link">
    is_contingent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.is_long" class="md-nav__link">
    is_long
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.is_short" class="md-nav__link">
    is_short
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.limit" class="md-nav__link">
    limit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.size" class="md-nav__link">
    size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.sl" class="md-nav__link">
    sl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.stop" class="md-nav__link">
    stop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.tag" class="md-nav__link">
    tag
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.tp" class="md-nav__link">
    tp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Order.cancel" class="md-nav__link">
    cancel()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position" class="md-nav__link">
    Position
  </a>
  
    <nav class="md-nav" aria-label="Position">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.is_long" class="md-nav__link">
    is_long
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.is_short" class="md-nav__link">
    is_short
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.pl" class="md-nav__link">
    pl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.pl_pct" class="md-nav__link">
    pl_pct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.size" class="md-nav__link">
    size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Position.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy" class="md-nav__link">
    Strategy
  </a>
  
    <nav class="md-nav" aria-label="Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.alloc" class="md-nav__link">
    alloc
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.closed_trades" class="md-nav__link">
    closed_trades
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.data" class="md-nav__link">
    data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.equity" class="md-nav__link">
    equity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.orders" class="md-nav__link">
    orders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.I" class="md-nav__link">
    I()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.buy" class="md-nav__link">
    buy()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.init" class="md-nav__link">
    init()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.next" class="md-nav__link">
    next()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.position" class="md-nav__link">
    position()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.rebalance" class="md-nav__link">
    rebalance()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.record" class="md-nav__link">
    record()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.sell" class="md-nav__link">
    sell()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Strategy.trades" class="md-nav__link">
    trades()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade" class="md-nav__link">
    Trade
  </a>
  
    <nav class="md-nav" aria-label="Trade">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.entry_bar" class="md-nav__link">
    entry_bar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.entry_price" class="md-nav__link">
    entry_price
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.entry_time" class="md-nav__link">
    entry_time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.exit_bar" class="md-nav__link">
    exit_bar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.exit_price" class="md-nav__link">
    exit_price
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.exit_time" class="md-nav__link">
    exit_time
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.is_long" class="md-nav__link">
    is_long
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.is_short" class="md-nav__link">
    is_short
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.pl" class="md-nav__link">
    pl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.pl_pct" class="md-nav__link">
    pl_pct
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.size" class="md-nav__link">
    size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.sl" class="md-nav__link">
    sl
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.tag" class="md-nav__link">
    tag
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.tp" class="md-nav__link">
    tp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.value" class="md-nav__link">
    value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.core.backtesting.Trade.close" class="md-nav__link">
    close()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minitradebacktestutils" class="md-nav__link">
    minitrade.backtest.utils
  </a>
  
    <nav class="md-nav" aria-label="minitrade.backtest.utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils" class="md-nav__link">
    utils
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.backtest_strategy_on_portfolios" class="md-nav__link">
    backtest_strategy_on_portfolios()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.backtest_strategy_parameters" class="md-nav__link">
    backtest_strategy_parameters()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.calculate_positions" class="md-nav__link">
    calculate_positions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.calculate_trade_stats" class="md-nav__link">
    calculate_trade_stats()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.generate_random_portfolios" class="md-nav__link">
    generate_random_portfolios()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minitrade.backtest.utils.plot_heatmap" class="md-nav__link">
    plot_heatmap()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/dodid/minitrade/edit/master/docs/backtest.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="minitradebacktest">minitrade.backtest</h1>
<h2 id="minitradebacktestcore">minitrade.backtest.core</h2>


<div class="doc doc-object doc-module">



<a id="minitrade.backtest.core.backtesting"></a>
  <div class="doc doc-contents first">
  
      <p>Core framework data structures.
Objects from this module can also be imported from the top-level
module directly, e.g.</p>
<div class="highlight"><pre><span></span><code>from minitrade.backtest import Backtest, Strategy
</code></pre></div>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h3 id="minitrade.backtest.core.backtesting.Allocation" class="doc doc-heading">
          <code>Allocation</code>


</h3>


  <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="k">class</span> <span class="nc">Allocation</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">):</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="n">tickers</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">tickers</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">def</span> <span class="nf">selected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Assets in the candidate pool&#39;&#39;&#39;</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Current weights being assigned to assets&#39;&#39;&#39;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="nd">@current</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Weight must be positive and sum up to less than 1. Got </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">def</span> <span class="nf">previous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Previous weights being assigned to assets&#39;&#39;&#39;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Weight change of current allocation vs. previous one&#39;&#39;&#39;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;True if weight allocation changes from previous to current.&#39;&#39;&#39;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">where</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">list</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Add assets to the candidate pool that will make up the new portfolio.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        Multiple conditions can be specified and assets meet all conditions, i.e.,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        conditions joined by logical `and`, will be added to the candidate pool. </span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        Each condition can take one of two forms:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        1. As a boolean Series with assets as the index and a True value to indicate </span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        the asset should be included.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        2. A list of assets or anything list-like. Assets appeared in the list are to be included.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        `limit` controls the maximum number of assets that should be included in the </span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        portfolio. Suppose the candidate pool contains 2 assets before the call. During</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        the call, 3 new assets meet all conditions, and the limit is 4, then only the </span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        first 2 new assets will be added to the pool. However, if limit is 1, it will</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        not drop assets from the pool, only no new asset will be added.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">            where: A list of conditions</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">            limit: Maximum number of assets should be included</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">selected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">where</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">condition</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">selected</span> <span class="o">&amp;=</span> <span class="n">condition</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">selected</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="k">break</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">where</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">list</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Drop assets from the candidate pool that will make up the new portfolio.</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        Multiple conditions can be specified and assets meet all conditions, i.e.,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        conditions joined by logical `and`, will be dropped from the candidate pool. </span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        Each condition can take one of two forms:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        1. As a boolean Series with assets as the index and a True value to indicate </span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        the asset should be removed.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        2. A list of assets or anything list-like. Assets appeared in the list are to be removed.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        `limit` controls the maximum number of assets that should be included in the </span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        portfolio. Suppose the candidate pool contains 4 assets before the call. During</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        the call, 3 new assets meet all conditions, and the limit is 2, then only the </span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        first 2 assets will be dropped from the pool. However, if no assets meet the </span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        conditions, the pool will not automatically shrink in size to satisify the limit.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">            where: A list of conditions</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">            limit: Maximum number of assets should be included</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">selected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">where</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="n">condition</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="n">selected</span> <span class="o">&amp;=</span> <span class="n">condition</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">selected</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                    <span class="k">break</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="k">def</span> <span class="nf">equal_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sum_</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Allocate equity value equally to the candidate pool.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        `sum_` should be between 0 and 1, with 1 means 100% of value should be allocated.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            sum_: Total weight that should be allocated. </span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">if</span> <span class="n">sum_</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">or</span> <span class="n">sum_</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total weight should be within [0, 1], given </span><span class="si">{</span><span class="n">sum_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span> <span class="o">*</span> <span class="n">sum_</span> <span class="o">/</span> <span class="n">selected</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="k">def</span> <span class="nf">_next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Allocation.current" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">current</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Current weights being assigned to assets</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Allocation.delta" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">delta</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Weight change of current allocation vs. previous one</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Allocation.modified" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">modified</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True if weight allocation changes from previous to current.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Allocation.previous" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">previous</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Previous weights being assigned to assets</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Allocation.selected" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">selected</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Assets in the candidate pool</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Allocation.add" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">where</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Add assets to the candidate pool that will make up the new portfolio.</p>
<p>Multiple conditions can be specified and assets meet all conditions, i.e.,
conditions joined by logical <code>and</code>, will be added to the candidate pool. 
Each condition can take one of two forms:</p>
<ol>
<li>As a boolean Series with assets as the index and a True value to indicate 
the asset should be included.</li>
<li>A list of assets or anything list-like. Assets appeared in the list are to be included.</li>
</ol>
<p><code>limit</code> controls the maximum number of assets that should be included in the 
portfolio. Suppose the candidate pool contains 2 assets before the call. During
the call, 3 new assets meet all conditions, and the limit is 4, then only the 
first 2 new assets will be added to the pool. However, if limit is 1, it will
not drop assets from the pool, only no new asset will be added.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>where</code></td>
          <td>
                <code><span title="pandas.Series">Series</span> | list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of conditions</p>
            </div>
          </td>
          <td>
                <code>()</code>
          </td>
        </tr>
        <tr>
          <td><code>limit</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum number of assets should be included</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">where</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">list</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Add assets to the candidate pool that will make up the new portfolio.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Multiple conditions can be specified and assets meet all conditions, i.e.,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    conditions joined by logical `and`, will be added to the candidate pool. </span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Each condition can take one of two forms:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    1. As a boolean Series with assets as the index and a True value to indicate </span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    the asset should be included.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    2. A list of assets or anything list-like. Assets appeared in the list are to be included.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    `limit` controls the maximum number of assets that should be included in the </span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">    portfolio. Suppose the candidate pool contains 2 assets before the call. During</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    the call, 3 new assets meet all conditions, and the limit is 4, then only the </span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    first 2 new assets will be added to the pool. However, if limit is 1, it will</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    not drop assets from the pool, only no new asset will be added.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        where: A list of conditions</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        limit: Maximum number of assets should be included</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">selected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">where</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">condition</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">selected</span> <span class="o">&amp;=</span> <span class="n">condition</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">selected</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="k">break</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Allocation.drop" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">drop</span><span class="p">(</span><span class="o">*</span><span class="n">where</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Drop assets from the candidate pool that will make up the new portfolio.</p>
<p>Multiple conditions can be specified and assets meet all conditions, i.e.,
conditions joined by logical <code>and</code>, will be dropped from the candidate pool. 
Each condition can take one of two forms:</p>
<ol>
<li>As a boolean Series with assets as the index and a True value to indicate 
the asset should be removed.</li>
<li>A list of assets or anything list-like. Assets appeared in the list are to be removed.</li>
</ol>
<p><code>limit</code> controls the maximum number of assets that should be included in the 
portfolio. Suppose the candidate pool contains 4 assets before the call. During
the call, 3 new assets meet all conditions, and the limit is 2, then only the 
first 2 assets will be dropped from the pool. However, if no assets meet the 
conditions, the pool will not automatically shrink in size to satisify the limit.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>where</code></td>
          <td>
                <code><span title="pandas.Series">Series</span> | list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of conditions</p>
            </div>
          </td>
          <td>
                <code>()</code>
          </td>
        </tr>
        <tr>
          <td><code>limit</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximum number of assets should be included</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">where</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">list</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Drop assets from the candidate pool that will make up the new portfolio.</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    Multiple conditions can be specified and assets meet all conditions, i.e.,</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    conditions joined by logical `and`, will be dropped from the candidate pool. </span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    Each condition can take one of two forms:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    1. As a boolean Series with assets as the index and a True value to indicate </span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    the asset should be removed.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    2. A list of assets or anything list-like. Assets appeared in the list are to be removed.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    `limit` controls the maximum number of assets that should be included in the </span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    portfolio. Suppose the candidate pool contains 4 assets before the call. During</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    the call, 3 new assets meet all conditions, and the limit is 2, then only the </span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    first 2 assets will be dropped from the pool. However, if no assets meet the </span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">    conditions, the pool will not automatically shrink in size to satisify the limit.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        where: A list of conditions</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        limit: Maximum number of assets should be included</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">selected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">where</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="n">condition</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">selected</span> <span class="o">&amp;=</span> <span class="n">condition</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">selected</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="k">break</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Allocation.equal_weight" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">equal_weight</span><span class="p">(</span><span class="n">sum_</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Allocate equity value equally to the candidate pool.</p>
<p><code>sum_</code> should be between 0 and 1, with 1 means 100% of value should be allocated.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>sum_</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Total weight that should be allocated.</p>
            </div>
          </td>
          <td>
                <code>1.0</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="k">def</span> <span class="nf">equal_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sum_</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Allocate equity value equally to the candidate pool.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    `sum_` should be between 0 and 1, with 1 means 100% of value should be allocated.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        sum_: Total weight that should be allocated. </span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="k">if</span> <span class="n">sum_</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">or</span> <span class="n">sum_</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total weight should be within [0, 1], given </span><span class="si">{</span><span class="n">sum_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span> <span class="o">*</span> <span class="n">sum_</span> <span class="o">/</span> <span class="n">selected</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h3 id="minitrade.backtest.core.backtesting.Backtest" class="doc doc-heading">
          <code>Backtest</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>Backtest a particular (parameterized) strategy
on particular data.</p>
<p>Upon initialization, call method
<code>minitrade.backtest.core.backtesting.Backtest.run</code> to run a backtest
instance, or <code>minitrade.backtest.core.backtesting.Backtest.optimize</code> to
optimize it.</p>

            <details class="quote">
              <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span>
<span class="normal"><a href="#__codelineno-0-1569">1569</a></span>
<span class="normal"><a href="#__codelineno-0-1570">1570</a></span>
<span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span>
<span class="normal"><a href="#__codelineno-0-1589">1589</a></span>
<span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span>
<span class="normal"><a href="#__codelineno-0-1613">1613</a></span>
<span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span>
<span class="normal"><a href="#__codelineno-0-1622">1622</a></span>
<span class="normal"><a href="#__codelineno-0-1623">1623</a></span>
<span class="normal"><a href="#__codelineno-0-1624">1624</a></span>
<span class="normal"><a href="#__codelineno-0-1625">1625</a></span>
<span class="normal"><a href="#__codelineno-0-1626">1626</a></span>
<span class="normal"><a href="#__codelineno-0-1627">1627</a></span>
<span class="normal"><a href="#__codelineno-0-1628">1628</a></span>
<span class="normal"><a href="#__codelineno-0-1629">1629</a></span>
<span class="normal"><a href="#__codelineno-0-1630">1630</a></span>
<span class="normal"><a href="#__codelineno-0-1631">1631</a></span>
<span class="normal"><a href="#__codelineno-0-1632">1632</a></span>
<span class="normal"><a href="#__codelineno-0-1633">1633</a></span>
<span class="normal"><a href="#__codelineno-0-1634">1634</a></span>
<span class="normal"><a href="#__codelineno-0-1635">1635</a></span>
<span class="normal"><a href="#__codelineno-0-1636">1636</a></span>
<span class="normal"><a href="#__codelineno-0-1637">1637</a></span>
<span class="normal"><a href="#__codelineno-0-1638">1638</a></span>
<span class="normal"><a href="#__codelineno-0-1639">1639</a></span>
<span class="normal"><a href="#__codelineno-0-1640">1640</a></span>
<span class="normal"><a href="#__codelineno-0-1641">1641</a></span>
<span class="normal"><a href="#__codelineno-0-1642">1642</a></span>
<span class="normal"><a href="#__codelineno-0-1643">1643</a></span>
<span class="normal"><a href="#__codelineno-0-1644">1644</a></span>
<span class="normal"><a href="#__codelineno-0-1645">1645</a></span>
<span class="normal"><a href="#__codelineno-0-1646">1646</a></span>
<span class="normal"><a href="#__codelineno-0-1647">1647</a></span>
<span class="normal"><a href="#__codelineno-0-1648">1648</a></span>
<span class="normal"><a href="#__codelineno-0-1649">1649</a></span>
<span class="normal"><a href="#__codelineno-0-1650">1650</a></span>
<span class="normal"><a href="#__codelineno-0-1651">1651</a></span>
<span class="normal"><a href="#__codelineno-0-1652">1652</a></span>
<span class="normal"><a href="#__codelineno-0-1653">1653</a></span>
<span class="normal"><a href="#__codelineno-0-1654">1654</a></span>
<span class="normal"><a href="#__codelineno-0-1655">1655</a></span>
<span class="normal"><a href="#__codelineno-0-1656">1656</a></span>
<span class="normal"><a href="#__codelineno-0-1657">1657</a></span>
<span class="normal"><a href="#__codelineno-0-1658">1658</a></span>
<span class="normal"><a href="#__codelineno-0-1659">1659</a></span>
<span class="normal"><a href="#__codelineno-0-1660">1660</a></span>
<span class="normal"><a href="#__codelineno-0-1661">1661</a></span>
<span class="normal"><a href="#__codelineno-0-1662">1662</a></span>
<span class="normal"><a href="#__codelineno-0-1663">1663</a></span>
<span class="normal"><a href="#__codelineno-0-1664">1664</a></span>
<span class="normal"><a href="#__codelineno-0-1665">1665</a></span>
<span class="normal"><a href="#__codelineno-0-1666">1666</a></span>
<span class="normal"><a href="#__codelineno-0-1667">1667</a></span>
<span class="normal"><a href="#__codelineno-0-1668">1668</a></span>
<span class="normal"><a href="#__codelineno-0-1669">1669</a></span>
<span class="normal"><a href="#__codelineno-0-1670">1670</a></span>
<span class="normal"><a href="#__codelineno-0-1671">1671</a></span>
<span class="normal"><a href="#__codelineno-0-1672">1672</a></span>
<span class="normal"><a href="#__codelineno-0-1673">1673</a></span>
<span class="normal"><a href="#__codelineno-0-1674">1674</a></span>
<span class="normal"><a href="#__codelineno-0-1675">1675</a></span>
<span class="normal"><a href="#__codelineno-0-1676">1676</a></span>
<span class="normal"><a href="#__codelineno-0-1677">1677</a></span>
<span class="normal"><a href="#__codelineno-0-1678">1678</a></span>
<span class="normal"><a href="#__codelineno-0-1679">1679</a></span>
<span class="normal"><a href="#__codelineno-0-1680">1680</a></span>
<span class="normal"><a href="#__codelineno-0-1681">1681</a></span>
<span class="normal"><a href="#__codelineno-0-1682">1682</a></span>
<span class="normal"><a href="#__codelineno-0-1683">1683</a></span>
<span class="normal"><a href="#__codelineno-0-1684">1684</a></span>
<span class="normal"><a href="#__codelineno-0-1685">1685</a></span>
<span class="normal"><a href="#__codelineno-0-1686">1686</a></span>
<span class="normal"><a href="#__codelineno-0-1687">1687</a></span>
<span class="normal"><a href="#__codelineno-0-1688">1688</a></span>
<span class="normal"><a href="#__codelineno-0-1689">1689</a></span>
<span class="normal"><a href="#__codelineno-0-1690">1690</a></span>
<span class="normal"><a href="#__codelineno-0-1691">1691</a></span>
<span class="normal"><a href="#__codelineno-0-1692">1692</a></span>
<span class="normal"><a href="#__codelineno-0-1693">1693</a></span>
<span class="normal"><a href="#__codelineno-0-1694">1694</a></span>
<span class="normal"><a href="#__codelineno-0-1695">1695</a></span>
<span class="normal"><a href="#__codelineno-0-1696">1696</a></span>
<span class="normal"><a href="#__codelineno-0-1697">1697</a></span>
<span class="normal"><a href="#__codelineno-0-1698">1698</a></span>
<span class="normal"><a href="#__codelineno-0-1699">1699</a></span>
<span class="normal"><a href="#__codelineno-0-1700">1700</a></span>
<span class="normal"><a href="#__codelineno-0-1701">1701</a></span>
<span class="normal"><a href="#__codelineno-0-1702">1702</a></span>
<span class="normal"><a href="#__codelineno-0-1703">1703</a></span>
<span class="normal"><a href="#__codelineno-0-1704">1704</a></span>
<span class="normal"><a href="#__codelineno-0-1705">1705</a></span>
<span class="normal"><a href="#__codelineno-0-1706">1706</a></span>
<span class="normal"><a href="#__codelineno-0-1707">1707</a></span>
<span class="normal"><a href="#__codelineno-0-1708">1708</a></span>
<span class="normal"><a href="#__codelineno-0-1709">1709</a></span>
<span class="normal"><a href="#__codelineno-0-1710">1710</a></span>
<span class="normal"><a href="#__codelineno-0-1711">1711</a></span>
<span class="normal"><a href="#__codelineno-0-1712">1712</a></span>
<span class="normal"><a href="#__codelineno-0-1713">1713</a></span>
<span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span>
<span class="normal"><a href="#__codelineno-0-1730">1730</a></span>
<span class="normal"><a href="#__codelineno-0-1731">1731</a></span>
<span class="normal"><a href="#__codelineno-0-1732">1732</a></span>
<span class="normal"><a href="#__codelineno-0-1733">1733</a></span>
<span class="normal"><a href="#__codelineno-0-1734">1734</a></span>
<span class="normal"><a href="#__codelineno-0-1735">1735</a></span>
<span class="normal"><a href="#__codelineno-0-1736">1736</a></span>
<span class="normal"><a href="#__codelineno-0-1737">1737</a></span>
<span class="normal"><a href="#__codelineno-0-1738">1738</a></span>
<span class="normal"><a href="#__codelineno-0-1739">1739</a></span>
<span class="normal"><a href="#__codelineno-0-1740">1740</a></span>
<span class="normal"><a href="#__codelineno-0-1741">1741</a></span>
<span class="normal"><a href="#__codelineno-0-1742">1742</a></span>
<span class="normal"><a href="#__codelineno-0-1743">1743</a></span>
<span class="normal"><a href="#__codelineno-0-1744">1744</a></span>
<span class="normal"><a href="#__codelineno-0-1745">1745</a></span>
<span class="normal"><a href="#__codelineno-0-1746">1746</a></span>
<span class="normal"><a href="#__codelineno-0-1747">1747</a></span>
<span class="normal"><a href="#__codelineno-0-1748">1748</a></span>
<span class="normal"><a href="#__codelineno-0-1749">1749</a></span>
<span class="normal"><a href="#__codelineno-0-1750">1750</a></span>
<span class="normal"><a href="#__codelineno-0-1751">1751</a></span>
<span class="normal"><a href="#__codelineno-0-1752">1752</a></span>
<span class="normal"><a href="#__codelineno-0-1753">1753</a></span>
<span class="normal"><a href="#__codelineno-0-1754">1754</a></span>
<span class="normal"><a href="#__codelineno-0-1755">1755</a></span>
<span class="normal"><a href="#__codelineno-0-1756">1756</a></span>
<span class="normal"><a href="#__codelineno-0-1757">1757</a></span>
<span class="normal"><a href="#__codelineno-0-1758">1758</a></span>
<span class="normal"><a href="#__codelineno-0-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-0-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-0-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-0-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-0-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-0-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-0-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-0-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-0-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-0-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-0-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-0-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-0-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span>
<span class="normal"><a href="#__codelineno-0-1796">1796</a></span>
<span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span>
<span class="normal"><a href="#__codelineno-0-1802">1802</a></span>
<span class="normal"><a href="#__codelineno-0-1803">1803</a></span>
<span class="normal"><a href="#__codelineno-0-1804">1804</a></span>
<span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span>
<span class="normal"><a href="#__codelineno-0-1815">1815</a></span>
<span class="normal"><a href="#__codelineno-0-1816">1816</a></span>
<span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span>
<span class="normal"><a href="#__codelineno-0-1825">1825</a></span>
<span class="normal"><a href="#__codelineno-0-1826">1826</a></span>
<span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span>
<span class="normal"><a href="#__codelineno-0-1899">1899</a></span>
<span class="normal"><a href="#__codelineno-0-1900">1900</a></span>
<span class="normal"><a href="#__codelineno-0-1901">1901</a></span>
<span class="normal"><a href="#__codelineno-0-1902">1902</a></span>
<span class="normal"><a href="#__codelineno-0-1903">1903</a></span>
<span class="normal"><a href="#__codelineno-0-1904">1904</a></span>
<span class="normal"><a href="#__codelineno-0-1905">1905</a></span>
<span class="normal"><a href="#__codelineno-0-1906">1906</a></span>
<span class="normal"><a href="#__codelineno-0-1907">1907</a></span>
<span class="normal"><a href="#__codelineno-0-1908">1908</a></span>
<span class="normal"><a href="#__codelineno-0-1909">1909</a></span>
<span class="normal"><a href="#__codelineno-0-1910">1910</a></span>
<span class="normal"><a href="#__codelineno-0-1911">1911</a></span>
<span class="normal"><a href="#__codelineno-0-1912">1912</a></span>
<span class="normal"><a href="#__codelineno-0-1913">1913</a></span>
<span class="normal"><a href="#__codelineno-0-1914">1914</a></span>
<span class="normal"><a href="#__codelineno-0-1915">1915</a></span>
<span class="normal"><a href="#__codelineno-0-1916">1916</a></span>
<span class="normal"><a href="#__codelineno-0-1917">1917</a></span>
<span class="normal"><a href="#__codelineno-0-1918">1918</a></span>
<span class="normal"><a href="#__codelineno-0-1919">1919</a></span>
<span class="normal"><a href="#__codelineno-0-1920">1920</a></span>
<span class="normal"><a href="#__codelineno-0-1921">1921</a></span>
<span class="normal"><a href="#__codelineno-0-1922">1922</a></span>
<span class="normal"><a href="#__codelineno-0-1923">1923</a></span>
<span class="normal"><a href="#__codelineno-0-1924">1924</a></span>
<span class="normal"><a href="#__codelineno-0-1925">1925</a></span>
<span class="normal"><a href="#__codelineno-0-1926">1926</a></span>
<span class="normal"><a href="#__codelineno-0-1927">1927</a></span>
<span class="normal"><a href="#__codelineno-0-1928">1928</a></span>
<span class="normal"><a href="#__codelineno-0-1929">1929</a></span>
<span class="normal"><a href="#__codelineno-0-1930">1930</a></span>
<span class="normal"><a href="#__codelineno-0-1931">1931</a></span>
<span class="normal"><a href="#__codelineno-0-1932">1932</a></span>
<span class="normal"><a href="#__codelineno-0-1933">1933</a></span>
<span class="normal"><a href="#__codelineno-0-1934">1934</a></span>
<span class="normal"><a href="#__codelineno-0-1935">1935</a></span>
<span class="normal"><a href="#__codelineno-0-1936">1936</a></span>
<span class="normal"><a href="#__codelineno-0-1937">1937</a></span>
<span class="normal"><a href="#__codelineno-0-1938">1938</a></span>
<span class="normal"><a href="#__codelineno-0-1939">1939</a></span>
<span class="normal"><a href="#__codelineno-0-1940">1940</a></span>
<span class="normal"><a href="#__codelineno-0-1941">1941</a></span>
<span class="normal"><a href="#__codelineno-0-1942">1942</a></span>
<span class="normal"><a href="#__codelineno-0-1943">1943</a></span>
<span class="normal"><a href="#__codelineno-0-1944">1944</a></span>
<span class="normal"><a href="#__codelineno-0-1945">1945</a></span>
<span class="normal"><a href="#__codelineno-0-1946">1946</a></span>
<span class="normal"><a href="#__codelineno-0-1947">1947</a></span>
<span class="normal"><a href="#__codelineno-0-1948">1948</a></span>
<span class="normal"><a href="#__codelineno-0-1949">1949</a></span>
<span class="normal"><a href="#__codelineno-0-1950">1950</a></span>
<span class="normal"><a href="#__codelineno-0-1951">1951</a></span>
<span class="normal"><a href="#__codelineno-0-1952">1952</a></span>
<span class="normal"><a href="#__codelineno-0-1953">1953</a></span>
<span class="normal"><a href="#__codelineno-0-1954">1954</a></span>
<span class="normal"><a href="#__codelineno-0-1955">1955</a></span>
<span class="normal"><a href="#__codelineno-0-1956">1956</a></span>
<span class="normal"><a href="#__codelineno-0-1957">1957</a></span>
<span class="normal"><a href="#__codelineno-0-1958">1958</a></span>
<span class="normal"><a href="#__codelineno-0-1959">1959</a></span>
<span class="normal"><a href="#__codelineno-0-1960">1960</a></span>
<span class="normal"><a href="#__codelineno-0-1961">1961</a></span>
<span class="normal"><a href="#__codelineno-0-1962">1962</a></span>
<span class="normal"><a href="#__codelineno-0-1963">1963</a></span>
<span class="normal"><a href="#__codelineno-0-1964">1964</a></span>
<span class="normal"><a href="#__codelineno-0-1965">1965</a></span>
<span class="normal"><a href="#__codelineno-0-1966">1966</a></span>
<span class="normal"><a href="#__codelineno-0-1967">1967</a></span>
<span class="normal"><a href="#__codelineno-0-1968">1968</a></span>
<span class="normal"><a href="#__codelineno-0-1969">1969</a></span>
<span class="normal"><a href="#__codelineno-0-1970">1970</a></span>
<span class="normal"><a href="#__codelineno-0-1971">1971</a></span>
<span class="normal"><a href="#__codelineno-0-1972">1972</a></span>
<span class="normal"><a href="#__codelineno-0-1973">1973</a></span>
<span class="normal"><a href="#__codelineno-0-1974">1974</a></span>
<span class="normal"><a href="#__codelineno-0-1975">1975</a></span>
<span class="normal"><a href="#__codelineno-0-1976">1976</a></span>
<span class="normal"><a href="#__codelineno-0-1977">1977</a></span>
<span class="normal"><a href="#__codelineno-0-1978">1978</a></span>
<span class="normal"><a href="#__codelineno-0-1979">1979</a></span>
<span class="normal"><a href="#__codelineno-0-1980">1980</a></span>
<span class="normal"><a href="#__codelineno-0-1981">1981</a></span>
<span class="normal"><a href="#__codelineno-0-1982">1982</a></span>
<span class="normal"><a href="#__codelineno-0-1983">1983</a></span>
<span class="normal"><a href="#__codelineno-0-1984">1984</a></span>
<span class="normal"><a href="#__codelineno-0-1985">1985</a></span>
<span class="normal"><a href="#__codelineno-0-1986">1986</a></span>
<span class="normal"><a href="#__codelineno-0-1987">1987</a></span>
<span class="normal"><a href="#__codelineno-0-1988">1988</a></span>
<span class="normal"><a href="#__codelineno-0-1989">1989</a></span>
<span class="normal"><a href="#__codelineno-0-1990">1990</a></span>
<span class="normal"><a href="#__codelineno-0-1991">1991</a></span>
<span class="normal"><a href="#__codelineno-0-1992">1992</a></span>
<span class="normal"><a href="#__codelineno-0-1993">1993</a></span>
<span class="normal"><a href="#__codelineno-0-1994">1994</a></span>
<span class="normal"><a href="#__codelineno-0-1995">1995</a></span>
<span class="normal"><a href="#__codelineno-0-1996">1996</a></span>
<span class="normal"><a href="#__codelineno-0-1997">1997</a></span>
<span class="normal"><a href="#__codelineno-0-1998">1998</a></span>
<span class="normal"><a href="#__codelineno-0-1999">1999</a></span>
<span class="normal"><a href="#__codelineno-0-2000">2000</a></span>
<span class="normal"><a href="#__codelineno-0-2001">2001</a></span>
<span class="normal"><a href="#__codelineno-0-2002">2002</a></span>
<span class="normal"><a href="#__codelineno-0-2003">2003</a></span>
<span class="normal"><a href="#__codelineno-0-2004">2004</a></span>
<span class="normal"><a href="#__codelineno-0-2005">2005</a></span>
<span class="normal"><a href="#__codelineno-0-2006">2006</a></span>
<span class="normal"><a href="#__codelineno-0-2007">2007</a></span>
<span class="normal"><a href="#__codelineno-0-2008">2008</a></span>
<span class="normal"><a href="#__codelineno-0-2009">2009</a></span>
<span class="normal"><a href="#__codelineno-0-2010">2010</a></span>
<span class="normal"><a href="#__codelineno-0-2011">2011</a></span>
<span class="normal"><a href="#__codelineno-0-2012">2012</a></span>
<span class="normal"><a href="#__codelineno-0-2013">2013</a></span>
<span class="normal"><a href="#__codelineno-0-2014">2014</a></span>
<span class="normal"><a href="#__codelineno-0-2015">2015</a></span>
<span class="normal"><a href="#__codelineno-0-2016">2016</a></span>
<span class="normal"><a href="#__codelineno-0-2017">2017</a></span>
<span class="normal"><a href="#__codelineno-0-2018">2018</a></span>
<span class="normal"><a href="#__codelineno-0-2019">2019</a></span>
<span class="normal"><a href="#__codelineno-0-2020">2020</a></span>
<span class="normal"><a href="#__codelineno-0-2021">2021</a></span>
<span class="normal"><a href="#__codelineno-0-2022">2022</a></span>
<span class="normal"><a href="#__codelineno-0-2023">2023</a></span>
<span class="normal"><a href="#__codelineno-0-2024">2024</a></span>
<span class="normal"><a href="#__codelineno-0-2025">2025</a></span>
<span class="normal"><a href="#__codelineno-0-2026">2026</a></span>
<span class="normal"><a href="#__codelineno-0-2027">2027</a></span>
<span class="normal"><a href="#__codelineno-0-2028">2028</a></span>
<span class="normal"><a href="#__codelineno-0-2029">2029</a></span>
<span class="normal"><a href="#__codelineno-0-2030">2030</a></span>
<span class="normal"><a href="#__codelineno-0-2031">2031</a></span>
<span class="normal"><a href="#__codelineno-0-2032">2032</a></span>
<span class="normal"><a href="#__codelineno-0-2033">2033</a></span>
<span class="normal"><a href="#__codelineno-0-2034">2034</a></span>
<span class="normal"><a href="#__codelineno-0-2035">2035</a></span>
<span class="normal"><a href="#__codelineno-0-2036">2036</a></span>
<span class="normal"><a href="#__codelineno-0-2037">2037</a></span>
<span class="normal"><a href="#__codelineno-0-2038">2038</a></span>
<span class="normal"><a href="#__codelineno-0-2039">2039</a></span>
<span class="normal"><a href="#__codelineno-0-2040">2040</a></span>
<span class="normal"><a href="#__codelineno-0-2041">2041</a></span>
<span class="normal"><a href="#__codelineno-0-2042">2042</a></span>
<span class="normal"><a href="#__codelineno-0-2043">2043</a></span>
<span class="normal"><a href="#__codelineno-0-2044">2044</a></span>
<span class="normal"><a href="#__codelineno-0-2045">2045</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1331" name="__codelineno-0-1331"></a><span class="k">class</span> <span class="nc">Backtest</span><span class="p">:</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a><span class="sd">    Backtest a particular (parameterized) strategy</span>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a><span class="sd">    on particular data.</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a><span class="sd">    Upon initialization, call method</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a><span class="sd">    `minitrade.backtest.core.backtesting.Backtest.run` to run a backtest</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a><span class="sd">    instance, or `minitrade.backtest.core.backtesting.Backtest.optimize` to</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a><span class="sd">    optimize it.</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>                 <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>                 <span class="n">strategy</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Strategy</span><span class="p">],</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>                 <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>                 <span class="n">cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>                 <span class="n">holding</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>                 <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.0</span><span class="p">,</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>                 <span class="n">margin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>                 <span class="n">trade_on_close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>                 <span class="n">hedging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>                 <span class="n">exclusive_orders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>                 <span class="n">trade_start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>                 <span class="n">lot_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>                 <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>                 <span class="n">rebalance_cash_reserve</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>                 <span class="p">):</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a><span class="sd">        Initialize a backtest. Requires data and a strategy to test.</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a><span class="sd">        `data` is a `pd.DataFrame` with 2-level columns:</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a><span class="sd">        1st level is a list of tickers, and </span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a><span class="sd">        2nd level is `Open`, `High`, `Low`, `Close`, and `Volume`.</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a><span class="sd">        If the strategy works only on one asset, the 1st level can be dropped.</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a><span class="sd">        If any columns are missing, set them to what you have available,</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a><span class="sd">        e.g.</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a><span class="sd">            df[&#39;Open&#39;] = df[&#39;High&#39;] = df[&#39;Low&#39;] = df[&#39;Close&#39;]</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a><span class="sd">            df[&#39;Volumn&#39;] = 0</span>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a><span class="sd">        The passed data frame can contain additional columns that</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a><span class="sd">        can be used by the strategy (e.g. sentiment info).</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a><span class="sd">        DataFrame index can be either a datetime index (timestamps)</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a><span class="sd">        or a monotonic range index (i.e. a sequence of periods).</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a><span class="sd">        `strategy` is a `minitrade.backtest.core.backtesting.Strategy`</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a><span class="sd">        _subclass_ (not an instance).</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a><span class="sd">        `cash` is the initial cash to start with.</span>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a><span class="sd">        `holding` is a mapping of preexisting assets and their sizes before </span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a><span class="sd">        backtest begins, e.g. </span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a><span class="sd">            {&#39;AAPL&#39;: 10, &#39;MSFT&#39;: 5}</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a><span class="sd">        `commission` is the commission ratio. E.g. if your broker&#39;s commission</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a><span class="sd">        is 1% of trade value, set commission to `0.01`. Note, if you wish to</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a><span class="sd">        account for bid-ask spread, you can approximate doing so by increasing</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a><span class="sd">        the commission, e.g. set it to `0.0002` for commission-less forex</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a><span class="sd">        trading where the average spread is roughly 0.2‰ of asking price.</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a><span class="sd">        `margin` is the required margin (ratio) of a leveraged account.</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a><span class="sd">        No difference is made between initial and maintenance margins.</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a><span class="sd">        To run the backtest using e.g. 50:1 leverge that your broker allows,</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a><span class="sd">        set margin to `0.02` (1 / leverage).</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a><span class="sd">        If `trade_on_close` is `True`, market orders will be filled</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="sd">        with respect to the current bar&#39;s closing price instead of the</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a><span class="sd">        next bar&#39;s open.</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a><span class="sd">        If `hedging` is `True`, allow trades in both directions simultaneously.</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a><span class="sd">        If `False`, the opposite-facing orders first close existing trades in</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a><span class="sd">        a [FIFO] manner.</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a><span class="sd">        If `exclusive_orders` is `True`, each new order auto-closes the previous</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a><span class="sd">        trade/position, making at most a single trade (long or short) in effect</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a><span class="sd">        at each time.</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a><span class="sd">        If `trade_start_date` is not None, orders generated before the date are</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a><span class="sd">        surpressed and ignored in backtesting.</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a><span class="sd">        `lot_size` is the minimum increment of shares you buy in one order. Order </span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a><span class="sd">        size will be rounded to integer multiples during account rebalancing.</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a><span class="sd">        `fail_fast`, when True, instructs the backtester to bail out when</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a><span class="sd">        cash is not enough to cover an order. This can be used in live trading</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a><span class="sd">        to detect issues early. If False, backtesting will ignore the order and </span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a><span class="sd">        continue, which can be convenient during algorithm research.</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a><span class="sd">        [FIFO]: https://www.investopedia.com/terms/n/nfa-compliance-rule-2-43b.asp</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">Strategy</span><span class="p">)):</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`strategy` must be a Strategy sub-type&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`data` must be a pandas.DataFrame with columns&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">commission</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`commission` must be a float value, percent of &#39;</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>                            <span class="s1">&#39;entry order price&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>        <span class="c1"># Convert single asset data into 2-level column index</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>            <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Asset&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>        <span class="c1"># Convert index to datetime index</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="ow">and</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">)</span> <span class="ow">and</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>            <span class="c1"># Numeric index with most large numbers</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>            <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">()</span> <span class="ow">and</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>             <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;1975&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">.8</span><span class="p">)):</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>                <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>                <span class="k">pass</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">])):</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`data` must be a pandas.DataFrame containing columns &quot;</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>                             <span class="s2">&quot;&#39;Open&#39;, &#39;High&#39;, &#39;Low&#39;, &#39;Close&#39;, and &#39;Volume&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Some OHLC values are missing (NaN). &#39;</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>                             <span class="s1">&#39;Please strip those lines with `df.dropna()` or &#39;</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>                             <span class="s1">&#39;fill them in with `df.interpolate()` or whatever.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cash</span><span class="p">):</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Some prices are larger than initial cash value. Note that fractional &#39;</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>                          <span class="s1">&#39;trading is not supported. If you want to trade Bitcoin, &#39;</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>                          <span class="s1">&#39;increase initial cash, or trade μBTC or satoshis instead (GH-134).&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>                          <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">:</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Data index is not sorted in ascending order. Sorting.&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>                          <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Data index is not datetime. Assuming simple periods, &#39;</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>                          <span class="s1">&#39;but `pd.DateTimeIndex` is advised.&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>                          <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>        <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;dt&#39;</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>            <span class="n">_Broker</span><span class="p">,</span> <span class="n">cash</span><span class="o">=</span><span class="n">cash</span><span class="p">,</span> <span class="n">holding</span><span class="o">=</span><span class="n">holding</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="n">commission</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>            <span class="n">trade_on_close</span><span class="o">=</span><span class="n">trade_on_close</span><span class="p">,</span> <span class="n">hedging</span><span class="o">=</span><span class="n">hedging</span><span class="p">,</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>            <span class="n">exclusive_orders</span><span class="o">=</span><span class="n">exclusive_orders</span><span class="p">,</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>            <span class="n">trade_start_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">trade_start_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">trade_start_date</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>            <span class="n">lot_size</span><span class="o">=</span><span class="n">lot_size</span><span class="p">,</span> <span class="n">fail_fast</span><span class="o">=</span><span class="n">fail_fast</span><span class="p">,</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>            <span class="n">rebalance_cash_reserve</span><span class="o">=</span><span class="n">rebalance_cash_reserve</span><span class="p">,</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>        <span class="p">)</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a><span class="sd">        Run the backtest. Returns `pd.Series` with results and statistics.</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a><span class="sd">        Keyword arguments are interpreted as strategy parameters.</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a><span class="sd">            &gt;&gt;&gt; Backtest(GOOG, SmaCross).run()</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a><span class="sd">            Start                     2004-08-19 00:00:00</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a><span class="sd">            End                       2013-03-01 00:00:00</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a><span class="sd">            Duration                   3116 days 00:00:00</span>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a><span class="sd">            Exposure Time [%]                     93.9944</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a><span class="sd">            Equity Final [$]                      51959.9</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a><span class="sd">            Equity Peak [$]                       75787.4</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a><span class="sd">            Return [%]                            419.599</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a><span class="sd">            Buy &amp; Hold Return [%]                 703.458</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a><span class="sd">            Return (Ann.) [%]                      21.328</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a><span class="sd">            Volatility (Ann.) [%]                 36.5383</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a><span class="sd">            Sharpe Ratio                         0.583718</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a><span class="sd">            Sortino Ratio                         1.09239</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a><span class="sd">            Calmar Ratio                         0.444518</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a><span class="sd">            Max. Drawdown [%]                    -47.9801</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a><span class="sd">            Avg. Drawdown [%]                    -5.92585</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a><span class="sd">            Max. Drawdown Duration      584 days 00:00:00</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a><span class="sd">            Avg. Drawdown Duration       41 days 00:00:00</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a><span class="sd">            # Trades                                   65</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a><span class="sd">            Win Rate [%]                          46.1538</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a><span class="sd">            Best Trade [%]                         53.596</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a><span class="sd">            Worst Trade [%]                      -18.3989</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a><span class="sd">            Avg. Trade [%]                        2.35371</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a><span class="sd">            Max. Trade Duration         183 days 00:00:00</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a><span class="sd">            Avg. Trade Duration          46 days 00:00:00</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a><span class="sd">            Profit Factor                         2.08802</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a><span class="sd">            Expectancy [%]                        8.79171</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a><span class="sd">            SQN                                  0.916893</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a><span class="sd">            Kelly Criterion                        0.6134</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a><span class="sd">            _strategy                            SmaCross</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a><span class="sd">            _equity_curve                           Eq...</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a><span class="sd">            _trades                       Size  EntryB...</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a><span class="sd">            _orders                              Ticke...</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a><span class="sd">            _positions                           {&#39;GOO...</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a><span class="sd">            dtype: object</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a><span class="sd">        .. warning::</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a><span class="sd">            You may obtain different results for different strategy parameters.</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a><span class="sd">            E.g. if you use 50- and 200-bar SMA, the trading simulation will</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a><span class="sd">            begin on bar 201. The actual length of delay is equal to the lookback</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a><span class="sd">            period of the `Strategy.I` indicator which lags the most.</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a><span class="sd">            Obviously, this can affect results.</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">_Data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>        <span class="n">broker</span><span class="p">:</span> <span class="n">_Broker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>        <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="p">(</span><span class="n">broker</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>        <span class="n">processed_orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>        <span class="n">final_positions</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>            <span class="n">strategy</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Strategy initialization throws exception&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>            <span class="k">return</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>        <span class="c1"># Indicators used in Strategy.next()</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>        <span class="n">indicator_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">indicator</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a>                           <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">indicator</span> <span class="ow">is</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="n">_indicators</span><span class="p">])}</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a>        <span class="c1"># Skip first few candles where indicators are still &quot;warming up&quot;</span>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a>        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">indicator</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a>                     <span class="k">else</span> <span class="n">indicator</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a>        <span class="c1"># Preprocess indicators to numpy array for better performance</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a>        <span class="k">def</span> <span class="nf">deframe</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">df</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>        <span class="n">indicator_attrs_np</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">deframe</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a>        <span class="c1"># Disable &quot;invalid value encountered in ...&quot; warnings. Comparison</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a>        <span class="c1"># np.nan &gt;= 3 is not invalid; it&#39;s False.</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)):</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>                <span class="c1"># Prepare data and indicators for `next` call</span>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>                <span class="n">data</span><span class="o">.</span><span class="n">_set_length</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs_np</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>                            <span class="n">_Indicator</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">indicator</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">indicator_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>                <span class="c1"># Handle orders processing and broker stuff</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>                    <span class="n">broker</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<a id="__codelineno-0-1569" name="__codelineno-0-1569"></a>                <span class="k">except</span> <span class="n">_OutOfMoneyError</span><span class="p">:</span>
<a id="__codelineno-0-1570" name="__codelineno-0-1570"></a>                    <span class="k">break</span>
<a id="__codelineno-0-1571" name="__codelineno-0-1571"></a>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a>                <span class="c1"># Next tick, a moment before bar close</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a>                <span class="n">strategy</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a>                <span class="c1"># take note of the orders generated</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a>                <span class="n">processed_orders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a>                <span class="c1"># take note of the final positions</span>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>                <span class="n">final_positions</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a>                    <span class="n">t</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">broker</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="o">|</span> <span class="p">{</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>                    <span class="s1">&#39;Margin&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">margin_available</span><span class="p">)}</span>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a>                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">):</span>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a>                    <span class="n">broker</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a>            <span class="c1"># Set data back to full length</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>            <span class="c1"># for future `indicator._opts[&#39;data&#39;].index` calls to work</span>
<a id="__codelineno-0-1589" name="__codelineno-0-1589"></a>            <span class="n">data</span><span class="o">.</span><span class="n">_set_length</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">))</span>
<a id="__codelineno-0-1590" name="__codelineno-0-1590"></a>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a>            <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">_equity</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a>                                  <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Equity&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span> <span class="s1">&#39;Margin&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">_cash</span><span class="p">)</span>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a>            <span class="c1"># equal weighed average, as if buy and hold an equal weighed portfolio</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>            <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a>            <span class="n">weighted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a>                <span class="n">weighted_data</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_data</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a>            <span class="n">weighted_data</span> <span class="o">=</span> <span class="n">weighted_data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ohlc_ref_data</span> <span class="o">=</span> <span class="n">weighted_data</span>
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">(</span>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a>                <span class="n">orders</span><span class="o">=</span><span class="n">processed_orders</span><span class="p">,</span>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a>                <span class="n">trades</span><span class="o">=</span><span class="n">broker</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">,</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a>                <span class="n">equity</span><span class="o">=</span><span class="n">equity</span><span class="p">,</span>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>                <span class="n">ohlc_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ohlc_ref_data</span><span class="p">,</span>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a>                <span class="n">risk_free_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a>                <span class="n">strategy_instance</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>                <span class="n">positions</span><span class="o">=</span><span class="n">final_positions</span><span class="p">,</span>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a>            <span class="p">)</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1613" name="__codelineno-0-1613"></a>
<a id="__codelineno-0-1614" name="__codelineno-0-1614"></a>    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a>                 <span class="n">maximize</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;SQN&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a>                 <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a>                 <span class="n">max_tries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a>                 <span class="n">constraint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a>                 <span class="n">return_heatmap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>                 <span class="n">return_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a>                 <span class="n">random_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1622" name="__codelineno-0-1622"></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
<a id="__codelineno-0-1623" name="__codelineno-0-1623"></a>                                    <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
<a id="__codelineno-0-1624" name="__codelineno-0-1624"></a>                                    <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
<a id="__codelineno-0-1625" name="__codelineno-0-1625"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1626" name="__codelineno-0-1626"></a><span class="sd">        Optimize strategy parameters to an optimal combination.</span>
<a id="__codelineno-0-1627" name="__codelineno-0-1627"></a><span class="sd">        Returns result `pd.Series` of the best run.</span>
<a id="__codelineno-0-1628" name="__codelineno-0-1628"></a>
<a id="__codelineno-0-1629" name="__codelineno-0-1629"></a><span class="sd">        `maximize` is a string key from the</span>
<a id="__codelineno-0-1630" name="__codelineno-0-1630"></a><span class="sd">        `minitrade.backtest.core.backtesting.Backtest.run`-returned results series,</span>
<a id="__codelineno-0-1631" name="__codelineno-0-1631"></a><span class="sd">        or a function that accepts this series object and returns a number;</span>
<a id="__codelineno-0-1632" name="__codelineno-0-1632"></a><span class="sd">        the higher the better. By default, the method maximizes</span>
<a id="__codelineno-0-1633" name="__codelineno-0-1633"></a><span class="sd">        Van Tharp&#39;s [System Quality Number](https://google.com/search?q=System+Quality+Number).</span>
<a id="__codelineno-0-1634" name="__codelineno-0-1634"></a>
<a id="__codelineno-0-1635" name="__codelineno-0-1635"></a><span class="sd">        `method` is the optimization method. Currently two methods are supported:</span>
<a id="__codelineno-0-1636" name="__codelineno-0-1636"></a>
<a id="__codelineno-0-1637" name="__codelineno-0-1637"></a><span class="sd">        * `&quot;grid&quot;` which does an exhaustive (or randomized) search over the</span>
<a id="__codelineno-0-1638" name="__codelineno-0-1638"></a><span class="sd">          cartesian product of parameter combinations, and</span>
<a id="__codelineno-0-1639" name="__codelineno-0-1639"></a><span class="sd">        * `&quot;skopt&quot;` which finds close-to-optimal strategy parameters using</span>
<a id="__codelineno-0-1640" name="__codelineno-0-1640"></a><span class="sd">          [model-based optimization], making at most `max_tries` evaluations.</span>
<a id="__codelineno-0-1641" name="__codelineno-0-1641"></a>
<a id="__codelineno-0-1642" name="__codelineno-0-1642"></a><span class="sd">        [model-based optimization]: \</span>
<a id="__codelineno-0-1643" name="__codelineno-0-1643"></a><span class="sd">            https://scikit-optimize.github.io/stable/auto_examples/bayesian-optimization.html</span>
<a id="__codelineno-0-1644" name="__codelineno-0-1644"></a>
<a id="__codelineno-0-1645" name="__codelineno-0-1645"></a><span class="sd">        `max_tries` is the maximal number of strategy runs to perform.</span>
<a id="__codelineno-0-1646" name="__codelineno-0-1646"></a><span class="sd">        If `method=&quot;grid&quot;`, this results in randomized grid search.</span>
<a id="__codelineno-0-1647" name="__codelineno-0-1647"></a><span class="sd">        If `max_tries` is a floating value between (0, 1], this sets the</span>
<a id="__codelineno-0-1648" name="__codelineno-0-1648"></a><span class="sd">        number of runs to approximately that fraction of full grid space.</span>
<a id="__codelineno-0-1649" name="__codelineno-0-1649"></a><span class="sd">        Alternatively, if integer, it denotes the absolute maximum number</span>
<a id="__codelineno-0-1650" name="__codelineno-0-1650"></a><span class="sd">        of evaluations. If unspecified (default), grid search is exhaustive,</span>
<a id="__codelineno-0-1651" name="__codelineno-0-1651"></a><span class="sd">        whereas for `method=&quot;skopt&quot;`, `max_tries` is set to 200.</span>
<a id="__codelineno-0-1652" name="__codelineno-0-1652"></a>
<a id="__codelineno-0-1653" name="__codelineno-0-1653"></a><span class="sd">        `constraint` is a function that accepts a dict-like object of</span>
<a id="__codelineno-0-1654" name="__codelineno-0-1654"></a><span class="sd">        parameters (with values) and returns `True` when the combination</span>
<a id="__codelineno-0-1655" name="__codelineno-0-1655"></a><span class="sd">        is admissible to test with. By default, any parameters combination</span>
<a id="__codelineno-0-1656" name="__codelineno-0-1656"></a><span class="sd">        is considered admissible.</span>
<a id="__codelineno-0-1657" name="__codelineno-0-1657"></a>
<a id="__codelineno-0-1658" name="__codelineno-0-1658"></a><span class="sd">        If `return_heatmap` is `True`, besides returning the result</span>
<a id="__codelineno-0-1659" name="__codelineno-0-1659"></a><span class="sd">        series, an additional `pd.Series` is returned with a multiindex</span>
<a id="__codelineno-0-1660" name="__codelineno-0-1660"></a><span class="sd">        of all admissible parameter combinations, which can be further</span>
<a id="__codelineno-0-1661" name="__codelineno-0-1661"></a><span class="sd">        inspected or projected onto 2D to plot a heatmap</span>
<a id="__codelineno-0-1662" name="__codelineno-0-1662"></a><span class="sd">        (see `backtesting.lib.plot_heatmaps()`).</span>
<a id="__codelineno-0-1663" name="__codelineno-0-1663"></a>
<a id="__codelineno-0-1664" name="__codelineno-0-1664"></a><span class="sd">        If `return_optimization` is True and `method = &#39;skopt&#39;`,</span>
<a id="__codelineno-0-1665" name="__codelineno-0-1665"></a><span class="sd">        in addition to result series (and maybe heatmap), return raw</span>
<a id="__codelineno-0-1666" name="__codelineno-0-1666"></a><span class="sd">        [`scipy.optimize.OptimizeResult`][OptimizeResult] for further</span>
<a id="__codelineno-0-1667" name="__codelineno-0-1667"></a><span class="sd">        inspection, e.g. with [scikit-optimize]\</span>
<a id="__codelineno-0-1668" name="__codelineno-0-1668"></a><span class="sd">        [plotting tools].</span>
<a id="__codelineno-0-1669" name="__codelineno-0-1669"></a>
<a id="__codelineno-0-1670" name="__codelineno-0-1670"></a><span class="sd">        [OptimizeResult]: \</span>
<a id="__codelineno-0-1671" name="__codelineno-0-1671"></a><span class="sd">            https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html</span>
<a id="__codelineno-0-1672" name="__codelineno-0-1672"></a><span class="sd">        [scikit-optimize]: https://scikit-optimize.github.io</span>
<a id="__codelineno-0-1673" name="__codelineno-0-1673"></a><span class="sd">        [plotting tools]: https://scikit-optimize.github.io/stable/modules/plots.html</span>
<a id="__codelineno-0-1674" name="__codelineno-0-1674"></a>
<a id="__codelineno-0-1675" name="__codelineno-0-1675"></a><span class="sd">        If you want reproducible optimization results, set `random_state`</span>
<a id="__codelineno-0-1676" name="__codelineno-0-1676"></a><span class="sd">        to a fixed integer random seed.</span>
<a id="__codelineno-0-1677" name="__codelineno-0-1677"></a>
<a id="__codelineno-0-1678" name="__codelineno-0-1678"></a><span class="sd">        Additional keyword arguments represent strategy arguments with</span>
<a id="__codelineno-0-1679" name="__codelineno-0-1679"></a><span class="sd">        list-like collections of possible values. For example, the following</span>
<a id="__codelineno-0-1680" name="__codelineno-0-1680"></a><span class="sd">        code finds and returns the &quot;best&quot; of the 7 admissible (of the</span>
<a id="__codelineno-0-1681" name="__codelineno-0-1681"></a><span class="sd">        9 possible) parameter combinations:</span>
<a id="__codelineno-0-1682" name="__codelineno-0-1682"></a>
<a id="__codelineno-0-1683" name="__codelineno-0-1683"></a><span class="sd">            backtest.optimize(sma1=[5, 10, 15], sma2=[10, 20, 40],</span>
<a id="__codelineno-0-1684" name="__codelineno-0-1684"></a><span class="sd">                              constraint=lambda p: p.sma1 &lt; p.sma2)</span>
<a id="__codelineno-0-1685" name="__codelineno-0-1685"></a>
<a id="__codelineno-0-1686" name="__codelineno-0-1686"></a><span class="sd">        .. TODO::</span>
<a id="__codelineno-0-1687" name="__codelineno-0-1687"></a><span class="sd">            Improve multiprocessing/parallel execution on Windos with start method &#39;spawn&#39;.</span>
<a id="__codelineno-0-1688" name="__codelineno-0-1688"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-1689" name="__codelineno-0-1689"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
<a id="__codelineno-0-1690" name="__codelineno-0-1690"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need some strategy parameters to optimize&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1691" name="__codelineno-0-1691"></a>
<a id="__codelineno-0-1692" name="__codelineno-0-1692"></a>        <span class="n">maximize_key</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1693" name="__codelineno-0-1693"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maximize</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1694" name="__codelineno-0-1694"></a>            <span class="n">maximize_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">maximize</span><span class="p">)</span>
<a id="__codelineno-0-1695" name="__codelineno-0-1695"></a>            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-0-1696" name="__codelineno-0-1696"></a>            <span class="k">if</span> <span class="n">maximize</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
<a id="__codelineno-0-1697" name="__codelineno-0-1697"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`maximize`, if str, must match a key in pd.Series &#39;</span>
<a id="__codelineno-0-1698" name="__codelineno-0-1698"></a>                                 <span class="s1">&#39;result of backtest.run()&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1699" name="__codelineno-0-1699"></a>
<a id="__codelineno-0-1700" name="__codelineno-0-1700"></a>            <span class="k">def</span> <span class="nf">maximize</span><span class="p">(</span><span class="n">stats</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_key</span><span class="o">=</span><span class="n">maximize</span><span class="p">):</span>
<a id="__codelineno-0-1701" name="__codelineno-0-1701"></a>                <span class="k">return</span> <span class="n">stats</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
<a id="__codelineno-0-1702" name="__codelineno-0-1702"></a>
<a id="__codelineno-0-1703" name="__codelineno-0-1703"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">maximize</span><span class="p">):</span>
<a id="__codelineno-0-1704" name="__codelineno-0-1704"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`maximize` must be str (a field of backtest.run() result &#39;</span>
<a id="__codelineno-0-1705" name="__codelineno-0-1705"></a>                            <span class="s1">&#39;Series) or a function that accepts result Series &#39;</span>
<a id="__codelineno-0-1706" name="__codelineno-0-1706"></a>                            <span class="s1">&#39;and returns a number; the higher the better&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1707" name="__codelineno-0-1707"></a>        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">maximize</span><span class="p">),</span> <span class="n">maximize</span>
<a id="__codelineno-0-1708" name="__codelineno-0-1708"></a>
<a id="__codelineno-0-1709" name="__codelineno-0-1709"></a>        <span class="n">have_constraint</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
<a id="__codelineno-0-1710" name="__codelineno-0-1710"></a>        <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1711" name="__codelineno-0-1711"></a>
<a id="__codelineno-0-1712" name="__codelineno-0-1712"></a>            <span class="k">def</span> <span class="nf">constraint</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
<a id="__codelineno-0-1713" name="__codelineno-0-1713"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-1714" name="__codelineno-0-1714"></a>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">constraint</span><span class="p">):</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`constraint` must be a function that accepts a dict &quot;</span>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a>                            <span class="s2">&quot;of strategy parameters and returns a bool whether &quot;</span>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a>                            <span class="s2">&quot;the combination of parameters is admissible or not&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a>        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">constraint</span><span class="p">),</span> <span class="n">constraint</span>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a>        <span class="k">if</span> <span class="n">return_optimization</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;skopt&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_optimization=True only valid if method=&#39;skopt&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a>        <span class="k">def</span> <span class="nf">_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a>            <span class="k">return</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization variable &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; is passed no &quot;</span>
<a id="__codelineno-0-1730" name="__codelineno-0-1730"></a>                                 <span class="sa">f</span><span class="s2">&quot;optimization values: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1731" name="__codelineno-0-1731"></a>
<a id="__codelineno-0-1732" name="__codelineno-0-1732"></a>        <span class="k">class</span> <span class="nc">AttrDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-1733" name="__codelineno-0-1733"></a>            <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-1734" name="__codelineno-0-1734"></a>                <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
<a id="__codelineno-0-1735" name="__codelineno-0-1735"></a>
<a id="__codelineno-0-1736" name="__codelineno-0-1736"></a>        <span class="k">def</span> <span class="nf">_grid_size</span><span class="p">():</span>
<a id="__codelineno-0-1737" name="__codelineno-0-1737"></a>            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
<a id="__codelineno-0-1738" name="__codelineno-0-1738"></a>            <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10_000</span> <span class="ow">and</span> <span class="n">have_constraint</span><span class="p">:</span>
<a id="__codelineno-0-1739" name="__codelineno-0-1739"></a>                <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<a id="__codelineno-0-1740" name="__codelineno-0-1740"></a>                                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<a id="__codelineno-0-1741" name="__codelineno-0-1741"></a>                           <span class="k">if</span> <span class="n">constraint</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
<a id="__codelineno-0-1742" name="__codelineno-0-1742"></a>            <span class="k">return</span> <span class="n">size</span>
<a id="__codelineno-0-1743" name="__codelineno-0-1743"></a>
<a id="__codelineno-0-1744" name="__codelineno-0-1744"></a>        <span class="k">def</span> <span class="nf">_optimize_grid</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]]:</span>
<a id="__codelineno-0-1745" name="__codelineno-0-1745"></a>            <span class="n">rand</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span><span class="o">.</span><span class="n">random</span>
<a id="__codelineno-0-1746" name="__codelineno-0-1746"></a>            <span class="n">grid_frac</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">max_tries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
<a id="__codelineno-0-1747" name="__codelineno-0-1747"></a>                         <span class="n">max_tries</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_tries</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span>
<a id="__codelineno-0-1748" name="__codelineno-0-1748"></a>                         <span class="n">max_tries</span> <span class="o">/</span> <span class="n">_grid_size</span><span class="p">())</span>
<a id="__codelineno-0-1749" name="__codelineno-0-1749"></a>            <span class="n">param_combos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># back to dict so it pickles</span>
<a id="__codelineno-0-1750" name="__codelineno-0-1750"></a>                            <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-0-1751" name="__codelineno-0-1751"></a>                                           <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<a id="__codelineno-0-1752" name="__codelineno-0-1752"></a>                                                                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
<a id="__codelineno-0-1753" name="__codelineno-0-1753"></a>                            <span class="k">if</span> <span class="n">constraint</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-1754" name="__codelineno-0-1754"></a>                            <span class="ow">and</span> <span class="n">rand</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">grid_frac</span><span class="p">]</span>
<a id="__codelineno-0-1755" name="__codelineno-0-1755"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">param_combos</span><span class="p">:</span>
<a id="__codelineno-0-1756" name="__codelineno-0-1756"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No admissible parameter combinations to test&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1757" name="__codelineno-0-1757"></a>
<a id="__codelineno-0-1758" name="__codelineno-0-1758"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
<a id="__codelineno-0-1759" name="__codelineno-0-1759"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Searching for best of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span><span class="si">}</span><span class="s1"> configurations.&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1760" name="__codelineno-0-1760"></a>                              <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1761" name="__codelineno-0-1761"></a>
<a id="__codelineno-0-1762" name="__codelineno-0-1762"></a>            <span class="n">heatmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
<a id="__codelineno-0-1763" name="__codelineno-0-1763"></a>                                <span class="n">name</span><span class="o">=</span><span class="n">maximize_key</span><span class="p">,</span>
<a id="__codelineno-0-1764" name="__codelineno-0-1764"></a>                                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
<a id="__codelineno-0-1765" name="__codelineno-0-1765"></a>                                    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_combos</span><span class="p">],</span>
<a id="__codelineno-0-1766" name="__codelineno-0-1766"></a>                                    <span class="n">names</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">param_combos</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-1767" name="__codelineno-0-1767"></a>
<a id="__codelineno-0-1768" name="__codelineno-0-1768"></a>            <span class="k">def</span> <span class="nf">_batch</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
<a id="__codelineno-0-1769" name="__codelineno-0-1769"></a>                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<a id="__codelineno-0-1770" name="__codelineno-0-1770"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-0-1771" name="__codelineno-0-1771"></a>                    <span class="k">yield</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>
<a id="__codelineno-0-1772" name="__codelineno-0-1772"></a>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>            <span class="c1"># Save necessary objects into &quot;global&quot; state; pass into concurrent executor</span>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>            <span class="c1"># (and thus pickle) nothing but two numbers; receive nothing but numbers.</span>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>            <span class="c1"># With start method &quot;fork&quot;, children processes will inherit parent address space</span>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>            <span class="c1"># in a copy-on-write manner, achieving better performance/RAM benefit.</span>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>            <span class="n">backtest_uuid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>            <span class="n">param_batches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_batch</span><span class="p">(</span><span class="n">param_combos</span><span class="p">))</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a>            <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">,</span> <span class="n">maximize</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a>                <span class="c1"># If multiprocessing start method is &#39;fork&#39; (i.e. on POSIX), use</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>                <span class="c1"># a pool of processes to compute results in parallel.</span>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a>                <span class="c1"># Otherwise (i.e. on Windos), sequential computation will be &quot;faster&quot;.</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a>                <span class="k">if</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_start_method</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;fork&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a>                    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a>                        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_task</span><span class="p">,</span> <span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a>                                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_batches</span><span class="p">))]</span>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a>                        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="p">(</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a>                                            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Backtest.optimize&#39;</span><span class="p">):</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a>                            <span class="n">batch_index</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a>                            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]):</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a>                                <span class="n">heatmap</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a>                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a>                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;For multiprocessing support in `Backtest.optimize()` &quot;</span>
<a id="__codelineno-0-1796" name="__codelineno-0-1796"></a>                                      <span class="s2">&quot;set multiprocessing start method to &#39;fork&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1797" name="__codelineno-0-1797"></a>                    <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_batches</span><span class="p">))):</span>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a>                        <span class="n">_</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_task</span><span class="p">(</span><span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">)</span>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a>                        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]):</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a>                            <span class="n">heatmap</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a>            <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-1802" name="__codelineno-0-1802"></a>                <span class="k">del</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span>
<a id="__codelineno-0-1803" name="__codelineno-0-1803"></a>
<a id="__codelineno-0-1804" name="__codelineno-0-1804"></a>            <span class="n">best_params</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<a id="__codelineno-0-1805" name="__codelineno-0-1805"></a>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a>            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">best_params</span><span class="p">):</span>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a>                <span class="c1"># No trade was made in any of the runs. Just make a random</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a>                <span class="c1"># run so we get some, if empty, results</span>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a>                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">param_combos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a>                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">heatmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)))</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a>            <span class="k">if</span> <span class="n">return_heatmap</span><span class="p">:</span>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a>                <span class="k">return</span> <span class="n">stats</span><span class="p">,</span> <span class="n">heatmap</span>
<a id="__codelineno-0-1815" name="__codelineno-0-1815"></a>            <span class="k">return</span> <span class="n">stats</span>
<a id="__codelineno-0-1816" name="__codelineno-0-1816"></a>
<a id="__codelineno-0-1817" name="__codelineno-0-1817"></a>        <span class="k">def</span> <span class="nf">_optimize_skopt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a>                                       <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a>                                       <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a>                <span class="kn">from</span> <span class="nn">skopt</span> <span class="kn">import</span> <span class="n">forest_minimize</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a>                <span class="kn">from</span> <span class="nn">skopt.callbacks</span> <span class="kn">import</span> <span class="n">DeltaXStopper</span>
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a>                <span class="kn">from</span> <span class="nn">skopt.learning</span> <span class="kn">import</span> <span class="n">ExtraTreesRegressor</span>
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a>                <span class="kn">from</span> <span class="nn">skopt.space</span> <span class="kn">import</span> <span class="n">Categorical</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Real</span>
<a id="__codelineno-0-1825" name="__codelineno-0-1825"></a>                <span class="kn">from</span> <span class="nn">skopt.utils</span> <span class="kn">import</span> <span class="n">use_named_args</span>
<a id="__codelineno-0-1826" name="__codelineno-0-1826"></a>            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<a id="__codelineno-0-1827" name="__codelineno-0-1827"></a>                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Need package &#39;scikit-optimize&#39; for method=&#39;skopt&#39;. &quot;</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a>                                  <span class="s2">&quot;pip install scikit-optimize&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a>            <span class="k">nonlocal</span> <span class="n">max_tries</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a>            <span class="n">max_tries</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span> <span class="k">if</span> <span class="n">max_tries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a>                         <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_tries</span> <span class="o">*</span> <span class="n">_grid_size</span><span class="p">()))</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_tries</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a>                         <span class="n">max_tries</span><span class="p">)</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a>            <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a>                <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a>                <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;mM&#39;</span><span class="p">:</span>  <span class="c1"># timedelta, datetime64</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a>                    <span class="c1"># these dtypes are unsupported in skopt, so convert to raw int</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a>                    <span class="c1"># TODO: save dtype and convert back later</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a>                    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a>                <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;iumM&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a>                    <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a>                <span class="k">elif</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a>                    <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Real</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a>                    <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Categorical</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;onehot&#39;</span><span class="p">))</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a>            <span class="c1"># Avoid recomputing re-evaluations:</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a>            <span class="c1"># &quot;The objective has been evaluated at this point before.&quot;</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a>            <span class="c1"># https://github.com/scikit-optimize/scikit-optimize/issues/302</span>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a>            <span class="n">memoized_run</span> <span class="o">=</span> <span class="n">lru_cache</span><span class="p">()(</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">tup</span><span class="p">)))</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a>            <span class="c1"># np.inf/np.nan breaks sklearn, np.finfo(float).max breaks skopt.plots.plot_objective</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a>            <span class="n">INVALID</span> <span class="o">=</span> <span class="mf">1e300</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a>            <span class="n">progress</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_tqdm</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Backtest.optimize&#39;</span><span class="p">))</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a>            <span class="o">@</span> <span class="n">use_named_args</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">)</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a>            <span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">):</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a>                <span class="nb">next</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a>                <span class="c1"># Check constraints</span>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a>                <span class="c1"># TODO: Adjust after https://github.com/scikit-optimize/scikit-optimize/pull/971</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">constraint</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a>                    <span class="k">return</span> <span class="n">INVALID</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">memoized_run</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a>                <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">maximize</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a>                    <span class="k">return</span> <span class="n">INVALID</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a>                <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>                    <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;The objective has been evaluated at this point before.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">forest_minimize</span><span class="p">(</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>                    <span class="n">func</span><span class="o">=</span><span class="n">objective_function</span><span class="p">,</span>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a>                    <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a>                    <span class="n">n_calls</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>                    <span class="n">base_estimator</span><span class="o">=</span><span class="n">ExtraTreesRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a>                    <span class="n">acq_func</span><span class="o">=</span><span class="s1">&#39;LCB&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>                    <span class="n">kappa</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>                    <span class="n">n_initial_points</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">max_tries</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)),</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>                    <span class="n">initial_point_generator</span><span class="o">=</span><span class="s1">&#39;lhs&#39;</span><span class="p">,</span>  <span class="c1"># &#39;sobel&#39; requires n_initial_points ~ 2**N</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>                    <span class="n">callback</span><span class="o">=</span><span class="n">DeltaXStopper</span><span class="p">(</span><span class="mf">9e-7</span><span class="p">),</span>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>                    <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>            <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="p">]</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>            <span class="k">if</span> <span class="n">return_heatmap</span><span class="p">:</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>                <span class="n">heatmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x_iters</span><span class="p">),</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">func_vals</span><span class="p">)),</span>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>                                    <span class="n">name</span><span class="o">=</span><span class="n">maximize_key</span><span class="p">)</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>                <span class="n">heatmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>                <span class="n">heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">[</span><span class="n">heatmap</span> <span class="o">!=</span> <span class="o">-</span><span class="n">INVALID</span><span class="p">]</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>                <span class="n">heatmap</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>
<a id="__codelineno-0-1899" name="__codelineno-0-1899"></a>            <span class="k">if</span> <span class="n">return_optimization</span><span class="p">:</span>
<a id="__codelineno-0-1900" name="__codelineno-0-1900"></a>                <span class="n">valid</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span> <span class="o">!=</span> <span class="n">INVALID</span>
<a id="__codelineno-0-1901" name="__codelineno-0-1901"></a>                <span class="n">res</span><span class="o">.</span><span class="n">x_iters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x_iters</span><span class="p">,</span> <span class="n">valid</span><span class="p">))</span>
<a id="__codelineno-0-1902" name="__codelineno-0-1902"></a>                <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
<a id="__codelineno-0-1903" name="__codelineno-0-1903"></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-1904" name="__codelineno-0-1904"></a>
<a id="__codelineno-0-1905" name="__codelineno-0-1905"></a>            <span class="k">return</span> <span class="n">stats</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-0-1906" name="__codelineno-0-1906"></a>
<a id="__codelineno-0-1907" name="__codelineno-0-1907"></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1908" name="__codelineno-0-1908"></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">_optimize_grid</span><span class="p">()</span>
<a id="__codelineno-0-1909" name="__codelineno-0-1909"></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;skopt&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1910" name="__codelineno-0-1910"></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">_optimize_skopt</span><span class="p">()</span>
<a id="__codelineno-0-1911" name="__codelineno-0-1911"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1912" name="__codelineno-0-1912"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method should be &#39;grid&#39; or &#39;skopt&#39;, not </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1913" name="__codelineno-0-1913"></a>        <span class="k">return</span> <span class="n">output</span>
<a id="__codelineno-0-1914" name="__codelineno-0-1914"></a>
<a id="__codelineno-0-1915" name="__codelineno-0-1915"></a>    <span class="o">@</span> <span class="nb">staticmethod</span>
<a id="__codelineno-0-1916" name="__codelineno-0-1916"></a>    <span class="k">def</span> <span class="nf">_mp_task</span><span class="p">(</span><span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">):</span>
<a id="__codelineno-0-1917" name="__codelineno-0-1917"></a>        <span class="n">bt</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">,</span> <span class="n">maximize_func</span> <span class="o">=</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span>
<a id="__codelineno-0-1918" name="__codelineno-0-1918"></a>        <span class="k">return</span> <span class="n">batch_index</span><span class="p">,</span> <span class="p">[</span><span class="n">maximize_func</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span> <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;# Trades&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-1919" name="__codelineno-0-1919"></a>                             <span class="k">for</span> <span class="n">stats</span> <span class="ow">in</span> <span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-0-1920" name="__codelineno-0-1920"></a>                                           <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">])]</span>
<a id="__codelineno-0-1921" name="__codelineno-0-1921"></a>
<a id="__codelineno-0-1922" name="__codelineno-0-1922"></a>    <span class="n">_mp_backtests</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;Backtest&#39;</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1923" name="__codelineno-0-1923"></a>
<a id="__codelineno-0-1924" name="__codelineno-0-1924"></a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1925" name="__codelineno-0-1925"></a>             <span class="n">plot_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_return</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_pl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1926" name="__codelineno-0-1926"></a>             <span class="n">plot_volume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_drawdown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_trades</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1927" name="__codelineno-0-1927"></a>             <span class="n">smooth_equity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1928" name="__codelineno-0-1928"></a>             <span class="n">superimpose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1929" name="__codelineno-0-1929"></a>             <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse_indicators</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1930" name="__codelineno-0-1930"></a>             <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">open_browser</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1931" name="__codelineno-0-1931"></a>             <span class="n">plot_allocation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_allocation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-1932" name="__codelineno-0-1932"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1933" name="__codelineno-0-1933"></a><span class="sd">        Plot the progression of the last backtest run.</span>
<a id="__codelineno-0-1934" name="__codelineno-0-1934"></a>
<a id="__codelineno-0-1935" name="__codelineno-0-1935"></a><span class="sd">        If `results` is provided, it should be a particular result</span>
<a id="__codelineno-0-1936" name="__codelineno-0-1936"></a><span class="sd">        `pd.Series` such as returned by</span>
<a id="__codelineno-0-1937" name="__codelineno-0-1937"></a><span class="sd">        `minitrade.backtest.core.backtesting.Backtest.run` or</span>
<a id="__codelineno-0-1938" name="__codelineno-0-1938"></a><span class="sd">        `minitrade.backtest.core.backtesting.Backtest.optimize`, otherwise the last</span>
<a id="__codelineno-0-1939" name="__codelineno-0-1939"></a><span class="sd">        run&#39;s results are used.</span>
<a id="__codelineno-0-1940" name="__codelineno-0-1940"></a>
<a id="__codelineno-0-1941" name="__codelineno-0-1941"></a><span class="sd">        `filename` is the path to save the interactive HTML plot to.</span>
<a id="__codelineno-0-1942" name="__codelineno-0-1942"></a><span class="sd">        By default, a strategy/parameter-dependent file is created in the</span>
<a id="__codelineno-0-1943" name="__codelineno-0-1943"></a><span class="sd">        current working directory.</span>
<a id="__codelineno-0-1944" name="__codelineno-0-1944"></a>
<a id="__codelineno-0-1945" name="__codelineno-0-1945"></a><span class="sd">        `plot_width` is the width of the plot in pixels. If None (default),</span>
<a id="__codelineno-0-1946" name="__codelineno-0-1946"></a><span class="sd">        the plot is made to span 100% of browser width. The height is</span>
<a id="__codelineno-0-1947" name="__codelineno-0-1947"></a><span class="sd">        currently non-adjustable.</span>
<a id="__codelineno-0-1948" name="__codelineno-0-1948"></a>
<a id="__codelineno-0-1949" name="__codelineno-0-1949"></a><span class="sd">        If `plot_equity` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1950" name="__codelineno-0-1950"></a><span class="sd">        an equity (initial cash plus assets) graph section. This is the same</span>
<a id="__codelineno-0-1951" name="__codelineno-0-1951"></a><span class="sd">        as `plot_return` plus initial 100%.</span>
<a id="__codelineno-0-1952" name="__codelineno-0-1952"></a>
<a id="__codelineno-0-1953" name="__codelineno-0-1953"></a><span class="sd">        If `plot_return` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1954" name="__codelineno-0-1954"></a><span class="sd">        a cumulative return graph section. This is the same</span>
<a id="__codelineno-0-1955" name="__codelineno-0-1955"></a><span class="sd">        as `plot_equity` minus initial 100%.</span>
<a id="__codelineno-0-1956" name="__codelineno-0-1956"></a>
<a id="__codelineno-0-1957" name="__codelineno-0-1957"></a><span class="sd">        If `plot_pl` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1958" name="__codelineno-0-1958"></a><span class="sd">        a profit/loss (P/L) indicator section.</span>
<a id="__codelineno-0-1959" name="__codelineno-0-1959"></a>
<a id="__codelineno-0-1960" name="__codelineno-0-1960"></a><span class="sd">        If `plot_volume` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1961" name="__codelineno-0-1961"></a><span class="sd">        a trade volume section.</span>
<a id="__codelineno-0-1962" name="__codelineno-0-1962"></a>
<a id="__codelineno-0-1963" name="__codelineno-0-1963"></a><span class="sd">        If `plot_drawdown` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1964" name="__codelineno-0-1964"></a><span class="sd">        a separate drawdown graph section.</span>
<a id="__codelineno-0-1965" name="__codelineno-0-1965"></a>
<a id="__codelineno-0-1966" name="__codelineno-0-1966"></a><span class="sd">        If `plot_trades` is `True`, the stretches between trade entries</span>
<a id="__codelineno-0-1967" name="__codelineno-0-1967"></a><span class="sd">        and trade exits are marked by hash-marked tractor beams.</span>
<a id="__codelineno-0-1968" name="__codelineno-0-1968"></a>
<a id="__codelineno-0-1969" name="__codelineno-0-1969"></a><span class="sd">        If `smooth_equity` is `True`, the equity graph will be</span>
<a id="__codelineno-0-1970" name="__codelineno-0-1970"></a><span class="sd">        interpolated between fixed points at trade closing times,</span>
<a id="__codelineno-0-1971" name="__codelineno-0-1971"></a><span class="sd">        unaffected by any interim asset volatility.</span>
<a id="__codelineno-0-1972" name="__codelineno-0-1972"></a>
<a id="__codelineno-0-1973" name="__codelineno-0-1973"></a><span class="sd">        If `relative_equity` is `True`, scale and label equity graph axis</span>
<a id="__codelineno-0-1974" name="__codelineno-0-1974"></a><span class="sd">        with return percent, not absolute cash-equivalent values.</span>
<a id="__codelineno-0-1975" name="__codelineno-0-1975"></a>
<a id="__codelineno-0-1976" name="__codelineno-0-1976"></a><span class="sd">        If `superimpose` is `True`, superimpose larger-timeframe candlesticks</span>
<a id="__codelineno-0-1977" name="__codelineno-0-1977"></a><span class="sd">        over the original candlestick chart. Default downsampling rule is:</span>
<a id="__codelineno-0-1978" name="__codelineno-0-1978"></a><span class="sd">        monthly for daily data, daily for hourly data, hourly for minute data,</span>
<a id="__codelineno-0-1979" name="__codelineno-0-1979"></a><span class="sd">        and minute for (sub-)second data.</span>
<a id="__codelineno-0-1980" name="__codelineno-0-1980"></a><span class="sd">        `superimpose` can also be a valid [Pandas offset string],</span>
<a id="__codelineno-0-1981" name="__codelineno-0-1981"></a><span class="sd">        such as `&#39;5T&#39;` or `&#39;5min&#39;`, in which case this frequency will be</span>
<a id="__codelineno-0-1982" name="__codelineno-0-1982"></a><span class="sd">        used to superimpose.</span>
<a id="__codelineno-0-1983" name="__codelineno-0-1983"></a><span class="sd">        Note, this only works for data with a datetime index.</span>
<a id="__codelineno-0-1984" name="__codelineno-0-1984"></a>
<a id="__codelineno-0-1985" name="__codelineno-0-1985"></a><span class="sd">        If `resample` is `True`, the OHLC data is resampled in a way that</span>
<a id="__codelineno-0-1986" name="__codelineno-0-1986"></a><span class="sd">        makes the upper number of candles for Bokeh to plot limited to 10_000.</span>
<a id="__codelineno-0-1987" name="__codelineno-0-1987"></a><span class="sd">        This may, in situations of overabundant data,</span>
<a id="__codelineno-0-1988" name="__codelineno-0-1988"></a><span class="sd">        improve plot&#39;s interactive performance and avoid browser&#39;s</span>
<a id="__codelineno-0-1989" name="__codelineno-0-1989"></a><span class="sd">        `Javascript Error: Maximum call stack size exceeded` or similar.</span>
<a id="__codelineno-0-1990" name="__codelineno-0-1990"></a><span class="sd">        Equity &amp; dropdown curves and individual trades data is,</span>
<a id="__codelineno-0-1991" name="__codelineno-0-1991"></a><span class="sd">        likewise, [reasonably _aggregated_][TRADES_AGG].</span>
<a id="__codelineno-0-1992" name="__codelineno-0-1992"></a><span class="sd">        `resample` can also be a [Pandas offset string],</span>
<a id="__codelineno-0-1993" name="__codelineno-0-1993"></a><span class="sd">        such as `&#39;5T&#39;` or `&#39;5min&#39;`, in which case this frequency will be</span>
<a id="__codelineno-0-1994" name="__codelineno-0-1994"></a><span class="sd">        used to resample, overriding above numeric limitation.</span>
<a id="__codelineno-0-1995" name="__codelineno-0-1995"></a><span class="sd">        Note, all this only works for data with a datetime index.</span>
<a id="__codelineno-0-1996" name="__codelineno-0-1996"></a>
<a id="__codelineno-0-1997" name="__codelineno-0-1997"></a><span class="sd">        If `reverse_indicators` is `True`, the indicators below the OHLC chart</span>
<a id="__codelineno-0-1998" name="__codelineno-0-1998"></a><span class="sd">        are plotted in reverse order of declaration.</span>
<a id="__codelineno-0-1999" name="__codelineno-0-1999"></a>
<a id="__codelineno-0-2000" name="__codelineno-0-2000"></a><span class="sd">        [Pandas offset string]: \</span>
<a id="__codelineno-0-2001" name="__codelineno-0-2001"></a><span class="sd">            https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects</span>
<a id="__codelineno-0-2002" name="__codelineno-0-2002"></a>
<a id="__codelineno-0-2003" name="__codelineno-0-2003"></a><span class="sd">        [TRADES_AGG]: lib.html#backtesting.lib.TRADES_AGG</span>
<a id="__codelineno-0-2004" name="__codelineno-0-2004"></a>
<a id="__codelineno-0-2005" name="__codelineno-0-2005"></a><span class="sd">        If `show_legend` is `True`, the resulting plot graphs will contain</span>
<a id="__codelineno-0-2006" name="__codelineno-0-2006"></a><span class="sd">        labeled legends.</span>
<a id="__codelineno-0-2007" name="__codelineno-0-2007"></a>
<a id="__codelineno-0-2008" name="__codelineno-0-2008"></a><span class="sd">        If `open_browser` is `True`, the resulting `filename` will be</span>
<a id="__codelineno-0-2009" name="__codelineno-0-2009"></a><span class="sd">        opened in the default web browser.</span>
<a id="__codelineno-0-2010" name="__codelineno-0-2010"></a>
<a id="__codelineno-0-2011" name="__codelineno-0-2011"></a><span class="sd">        If `plot_allocation` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-2012" name="__codelineno-0-2012"></a><span class="sd">        an equity allocation graph section. </span>
<a id="__codelineno-0-2013" name="__codelineno-0-2013"></a>
<a id="__codelineno-0-2014" name="__codelineno-0-2014"></a><span class="sd">        If `relative_allocation` is `True`, scale and label equity allocation graph axis</span>
<a id="__codelineno-0-2015" name="__codelineno-0-2015"></a><span class="sd">        with return percent, not absolute cash-equivalent values.</span>
<a id="__codelineno-0-2016" name="__codelineno-0-2016"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-2017" name="__codelineno-0-2017"></a>        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-2018" name="__codelineno-0-2018"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-2019" name="__codelineno-0-2019"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;First issue `backtest.run()` to obtain results.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-2020" name="__codelineno-0-2020"></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span>
<a id="__codelineno-0-2021" name="__codelineno-0-2021"></a>
<a id="__codelineno-0-2022" name="__codelineno-0-2022"></a>        <span class="n">indicators</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">_indicators</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">_registers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-2023" name="__codelineno-0-2023"></a>
<a id="__codelineno-0-2024" name="__codelineno-0-2024"></a>        <span class="k">return</span> <span class="n">plot</span><span class="p">(</span>
<a id="__codelineno-0-2025" name="__codelineno-0-2025"></a>            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
<a id="__codelineno-0-2026" name="__codelineno-0-2026"></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
<a id="__codelineno-0-2027" name="__codelineno-0-2027"></a>            <span class="n">baseline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ohlc_ref_data</span><span class="p">,</span>
<a id="__codelineno-0-2028" name="__codelineno-0-2028"></a>            <span class="n">indicators</span><span class="o">=</span><span class="n">indicators</span><span class="p">,</span>
<a id="__codelineno-0-2029" name="__codelineno-0-2029"></a>            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
<a id="__codelineno-0-2030" name="__codelineno-0-2030"></a>            <span class="n">plot_width</span><span class="o">=</span><span class="n">plot_width</span><span class="p">,</span>
<a id="__codelineno-0-2031" name="__codelineno-0-2031"></a>            <span class="n">plot_equity</span><span class="o">=</span><span class="n">plot_equity</span><span class="p">,</span>
<a id="__codelineno-0-2032" name="__codelineno-0-2032"></a>            <span class="n">plot_return</span><span class="o">=</span><span class="n">plot_return</span><span class="p">,</span>
<a id="__codelineno-0-2033" name="__codelineno-0-2033"></a>            <span class="n">plot_pl</span><span class="o">=</span><span class="n">plot_pl</span><span class="p">,</span>
<a id="__codelineno-0-2034" name="__codelineno-0-2034"></a>            <span class="n">plot_volume</span><span class="o">=</span><span class="n">plot_volume</span><span class="p">,</span>
<a id="__codelineno-0-2035" name="__codelineno-0-2035"></a>            <span class="n">plot_drawdown</span><span class="o">=</span><span class="n">plot_drawdown</span><span class="p">,</span>
<a id="__codelineno-0-2036" name="__codelineno-0-2036"></a>            <span class="n">plot_trades</span><span class="o">=</span><span class="n">plot_trades</span><span class="p">,</span>
<a id="__codelineno-0-2037" name="__codelineno-0-2037"></a>            <span class="n">smooth_equity</span><span class="o">=</span><span class="n">smooth_equity</span><span class="p">,</span>
<a id="__codelineno-0-2038" name="__codelineno-0-2038"></a>            <span class="n">relative_equity</span><span class="o">=</span><span class="n">relative_equity</span><span class="p">,</span>
<a id="__codelineno-0-2039" name="__codelineno-0-2039"></a>            <span class="n">superimpose</span><span class="o">=</span><span class="n">superimpose</span><span class="p">,</span>
<a id="__codelineno-0-2040" name="__codelineno-0-2040"></a>            <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
<a id="__codelineno-0-2041" name="__codelineno-0-2041"></a>            <span class="n">reverse_indicators</span><span class="o">=</span><span class="n">reverse_indicators</span><span class="p">,</span>
<a id="__codelineno-0-2042" name="__codelineno-0-2042"></a>            <span class="n">show_legend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span>
<a id="__codelineno-0-2043" name="__codelineno-0-2043"></a>            <span class="n">open_browser</span><span class="o">=</span><span class="n">open_browser</span><span class="p">,</span>
<a id="__codelineno-0-2044" name="__codelineno-0-2044"></a>            <span class="n">plot_allocation</span><span class="o">=</span><span class="n">plot_allocation</span><span class="p">,</span>
<a id="__codelineno-0-2045" name="__codelineno-0-2045"></a>            <span class="n">relative_allocation</span><span class="o">=</span><span class="n">relative_allocation</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Backtest.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cash</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">holding</span><span class="o">=</span><span class="p">{},</span> <span class="n">commission</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">trade_on_close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hedging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclusive_orders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trade_start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lot_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rebalance_cash_reserve</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Initialize a backtest. Requires data and a strategy to test.</p>
<p><code>data</code> is a <code>pd.DataFrame</code> with 2-level columns:
1st level is a list of tickers, and 
2nd level is <code>Open</code>, <code>High</code>, <code>Low</code>, <code>Close</code>, and <code>Volume</code>.
If the strategy works only on one asset, the 1st level can be dropped.
If any columns are missing, set them to what you have available,
e.g.</p>
<div class="highlight"><pre><span></span><code>df[&#39;Open&#39;] = df[&#39;High&#39;] = df[&#39;Low&#39;] = df[&#39;Close&#39;]
df[&#39;Volumn&#39;] = 0
</code></pre></div>
<p>The passed data frame can contain additional columns that
can be used by the strategy (e.g. sentiment info).
DataFrame index can be either a datetime index (timestamps)
or a monotonic range index (i.e. a sequence of periods).</p>
<p><code>strategy</code> is a <code>minitrade.backtest.core.backtesting.Strategy</code>
<em>subclass</em> (not an instance).</p>
<p><code>cash</code> is the initial cash to start with.</p>
<p><code>holding</code> is a mapping of preexisting assets and their sizes before 
backtest begins, e.g. </p>
<div class="highlight"><pre><span></span><code>{&#39;AAPL&#39;: 10, &#39;MSFT&#39;: 5}
</code></pre></div>
<p><code>commission</code> is the commission ratio. E.g. if your broker's commission
is 1% of trade value, set commission to <code>0.01</code>. Note, if you wish to
account for bid-ask spread, you can approximate doing so by increasing
the commission, e.g. set it to <code>0.0002</code> for commission-less forex
trading where the average spread is roughly 0.2‰ of asking price.</p>
<p><code>margin</code> is the required margin (ratio) of a leveraged account.
No difference is made between initial and maintenance margins.
To run the backtest using e.g. 50:1 leverge that your broker allows,
set margin to <code>0.02</code> (1 / leverage).</p>
<p>If <code>trade_on_close</code> is <code>True</code>, market orders will be filled
with respect to the current bar's closing price instead of the
next bar's open.</p>
<p>If <code>hedging</code> is <code>True</code>, allow trades in both directions simultaneously.
If <code>False</code>, the opposite-facing orders first close existing trades in
a <a href="https://www.investopedia.com/terms/n/nfa-compliance-rule-2-43b.asp">FIFO</a> manner.</p>
<p>If <code>exclusive_orders</code> is <code>True</code>, each new order auto-closes the previous
trade/position, making at most a single trade (long or short) in effect
at each time.</p>
<p>If <code>trade_start_date</code> is not None, orders generated before the date are
surpressed and ignored in backtesting.</p>
<p><code>lot_size</code> is the minimum increment of shares you buy in one order. Order 
size will be rounded to integer multiples during account rebalancing.</p>
<p><code>fail_fast</code>, when True, instructs the backtester to bail out when
cash is not enough to cover an order. This can be used in live trading
to detect issues early. If False, backtesting will ignore the order and 
continue, which can be convenient during algorithm research.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1342" name="__codelineno-0-1342"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>             <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>             <span class="n">strategy</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Strategy</span><span class="p">],</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>             <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>             <span class="n">cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>             <span class="n">holding</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>             <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">.0</span><span class="p">,</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>             <span class="n">margin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>             <span class="n">trade_on_close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>             <span class="n">hedging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>             <span class="n">exclusive_orders</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>             <span class="n">trade_start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>             <span class="n">lot_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>             <span class="n">fail_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>             <span class="n">rebalance_cash_reserve</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>             <span class="p">):</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a><span class="sd">    Initialize a backtest. Requires data and a strategy to test.</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a><span class="sd">    `data` is a `pd.DataFrame` with 2-level columns:</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a><span class="sd">    1st level is a list of tickers, and </span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a><span class="sd">    2nd level is `Open`, `High`, `Low`, `Close`, and `Volume`.</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a><span class="sd">    If the strategy works only on one asset, the 1st level can be dropped.</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a><span class="sd">    If any columns are missing, set them to what you have available,</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a><span class="sd">    e.g.</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a><span class="sd">        df[&#39;Open&#39;] = df[&#39;High&#39;] = df[&#39;Low&#39;] = df[&#39;Close&#39;]</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a><span class="sd">        df[&#39;Volumn&#39;] = 0</span>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a><span class="sd">    The passed data frame can contain additional columns that</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a><span class="sd">    can be used by the strategy (e.g. sentiment info).</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a><span class="sd">    DataFrame index can be either a datetime index (timestamps)</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a><span class="sd">    or a monotonic range index (i.e. a sequence of periods).</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a><span class="sd">    `strategy` is a `minitrade.backtest.core.backtesting.Strategy`</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a><span class="sd">    _subclass_ (not an instance).</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a><span class="sd">    `cash` is the initial cash to start with.</span>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a><span class="sd">    `holding` is a mapping of preexisting assets and their sizes before </span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a><span class="sd">    backtest begins, e.g. </span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a><span class="sd">        {&#39;AAPL&#39;: 10, &#39;MSFT&#39;: 5}</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a><span class="sd">    `commission` is the commission ratio. E.g. if your broker&#39;s commission</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a><span class="sd">    is 1% of trade value, set commission to `0.01`. Note, if you wish to</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a><span class="sd">    account for bid-ask spread, you can approximate doing so by increasing</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a><span class="sd">    the commission, e.g. set it to `0.0002` for commission-less forex</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a><span class="sd">    trading where the average spread is roughly 0.2‰ of asking price.</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a><span class="sd">    `margin` is the required margin (ratio) of a leveraged account.</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a><span class="sd">    No difference is made between initial and maintenance margins.</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a><span class="sd">    To run the backtest using e.g. 50:1 leverge that your broker allows,</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a><span class="sd">    set margin to `0.02` (1 / leverage).</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a><span class="sd">    If `trade_on_close` is `True`, market orders will be filled</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="sd">    with respect to the current bar&#39;s closing price instead of the</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a><span class="sd">    next bar&#39;s open.</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a><span class="sd">    If `hedging` is `True`, allow trades in both directions simultaneously.</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a><span class="sd">    If `False`, the opposite-facing orders first close existing trades in</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a><span class="sd">    a [FIFO] manner.</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a><span class="sd">    If `exclusive_orders` is `True`, each new order auto-closes the previous</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a><span class="sd">    trade/position, making at most a single trade (long or short) in effect</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a><span class="sd">    at each time.</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a><span class="sd">    If `trade_start_date` is not None, orders generated before the date are</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a><span class="sd">    surpressed and ignored in backtesting.</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a><span class="sd">    `lot_size` is the minimum increment of shares you buy in one order. Order </span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a><span class="sd">    size will be rounded to integer multiples during account rebalancing.</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a><span class="sd">    `fail_fast`, when True, instructs the backtester to bail out when</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a><span class="sd">    cash is not enough to cover an order. This can be used in live trading</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a><span class="sd">    to detect issues early. If False, backtesting will ignore the order and </span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a><span class="sd">    continue, which can be convenient during algorithm research.</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a><span class="sd">    [FIFO]: https://www.investopedia.com/terms/n/nfa-compliance-rule-2-43b.asp</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">Strategy</span><span class="p">)):</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`strategy` must be a Strategy sub-type&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`data` must be a pandas.DataFrame with columns&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">commission</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`commission` must be a float value, percent of &#39;</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>                        <span class="s1">&#39;entry order price&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>    <span class="c1"># Convert single asset data into 2-level column index</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>        <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Asset&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>    <span class="c1"># Convert index to datetime index</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="ow">and</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">)</span> <span class="ow">and</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>        <span class="c1"># Numeric index with most large numbers</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>        <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">()</span> <span class="ow">and</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>         <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;1975&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">.8</span><span class="p">)):</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>            <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">infer_datetime_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>            <span class="k">pass</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">])):</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`data` must be a pandas.DataFrame containing columns &quot;</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>                         <span class="s2">&quot;&#39;Open&#39;, &#39;High&#39;, &#39;Low&#39;, &#39;Close&#39;, and &#39;Volume&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Some OHLC values are missing (NaN). &#39;</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>                         <span class="s1">&#39;Please strip those lines with `df.dropna()` or &#39;</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>                         <span class="s1">&#39;fill them in with `df.interpolate()` or whatever.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cash</span><span class="p">):</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Some prices are larger than initial cash value. Note that fractional &#39;</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>                      <span class="s1">&#39;trading is not supported. If you want to trade Bitcoin, &#39;</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>                      <span class="s1">&#39;increase initial cash, or trade μBTC or satoshis instead (GH-134).&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>                      <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">:</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Data index is not sorted in ascending order. Sorting.&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>                      <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Data index is not datetime. Assuming simple periods, &#39;</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>                      <span class="s1">&#39;but `pd.DateTimeIndex` is advised.&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>                      <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>    <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;dt&#39;</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>        <span class="n">_Broker</span><span class="p">,</span> <span class="n">cash</span><span class="o">=</span><span class="n">cash</span><span class="p">,</span> <span class="n">holding</span><span class="o">=</span><span class="n">holding</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="n">commission</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>        <span class="n">trade_on_close</span><span class="o">=</span><span class="n">trade_on_close</span><span class="p">,</span> <span class="n">hedging</span><span class="o">=</span><span class="n">hedging</span><span class="p">,</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>        <span class="n">exclusive_orders</span><span class="o">=</span><span class="n">exclusive_orders</span><span class="p">,</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>        <span class="n">trade_start_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">trade_start_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">trade_start_date</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>        <span class="n">lot_size</span><span class="o">=</span><span class="n">lot_size</span><span class="p">,</span> <span class="n">fail_fast</span><span class="o">=</span><span class="n">fail_fast</span><span class="p">,</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>        <span class="n">rebalance_cash_reserve</span><span class="o">=</span><span class="n">rebalance_cash_reserve</span><span class="p">,</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>    <span class="p">)</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Backtest.optimize" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">optimize</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="s1">&#39;SQN&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_heatmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_optimization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Optimize strategy parameters to an optimal combination.
Returns result <code>pd.Series</code> of the best run.</p>
<p><code>maximize</code> is a string key from the
<code>minitrade.backtest.core.backtesting.Backtest.run</code>-returned results series,
or a function that accepts this series object and returns a number;
the higher the better. By default, the method maximizes
Van Tharp's <a href="https://google.com/search?q=System+Quality+Number">System Quality Number</a>.</p>
<p><code>method</code> is the optimization method. Currently two methods are supported:</p>
<ul>
<li><code>"grid"</code> which does an exhaustive (or randomized) search over the
  cartesian product of parameter combinations, and</li>
<li><code>"skopt"</code> which finds close-to-optimal strategy parameters using
  <a href="https://scikit-optimize.github.io/stable/auto_examples/bayesian-optimization.html">model-based optimization</a>, making at most <code>max_tries</code> evaluations.</li>
</ul>
<p><code>max_tries</code> is the maximal number of strategy runs to perform.
If <code>method="grid"</code>, this results in randomized grid search.
If <code>max_tries</code> is a floating value between (0, 1], this sets the
number of runs to approximately that fraction of full grid space.
Alternatively, if integer, it denotes the absolute maximum number
of evaluations. If unspecified (default), grid search is exhaustive,
whereas for <code>method="skopt"</code>, <code>max_tries</code> is set to 200.</p>
<p><code>constraint</code> is a function that accepts a dict-like object of
parameters (with values) and returns <code>True</code> when the combination
is admissible to test with. By default, any parameters combination
is considered admissible.</p>
<p>If <code>return_heatmap</code> is <code>True</code>, besides returning the result
series, an additional <code>pd.Series</code> is returned with a multiindex
of all admissible parameter combinations, which can be further
inspected or projected onto 2D to plot a heatmap
(see <code>backtesting.lib.plot_heatmaps()</code>).</p>
<p>If <code>return_optimization</code> is True and <code>method = 'skopt'</code>,
in addition to result series (and maybe heatmap), return raw
<a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html"><code>scipy.optimize.OptimizeResult</code></a> for further
inspection, e.g. with <a href="https://scikit-optimize.github.io">scikit-optimize</a>        <a href="https://scikit-optimize.github.io/stable/modules/plots.html">plotting tools</a>.</p>
<p>If you want reproducible optimization results, set <code>random_state</code>
to a fixed integer random seed.</p>
<p>Additional keyword arguments represent strategy arguments with
list-like collections of possible values. For example, the following
code finds and returns the "best" of the 7 admissible (of the
9 possible) parameter combinations:</p>
<div class="highlight"><pre><span></span><code>backtest.optimize(sma1=[5, 10, 15], sma2=[10, 20, 40],
                  constraint=lambda p: p.sma1 &lt; p.sma2)
</code></pre></div>
<p>.. TODO::
    Improve multiprocessing/parallel execution on Windos with start method 'spawn'.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span>
<span class="normal"><a href="#__codelineno-0-1622">1622</a></span>
<span class="normal"><a href="#__codelineno-0-1623">1623</a></span>
<span class="normal"><a href="#__codelineno-0-1624">1624</a></span>
<span class="normal"><a href="#__codelineno-0-1625">1625</a></span>
<span class="normal"><a href="#__codelineno-0-1626">1626</a></span>
<span class="normal"><a href="#__codelineno-0-1627">1627</a></span>
<span class="normal"><a href="#__codelineno-0-1628">1628</a></span>
<span class="normal"><a href="#__codelineno-0-1629">1629</a></span>
<span class="normal"><a href="#__codelineno-0-1630">1630</a></span>
<span class="normal"><a href="#__codelineno-0-1631">1631</a></span>
<span class="normal"><a href="#__codelineno-0-1632">1632</a></span>
<span class="normal"><a href="#__codelineno-0-1633">1633</a></span>
<span class="normal"><a href="#__codelineno-0-1634">1634</a></span>
<span class="normal"><a href="#__codelineno-0-1635">1635</a></span>
<span class="normal"><a href="#__codelineno-0-1636">1636</a></span>
<span class="normal"><a href="#__codelineno-0-1637">1637</a></span>
<span class="normal"><a href="#__codelineno-0-1638">1638</a></span>
<span class="normal"><a href="#__codelineno-0-1639">1639</a></span>
<span class="normal"><a href="#__codelineno-0-1640">1640</a></span>
<span class="normal"><a href="#__codelineno-0-1641">1641</a></span>
<span class="normal"><a href="#__codelineno-0-1642">1642</a></span>
<span class="normal"><a href="#__codelineno-0-1643">1643</a></span>
<span class="normal"><a href="#__codelineno-0-1644">1644</a></span>
<span class="normal"><a href="#__codelineno-0-1645">1645</a></span>
<span class="normal"><a href="#__codelineno-0-1646">1646</a></span>
<span class="normal"><a href="#__codelineno-0-1647">1647</a></span>
<span class="normal"><a href="#__codelineno-0-1648">1648</a></span>
<span class="normal"><a href="#__codelineno-0-1649">1649</a></span>
<span class="normal"><a href="#__codelineno-0-1650">1650</a></span>
<span class="normal"><a href="#__codelineno-0-1651">1651</a></span>
<span class="normal"><a href="#__codelineno-0-1652">1652</a></span>
<span class="normal"><a href="#__codelineno-0-1653">1653</a></span>
<span class="normal"><a href="#__codelineno-0-1654">1654</a></span>
<span class="normal"><a href="#__codelineno-0-1655">1655</a></span>
<span class="normal"><a href="#__codelineno-0-1656">1656</a></span>
<span class="normal"><a href="#__codelineno-0-1657">1657</a></span>
<span class="normal"><a href="#__codelineno-0-1658">1658</a></span>
<span class="normal"><a href="#__codelineno-0-1659">1659</a></span>
<span class="normal"><a href="#__codelineno-0-1660">1660</a></span>
<span class="normal"><a href="#__codelineno-0-1661">1661</a></span>
<span class="normal"><a href="#__codelineno-0-1662">1662</a></span>
<span class="normal"><a href="#__codelineno-0-1663">1663</a></span>
<span class="normal"><a href="#__codelineno-0-1664">1664</a></span>
<span class="normal"><a href="#__codelineno-0-1665">1665</a></span>
<span class="normal"><a href="#__codelineno-0-1666">1666</a></span>
<span class="normal"><a href="#__codelineno-0-1667">1667</a></span>
<span class="normal"><a href="#__codelineno-0-1668">1668</a></span>
<span class="normal"><a href="#__codelineno-0-1669">1669</a></span>
<span class="normal"><a href="#__codelineno-0-1670">1670</a></span>
<span class="normal"><a href="#__codelineno-0-1671">1671</a></span>
<span class="normal"><a href="#__codelineno-0-1672">1672</a></span>
<span class="normal"><a href="#__codelineno-0-1673">1673</a></span>
<span class="normal"><a href="#__codelineno-0-1674">1674</a></span>
<span class="normal"><a href="#__codelineno-0-1675">1675</a></span>
<span class="normal"><a href="#__codelineno-0-1676">1676</a></span>
<span class="normal"><a href="#__codelineno-0-1677">1677</a></span>
<span class="normal"><a href="#__codelineno-0-1678">1678</a></span>
<span class="normal"><a href="#__codelineno-0-1679">1679</a></span>
<span class="normal"><a href="#__codelineno-0-1680">1680</a></span>
<span class="normal"><a href="#__codelineno-0-1681">1681</a></span>
<span class="normal"><a href="#__codelineno-0-1682">1682</a></span>
<span class="normal"><a href="#__codelineno-0-1683">1683</a></span>
<span class="normal"><a href="#__codelineno-0-1684">1684</a></span>
<span class="normal"><a href="#__codelineno-0-1685">1685</a></span>
<span class="normal"><a href="#__codelineno-0-1686">1686</a></span>
<span class="normal"><a href="#__codelineno-0-1687">1687</a></span>
<span class="normal"><a href="#__codelineno-0-1688">1688</a></span>
<span class="normal"><a href="#__codelineno-0-1689">1689</a></span>
<span class="normal"><a href="#__codelineno-0-1690">1690</a></span>
<span class="normal"><a href="#__codelineno-0-1691">1691</a></span>
<span class="normal"><a href="#__codelineno-0-1692">1692</a></span>
<span class="normal"><a href="#__codelineno-0-1693">1693</a></span>
<span class="normal"><a href="#__codelineno-0-1694">1694</a></span>
<span class="normal"><a href="#__codelineno-0-1695">1695</a></span>
<span class="normal"><a href="#__codelineno-0-1696">1696</a></span>
<span class="normal"><a href="#__codelineno-0-1697">1697</a></span>
<span class="normal"><a href="#__codelineno-0-1698">1698</a></span>
<span class="normal"><a href="#__codelineno-0-1699">1699</a></span>
<span class="normal"><a href="#__codelineno-0-1700">1700</a></span>
<span class="normal"><a href="#__codelineno-0-1701">1701</a></span>
<span class="normal"><a href="#__codelineno-0-1702">1702</a></span>
<span class="normal"><a href="#__codelineno-0-1703">1703</a></span>
<span class="normal"><a href="#__codelineno-0-1704">1704</a></span>
<span class="normal"><a href="#__codelineno-0-1705">1705</a></span>
<span class="normal"><a href="#__codelineno-0-1706">1706</a></span>
<span class="normal"><a href="#__codelineno-0-1707">1707</a></span>
<span class="normal"><a href="#__codelineno-0-1708">1708</a></span>
<span class="normal"><a href="#__codelineno-0-1709">1709</a></span>
<span class="normal"><a href="#__codelineno-0-1710">1710</a></span>
<span class="normal"><a href="#__codelineno-0-1711">1711</a></span>
<span class="normal"><a href="#__codelineno-0-1712">1712</a></span>
<span class="normal"><a href="#__codelineno-0-1713">1713</a></span>
<span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span>
<span class="normal"><a href="#__codelineno-0-1730">1730</a></span>
<span class="normal"><a href="#__codelineno-0-1731">1731</a></span>
<span class="normal"><a href="#__codelineno-0-1732">1732</a></span>
<span class="normal"><a href="#__codelineno-0-1733">1733</a></span>
<span class="normal"><a href="#__codelineno-0-1734">1734</a></span>
<span class="normal"><a href="#__codelineno-0-1735">1735</a></span>
<span class="normal"><a href="#__codelineno-0-1736">1736</a></span>
<span class="normal"><a href="#__codelineno-0-1737">1737</a></span>
<span class="normal"><a href="#__codelineno-0-1738">1738</a></span>
<span class="normal"><a href="#__codelineno-0-1739">1739</a></span>
<span class="normal"><a href="#__codelineno-0-1740">1740</a></span>
<span class="normal"><a href="#__codelineno-0-1741">1741</a></span>
<span class="normal"><a href="#__codelineno-0-1742">1742</a></span>
<span class="normal"><a href="#__codelineno-0-1743">1743</a></span>
<span class="normal"><a href="#__codelineno-0-1744">1744</a></span>
<span class="normal"><a href="#__codelineno-0-1745">1745</a></span>
<span class="normal"><a href="#__codelineno-0-1746">1746</a></span>
<span class="normal"><a href="#__codelineno-0-1747">1747</a></span>
<span class="normal"><a href="#__codelineno-0-1748">1748</a></span>
<span class="normal"><a href="#__codelineno-0-1749">1749</a></span>
<span class="normal"><a href="#__codelineno-0-1750">1750</a></span>
<span class="normal"><a href="#__codelineno-0-1751">1751</a></span>
<span class="normal"><a href="#__codelineno-0-1752">1752</a></span>
<span class="normal"><a href="#__codelineno-0-1753">1753</a></span>
<span class="normal"><a href="#__codelineno-0-1754">1754</a></span>
<span class="normal"><a href="#__codelineno-0-1755">1755</a></span>
<span class="normal"><a href="#__codelineno-0-1756">1756</a></span>
<span class="normal"><a href="#__codelineno-0-1757">1757</a></span>
<span class="normal"><a href="#__codelineno-0-1758">1758</a></span>
<span class="normal"><a href="#__codelineno-0-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-0-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-0-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-0-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-0-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-0-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-0-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-0-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-0-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-0-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-0-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-0-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-0-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span>
<span class="normal"><a href="#__codelineno-0-1796">1796</a></span>
<span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span>
<span class="normal"><a href="#__codelineno-0-1802">1802</a></span>
<span class="normal"><a href="#__codelineno-0-1803">1803</a></span>
<span class="normal"><a href="#__codelineno-0-1804">1804</a></span>
<span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span>
<span class="normal"><a href="#__codelineno-0-1815">1815</a></span>
<span class="normal"><a href="#__codelineno-0-1816">1816</a></span>
<span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span>
<span class="normal"><a href="#__codelineno-0-1825">1825</a></span>
<span class="normal"><a href="#__codelineno-0-1826">1826</a></span>
<span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span>
<span class="normal"><a href="#__codelineno-0-1899">1899</a></span>
<span class="normal"><a href="#__codelineno-0-1900">1900</a></span>
<span class="normal"><a href="#__codelineno-0-1901">1901</a></span>
<span class="normal"><a href="#__codelineno-0-1902">1902</a></span>
<span class="normal"><a href="#__codelineno-0-1903">1903</a></span>
<span class="normal"><a href="#__codelineno-0-1904">1904</a></span>
<span class="normal"><a href="#__codelineno-0-1905">1905</a></span>
<span class="normal"><a href="#__codelineno-0-1906">1906</a></span>
<span class="normal"><a href="#__codelineno-0-1907">1907</a></span>
<span class="normal"><a href="#__codelineno-0-1908">1908</a></span>
<span class="normal"><a href="#__codelineno-0-1909">1909</a></span>
<span class="normal"><a href="#__codelineno-0-1910">1910</a></span>
<span class="normal"><a href="#__codelineno-0-1911">1911</a></span>
<span class="normal"><a href="#__codelineno-0-1912">1912</a></span>
<span class="normal"><a href="#__codelineno-0-1913">1913</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1614" name="__codelineno-0-1614"></a><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a>             <span class="n">maximize</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;SQN&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a>             <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a>             <span class="n">max_tries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a>             <span class="n">constraint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a>             <span class="n">return_heatmap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>             <span class="n">return_optimization</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a>             <span class="n">random_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1622" name="__codelineno-0-1622"></a>             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
<a id="__codelineno-0-1623" name="__codelineno-0-1623"></a>                                <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
<a id="__codelineno-0-1624" name="__codelineno-0-1624"></a>                                <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
<a id="__codelineno-0-1625" name="__codelineno-0-1625"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1626" name="__codelineno-0-1626"></a><span class="sd">    Optimize strategy parameters to an optimal combination.</span>
<a id="__codelineno-0-1627" name="__codelineno-0-1627"></a><span class="sd">    Returns result `pd.Series` of the best run.</span>
<a id="__codelineno-0-1628" name="__codelineno-0-1628"></a>
<a id="__codelineno-0-1629" name="__codelineno-0-1629"></a><span class="sd">    `maximize` is a string key from the</span>
<a id="__codelineno-0-1630" name="__codelineno-0-1630"></a><span class="sd">    `minitrade.backtest.core.backtesting.Backtest.run`-returned results series,</span>
<a id="__codelineno-0-1631" name="__codelineno-0-1631"></a><span class="sd">    or a function that accepts this series object and returns a number;</span>
<a id="__codelineno-0-1632" name="__codelineno-0-1632"></a><span class="sd">    the higher the better. By default, the method maximizes</span>
<a id="__codelineno-0-1633" name="__codelineno-0-1633"></a><span class="sd">    Van Tharp&#39;s [System Quality Number](https://google.com/search?q=System+Quality+Number).</span>
<a id="__codelineno-0-1634" name="__codelineno-0-1634"></a>
<a id="__codelineno-0-1635" name="__codelineno-0-1635"></a><span class="sd">    `method` is the optimization method. Currently two methods are supported:</span>
<a id="__codelineno-0-1636" name="__codelineno-0-1636"></a>
<a id="__codelineno-0-1637" name="__codelineno-0-1637"></a><span class="sd">    * `&quot;grid&quot;` which does an exhaustive (or randomized) search over the</span>
<a id="__codelineno-0-1638" name="__codelineno-0-1638"></a><span class="sd">      cartesian product of parameter combinations, and</span>
<a id="__codelineno-0-1639" name="__codelineno-0-1639"></a><span class="sd">    * `&quot;skopt&quot;` which finds close-to-optimal strategy parameters using</span>
<a id="__codelineno-0-1640" name="__codelineno-0-1640"></a><span class="sd">      [model-based optimization], making at most `max_tries` evaluations.</span>
<a id="__codelineno-0-1641" name="__codelineno-0-1641"></a>
<a id="__codelineno-0-1642" name="__codelineno-0-1642"></a><span class="sd">    [model-based optimization]: \</span>
<a id="__codelineno-0-1643" name="__codelineno-0-1643"></a><span class="sd">        https://scikit-optimize.github.io/stable/auto_examples/bayesian-optimization.html</span>
<a id="__codelineno-0-1644" name="__codelineno-0-1644"></a>
<a id="__codelineno-0-1645" name="__codelineno-0-1645"></a><span class="sd">    `max_tries` is the maximal number of strategy runs to perform.</span>
<a id="__codelineno-0-1646" name="__codelineno-0-1646"></a><span class="sd">    If `method=&quot;grid&quot;`, this results in randomized grid search.</span>
<a id="__codelineno-0-1647" name="__codelineno-0-1647"></a><span class="sd">    If `max_tries` is a floating value between (0, 1], this sets the</span>
<a id="__codelineno-0-1648" name="__codelineno-0-1648"></a><span class="sd">    number of runs to approximately that fraction of full grid space.</span>
<a id="__codelineno-0-1649" name="__codelineno-0-1649"></a><span class="sd">    Alternatively, if integer, it denotes the absolute maximum number</span>
<a id="__codelineno-0-1650" name="__codelineno-0-1650"></a><span class="sd">    of evaluations. If unspecified (default), grid search is exhaustive,</span>
<a id="__codelineno-0-1651" name="__codelineno-0-1651"></a><span class="sd">    whereas for `method=&quot;skopt&quot;`, `max_tries` is set to 200.</span>
<a id="__codelineno-0-1652" name="__codelineno-0-1652"></a>
<a id="__codelineno-0-1653" name="__codelineno-0-1653"></a><span class="sd">    `constraint` is a function that accepts a dict-like object of</span>
<a id="__codelineno-0-1654" name="__codelineno-0-1654"></a><span class="sd">    parameters (with values) and returns `True` when the combination</span>
<a id="__codelineno-0-1655" name="__codelineno-0-1655"></a><span class="sd">    is admissible to test with. By default, any parameters combination</span>
<a id="__codelineno-0-1656" name="__codelineno-0-1656"></a><span class="sd">    is considered admissible.</span>
<a id="__codelineno-0-1657" name="__codelineno-0-1657"></a>
<a id="__codelineno-0-1658" name="__codelineno-0-1658"></a><span class="sd">    If `return_heatmap` is `True`, besides returning the result</span>
<a id="__codelineno-0-1659" name="__codelineno-0-1659"></a><span class="sd">    series, an additional `pd.Series` is returned with a multiindex</span>
<a id="__codelineno-0-1660" name="__codelineno-0-1660"></a><span class="sd">    of all admissible parameter combinations, which can be further</span>
<a id="__codelineno-0-1661" name="__codelineno-0-1661"></a><span class="sd">    inspected or projected onto 2D to plot a heatmap</span>
<a id="__codelineno-0-1662" name="__codelineno-0-1662"></a><span class="sd">    (see `backtesting.lib.plot_heatmaps()`).</span>
<a id="__codelineno-0-1663" name="__codelineno-0-1663"></a>
<a id="__codelineno-0-1664" name="__codelineno-0-1664"></a><span class="sd">    If `return_optimization` is True and `method = &#39;skopt&#39;`,</span>
<a id="__codelineno-0-1665" name="__codelineno-0-1665"></a><span class="sd">    in addition to result series (and maybe heatmap), return raw</span>
<a id="__codelineno-0-1666" name="__codelineno-0-1666"></a><span class="sd">    [`scipy.optimize.OptimizeResult`][OptimizeResult] for further</span>
<a id="__codelineno-0-1667" name="__codelineno-0-1667"></a><span class="sd">    inspection, e.g. with [scikit-optimize]\</span>
<a id="__codelineno-0-1668" name="__codelineno-0-1668"></a><span class="sd">    [plotting tools].</span>
<a id="__codelineno-0-1669" name="__codelineno-0-1669"></a>
<a id="__codelineno-0-1670" name="__codelineno-0-1670"></a><span class="sd">    [OptimizeResult]: \</span>
<a id="__codelineno-0-1671" name="__codelineno-0-1671"></a><span class="sd">        https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html</span>
<a id="__codelineno-0-1672" name="__codelineno-0-1672"></a><span class="sd">    [scikit-optimize]: https://scikit-optimize.github.io</span>
<a id="__codelineno-0-1673" name="__codelineno-0-1673"></a><span class="sd">    [plotting tools]: https://scikit-optimize.github.io/stable/modules/plots.html</span>
<a id="__codelineno-0-1674" name="__codelineno-0-1674"></a>
<a id="__codelineno-0-1675" name="__codelineno-0-1675"></a><span class="sd">    If you want reproducible optimization results, set `random_state`</span>
<a id="__codelineno-0-1676" name="__codelineno-0-1676"></a><span class="sd">    to a fixed integer random seed.</span>
<a id="__codelineno-0-1677" name="__codelineno-0-1677"></a>
<a id="__codelineno-0-1678" name="__codelineno-0-1678"></a><span class="sd">    Additional keyword arguments represent strategy arguments with</span>
<a id="__codelineno-0-1679" name="__codelineno-0-1679"></a><span class="sd">    list-like collections of possible values. For example, the following</span>
<a id="__codelineno-0-1680" name="__codelineno-0-1680"></a><span class="sd">    code finds and returns the &quot;best&quot; of the 7 admissible (of the</span>
<a id="__codelineno-0-1681" name="__codelineno-0-1681"></a><span class="sd">    9 possible) parameter combinations:</span>
<a id="__codelineno-0-1682" name="__codelineno-0-1682"></a>
<a id="__codelineno-0-1683" name="__codelineno-0-1683"></a><span class="sd">        backtest.optimize(sma1=[5, 10, 15], sma2=[10, 20, 40],</span>
<a id="__codelineno-0-1684" name="__codelineno-0-1684"></a><span class="sd">                          constraint=lambda p: p.sma1 &lt; p.sma2)</span>
<a id="__codelineno-0-1685" name="__codelineno-0-1685"></a>
<a id="__codelineno-0-1686" name="__codelineno-0-1686"></a><span class="sd">    .. TODO::</span>
<a id="__codelineno-0-1687" name="__codelineno-0-1687"></a><span class="sd">        Improve multiprocessing/parallel execution on Windos with start method &#39;spawn&#39;.</span>
<a id="__codelineno-0-1688" name="__codelineno-0-1688"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1689" name="__codelineno-0-1689"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
<a id="__codelineno-0-1690" name="__codelineno-0-1690"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need some strategy parameters to optimize&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1691" name="__codelineno-0-1691"></a>
<a id="__codelineno-0-1692" name="__codelineno-0-1692"></a>    <span class="n">maximize_key</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1693" name="__codelineno-0-1693"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maximize</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1694" name="__codelineno-0-1694"></a>        <span class="n">maximize_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">maximize</span><span class="p">)</span>
<a id="__codelineno-0-1695" name="__codelineno-0-1695"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-0-1696" name="__codelineno-0-1696"></a>        <span class="k">if</span> <span class="n">maximize</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
<a id="__codelineno-0-1697" name="__codelineno-0-1697"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`maximize`, if str, must match a key in pd.Series &#39;</span>
<a id="__codelineno-0-1698" name="__codelineno-0-1698"></a>                             <span class="s1">&#39;result of backtest.run()&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1699" name="__codelineno-0-1699"></a>
<a id="__codelineno-0-1700" name="__codelineno-0-1700"></a>        <span class="k">def</span> <span class="nf">maximize</span><span class="p">(</span><span class="n">stats</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_key</span><span class="o">=</span><span class="n">maximize</span><span class="p">):</span>
<a id="__codelineno-0-1701" name="__codelineno-0-1701"></a>            <span class="k">return</span> <span class="n">stats</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
<a id="__codelineno-0-1702" name="__codelineno-0-1702"></a>
<a id="__codelineno-0-1703" name="__codelineno-0-1703"></a>    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">maximize</span><span class="p">):</span>
<a id="__codelineno-0-1704" name="__codelineno-0-1704"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`maximize` must be str (a field of backtest.run() result &#39;</span>
<a id="__codelineno-0-1705" name="__codelineno-0-1705"></a>                        <span class="s1">&#39;Series) or a function that accepts result Series &#39;</span>
<a id="__codelineno-0-1706" name="__codelineno-0-1706"></a>                        <span class="s1">&#39;and returns a number; the higher the better&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1707" name="__codelineno-0-1707"></a>    <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">maximize</span><span class="p">),</span> <span class="n">maximize</span>
<a id="__codelineno-0-1708" name="__codelineno-0-1708"></a>
<a id="__codelineno-0-1709" name="__codelineno-0-1709"></a>    <span class="n">have_constraint</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
<a id="__codelineno-0-1710" name="__codelineno-0-1710"></a>    <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1711" name="__codelineno-0-1711"></a>
<a id="__codelineno-0-1712" name="__codelineno-0-1712"></a>        <span class="k">def</span> <span class="nf">constraint</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
<a id="__codelineno-0-1713" name="__codelineno-0-1713"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-1714" name="__codelineno-0-1714"></a>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a>    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">constraint</span><span class="p">):</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`constraint` must be a function that accepts a dict &quot;</span>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a>                        <span class="s2">&quot;of strategy parameters and returns a bool whether &quot;</span>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a>                        <span class="s2">&quot;the combination of parameters is admissible or not&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a>    <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">constraint</span><span class="p">),</span> <span class="n">constraint</span>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a>    <span class="k">if</span> <span class="n">return_optimization</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;skopt&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_optimization=True only valid if method=&#39;skopt&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a>    <span class="k">def</span> <span class="nf">_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a>        <span class="k">return</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization variable &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; is passed no &quot;</span>
<a id="__codelineno-0-1730" name="__codelineno-0-1730"></a>                             <span class="sa">f</span><span class="s2">&quot;optimization values: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1731" name="__codelineno-0-1731"></a>
<a id="__codelineno-0-1732" name="__codelineno-0-1732"></a>    <span class="k">class</span> <span class="nc">AttrDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-1733" name="__codelineno-0-1733"></a>        <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-1734" name="__codelineno-0-1734"></a>            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
<a id="__codelineno-0-1735" name="__codelineno-0-1735"></a>
<a id="__codelineno-0-1736" name="__codelineno-0-1736"></a>    <span class="k">def</span> <span class="nf">_grid_size</span><span class="p">():</span>
<a id="__codelineno-0-1737" name="__codelineno-0-1737"></a>        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
<a id="__codelineno-0-1738" name="__codelineno-0-1738"></a>        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10_000</span> <span class="ow">and</span> <span class="n">have_constraint</span><span class="p">:</span>
<a id="__codelineno-0-1739" name="__codelineno-0-1739"></a>            <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<a id="__codelineno-0-1740" name="__codelineno-0-1740"></a>                                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<a id="__codelineno-0-1741" name="__codelineno-0-1741"></a>                       <span class="k">if</span> <span class="n">constraint</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
<a id="__codelineno-0-1742" name="__codelineno-0-1742"></a>        <span class="k">return</span> <span class="n">size</span>
<a id="__codelineno-0-1743" name="__codelineno-0-1743"></a>
<a id="__codelineno-0-1744" name="__codelineno-0-1744"></a>    <span class="k">def</span> <span class="nf">_optimize_grid</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]]:</span>
<a id="__codelineno-0-1745" name="__codelineno-0-1745"></a>        <span class="n">rand</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span><span class="o">.</span><span class="n">random</span>
<a id="__codelineno-0-1746" name="__codelineno-0-1746"></a>        <span class="n">grid_frac</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">max_tries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
<a id="__codelineno-0-1747" name="__codelineno-0-1747"></a>                     <span class="n">max_tries</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_tries</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span>
<a id="__codelineno-0-1748" name="__codelineno-0-1748"></a>                     <span class="n">max_tries</span> <span class="o">/</span> <span class="n">_grid_size</span><span class="p">())</span>
<a id="__codelineno-0-1749" name="__codelineno-0-1749"></a>        <span class="n">param_combos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># back to dict so it pickles</span>
<a id="__codelineno-0-1750" name="__codelineno-0-1750"></a>                        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-0-1751" name="__codelineno-0-1751"></a>                                       <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<a id="__codelineno-0-1752" name="__codelineno-0-1752"></a>                                                               <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
<a id="__codelineno-0-1753" name="__codelineno-0-1753"></a>                        <span class="k">if</span> <span class="n">constraint</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-1754" name="__codelineno-0-1754"></a>                        <span class="ow">and</span> <span class="n">rand</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">grid_frac</span><span class="p">]</span>
<a id="__codelineno-0-1755" name="__codelineno-0-1755"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_combos</span><span class="p">:</span>
<a id="__codelineno-0-1756" name="__codelineno-0-1756"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No admissible parameter combinations to test&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1757" name="__codelineno-0-1757"></a>
<a id="__codelineno-0-1758" name="__codelineno-0-1758"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
<a id="__codelineno-0-1759" name="__codelineno-0-1759"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Searching for best of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_combos</span><span class="p">)</span><span class="si">}</span><span class="s1"> configurations.&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1760" name="__codelineno-0-1760"></a>                          <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1761" name="__codelineno-0-1761"></a>
<a id="__codelineno-0-1762" name="__codelineno-0-1762"></a>        <span class="n">heatmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
<a id="__codelineno-0-1763" name="__codelineno-0-1763"></a>                            <span class="n">name</span><span class="o">=</span><span class="n">maximize_key</span><span class="p">,</span>
<a id="__codelineno-0-1764" name="__codelineno-0-1764"></a>                            <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
<a id="__codelineno-0-1765" name="__codelineno-0-1765"></a>                                <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_combos</span><span class="p">],</span>
<a id="__codelineno-0-1766" name="__codelineno-0-1766"></a>                                <span class="n">names</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">param_combos</span><span class="p">))</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-1767" name="__codelineno-0-1767"></a>
<a id="__codelineno-0-1768" name="__codelineno-0-1768"></a>        <span class="k">def</span> <span class="nf">_batch</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
<a id="__codelineno-0-1769" name="__codelineno-0-1769"></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<a id="__codelineno-0-1770" name="__codelineno-0-1770"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-0-1771" name="__codelineno-0-1771"></a>                <span class="k">yield</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>
<a id="__codelineno-0-1772" name="__codelineno-0-1772"></a>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>        <span class="c1"># Save necessary objects into &quot;global&quot; state; pass into concurrent executor</span>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>        <span class="c1"># (and thus pickle) nothing but two numbers; receive nothing but numbers.</span>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>        <span class="c1"># With start method &quot;fork&quot;, children processes will inherit parent address space</span>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>        <span class="c1"># in a copy-on-write manner, achieving better performance/RAM benefit.</span>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>        <span class="n">backtest_uuid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>        <span class="n">param_batches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_batch</span><span class="p">(</span><span class="n">param_combos</span><span class="p">))</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a>        <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">,</span> <span class="n">maximize</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a>            <span class="c1"># If multiprocessing start method is &#39;fork&#39; (i.e. on POSIX), use</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>            <span class="c1"># a pool of processes to compute results in parallel.</span>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a>            <span class="c1"># Otherwise (i.e. on Windos), sequential computation will be &quot;faster&quot;.</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a>            <span class="k">if</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_start_method</span><span class="p">(</span><span class="n">allow_none</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;fork&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a>                <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a>                    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_task</span><span class="p">,</span> <span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a>                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_batches</span><span class="p">))]</span>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a>                    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="p">(</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">),</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a>                                        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Backtest.optimize&#39;</span><span class="p">):</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a>                        <span class="n">batch_index</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a>                        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]):</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a>                            <span class="n">heatmap</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a>                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;For multiprocessing support in `Backtest.optimize()` &quot;</span>
<a id="__codelineno-0-1796" name="__codelineno-0-1796"></a>                                  <span class="s2">&quot;set multiprocessing start method to &#39;fork&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1797" name="__codelineno-0-1797"></a>                <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_batches</span><span class="p">))):</span>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a>                    <span class="n">_</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_task</span><span class="p">(</span><span class="n">backtest_uuid</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">)</span>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a>                    <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">param_batches</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]):</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a>                        <span class="n">heatmap</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-1802" name="__codelineno-0-1802"></a>            <span class="k">del</span> <span class="n">Backtest</span><span class="o">.</span><span class="n">_mp_backtests</span><span class="p">[</span><span class="n">backtest_uuid</span><span class="p">]</span>
<a id="__codelineno-0-1803" name="__codelineno-0-1803"></a>
<a id="__codelineno-0-1804" name="__codelineno-0-1804"></a>        <span class="n">best_params</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<a id="__codelineno-0-1805" name="__codelineno-0-1805"></a>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a>        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">best_params</span><span class="p">):</span>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a>            <span class="c1"># No trade was made in any of the runs. Just make a random</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a>            <span class="c1"># run so we get some, if empty, results</span>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a>            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">param_combos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a>            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">heatmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)))</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a>        <span class="k">if</span> <span class="n">return_heatmap</span><span class="p">:</span>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a>            <span class="k">return</span> <span class="n">stats</span><span class="p">,</span> <span class="n">heatmap</span>
<a id="__codelineno-0-1815" name="__codelineno-0-1815"></a>        <span class="k">return</span> <span class="n">stats</span>
<a id="__codelineno-0-1816" name="__codelineno-0-1816"></a>
<a id="__codelineno-0-1817" name="__codelineno-0-1817"></a>    <span class="k">def</span> <span class="nf">_optimize_skopt</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a>                                   <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a>                                   <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a>            <span class="kn">from</span> <span class="nn">skopt</span> <span class="kn">import</span> <span class="n">forest_minimize</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a>            <span class="kn">from</span> <span class="nn">skopt.callbacks</span> <span class="kn">import</span> <span class="n">DeltaXStopper</span>
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a>            <span class="kn">from</span> <span class="nn">skopt.learning</span> <span class="kn">import</span> <span class="n">ExtraTreesRegressor</span>
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a>            <span class="kn">from</span> <span class="nn">skopt.space</span> <span class="kn">import</span> <span class="n">Categorical</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Real</span>
<a id="__codelineno-0-1825" name="__codelineno-0-1825"></a>            <span class="kn">from</span> <span class="nn">skopt.utils</span> <span class="kn">import</span> <span class="n">use_named_args</span>
<a id="__codelineno-0-1826" name="__codelineno-0-1826"></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<a id="__codelineno-0-1827" name="__codelineno-0-1827"></a>            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Need package &#39;scikit-optimize&#39; for method=&#39;skopt&#39;. &quot;</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a>                              <span class="s2">&quot;pip install scikit-optimize&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a>        <span class="k">nonlocal</span> <span class="n">max_tries</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a>        <span class="n">max_tries</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span> <span class="k">if</span> <span class="n">max_tries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a>                     <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_tries</span> <span class="o">*</span> <span class="n">_grid_size</span><span class="p">()))</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">max_tries</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a>                     <span class="n">max_tries</span><span class="p">)</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a>        <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a>            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;mM&#39;</span><span class="p">:</span>  <span class="c1"># timedelta, datetime64</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a>                <span class="c1"># these dtypes are unsupported in skopt, so convert to raw int</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a>                <span class="c1"># TODO: save dtype and convert back later</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a>                <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a>            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s1">&#39;iumM&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a>                <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a>            <span class="k">elif</span> <span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a>                <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Real</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">high</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a>                <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Categorical</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">&#39;onehot&#39;</span><span class="p">))</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a>        <span class="c1"># Avoid recomputing re-evaluations:</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a>        <span class="c1"># &quot;The objective has been evaluated at this point before.&quot;</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a>        <span class="c1"># https://github.com/scikit-optimize/scikit-optimize/issues/302</span>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a>        <span class="n">memoized_run</span> <span class="o">=</span> <span class="n">lru_cache</span><span class="p">()(</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">tup</span><span class="p">)))</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a>        <span class="c1"># np.inf/np.nan breaks sklearn, np.finfo(float).max breaks skopt.plots.plot_objective</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a>        <span class="n">INVALID</span> <span class="o">=</span> <span class="mf">1e300</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a>        <span class="n">progress</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_tqdm</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Backtest.optimize&#39;</span><span class="p">))</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a>        <span class="o">@</span> <span class="n">use_named_args</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">)</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a>        <span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">):</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a>            <span class="nb">next</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a>            <span class="c1"># Check constraints</span>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a>            <span class="c1"># TODO: Adjust after https://github.com/scikit-optimize/scikit-optimize/pull/971</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">constraint</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">(</span><span class="n">params</span><span class="p">)):</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a>                <span class="k">return</span> <span class="n">INVALID</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">memoized_run</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a>            <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">maximize</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a>                <span class="k">return</span> <span class="n">INVALID</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a>            <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a>        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>                <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;The objective has been evaluated at this point before.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">forest_minimize</span><span class="p">(</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>                <span class="n">func</span><span class="o">=</span><span class="n">objective_function</span><span class="p">,</span>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a>                <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a>                <span class="n">n_calls</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>                <span class="n">base_estimator</span><span class="o">=</span><span class="n">ExtraTreesRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a>                <span class="n">acq_func</span><span class="o">=</span><span class="s1">&#39;LCB&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>                <span class="n">kappa</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>                <span class="n">n_initial_points</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">max_tries</span><span class="p">,</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)),</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>                <span class="n">initial_point_generator</span><span class="o">=</span><span class="s1">&#39;lhs&#39;</span><span class="p">,</span>  <span class="c1"># &#39;sobel&#39; requires n_initial_points ~ 2**N</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>                <span class="n">callback</span><span class="o">=</span><span class="n">DeltaXStopper</span><span class="p">(</span><span class="mf">9e-7</span><span class="p">),</span>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>                <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="p">]</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>        <span class="k">if</span> <span class="n">return_heatmap</span><span class="p">:</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>            <span class="n">heatmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x_iters</span><span class="p">),</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">func_vals</span><span class="p">)),</span>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>                                <span class="n">name</span><span class="o">=</span><span class="n">maximize_key</span><span class="p">)</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>            <span class="n">heatmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>            <span class="n">heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">[</span><span class="n">heatmap</span> <span class="o">!=</span> <span class="o">-</span><span class="n">INVALID</span><span class="p">]</span>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>            <span class="n">heatmap</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>
<a id="__codelineno-0-1899" name="__codelineno-0-1899"></a>        <span class="k">if</span> <span class="n">return_optimization</span><span class="p">:</span>
<a id="__codelineno-0-1900" name="__codelineno-0-1900"></a>            <span class="n">valid</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span> <span class="o">!=</span> <span class="n">INVALID</span>
<a id="__codelineno-0-1901" name="__codelineno-0-1901"></a>            <span class="n">res</span><span class="o">.</span><span class="n">x_iters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x_iters</span><span class="p">,</span> <span class="n">valid</span><span class="p">))</span>
<a id="__codelineno-0-1902" name="__codelineno-0-1902"></a>            <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">func_vals</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
<a id="__codelineno-0-1903" name="__codelineno-0-1903"></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-0-1904" name="__codelineno-0-1904"></a>
<a id="__codelineno-0-1905" name="__codelineno-0-1905"></a>        <span class="k">return</span> <span class="n">stats</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-0-1906" name="__codelineno-0-1906"></a>
<a id="__codelineno-0-1907" name="__codelineno-0-1907"></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1908" name="__codelineno-0-1908"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">_optimize_grid</span><span class="p">()</span>
<a id="__codelineno-0-1909" name="__codelineno-0-1909"></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;skopt&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1910" name="__codelineno-0-1910"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">_optimize_skopt</span><span class="p">()</span>
<a id="__codelineno-0-1911" name="__codelineno-0-1911"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1912" name="__codelineno-0-1912"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method should be &#39;grid&#39; or &#39;skopt&#39;, not </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1913" name="__codelineno-0-1913"></a>    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Backtest.plot" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_return</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_pl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_volume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_drawdown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_trades</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smooth_equity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">superimpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse_indicators</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">open_browser</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_allocation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_allocation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Plot the progression of the last backtest run.</p>
<p>If <code>results</code> is provided, it should be a particular result
<code>pd.Series</code> such as returned by
<code>minitrade.backtest.core.backtesting.Backtest.run</code> or
<code>minitrade.backtest.core.backtesting.Backtest.optimize</code>, otherwise the last
run's results are used.</p>
<p><code>filename</code> is the path to save the interactive HTML plot to.
By default, a strategy/parameter-dependent file is created in the
current working directory.</p>
<p><code>plot_width</code> is the width of the plot in pixels. If None (default),
the plot is made to span 100% of browser width. The height is
currently non-adjustable.</p>
<p>If <code>plot_equity</code> is <code>True</code>, the resulting plot will contain
an equity (initial cash plus assets) graph section. This is the same
as <code>plot_return</code> plus initial 100%.</p>
<p>If <code>plot_return</code> is <code>True</code>, the resulting plot will contain
a cumulative return graph section. This is the same
as <code>plot_equity</code> minus initial 100%.</p>
<p>If <code>plot_pl</code> is <code>True</code>, the resulting plot will contain
a profit/loss (P/L) indicator section.</p>
<p>If <code>plot_volume</code> is <code>True</code>, the resulting plot will contain
a trade volume section.</p>
<p>If <code>plot_drawdown</code> is <code>True</code>, the resulting plot will contain
a separate drawdown graph section.</p>
<p>If <code>plot_trades</code> is <code>True</code>, the stretches between trade entries
and trade exits are marked by hash-marked tractor beams.</p>
<p>If <code>smooth_equity</code> is <code>True</code>, the equity graph will be
interpolated between fixed points at trade closing times,
unaffected by any interim asset volatility.</p>
<p>If <code>relative_equity</code> is <code>True</code>, scale and label equity graph axis
with return percent, not absolute cash-equivalent values.</p>
<p>If <code>superimpose</code> is <code>True</code>, superimpose larger-timeframe candlesticks
over the original candlestick chart. Default downsampling rule is:
monthly for daily data, daily for hourly data, hourly for minute data,
and minute for (sub-)second data.
<code>superimpose</code> can also be a valid <a href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects">Pandas offset string</a>,
such as <code>'5T'</code> or <code>'5min'</code>, in which case this frequency will be
used to superimpose.
Note, this only works for data with a datetime index.</p>
<p>If <code>resample</code> is <code>True</code>, the OHLC data is resampled in a way that
makes the upper number of candles for Bokeh to plot limited to 10_000.
This may, in situations of overabundant data,
improve plot's interactive performance and avoid browser's
<code>Javascript Error: Maximum call stack size exceeded</code> or similar.
Equity &amp; dropdown curves and individual trades data is,
likewise, <a href="lib.html#backtesting.lib.TRADES_AGG">reasonably <em>aggregated</em></a>.
<code>resample</code> can also be a <a href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects">Pandas offset string</a>,
such as <code>'5T'</code> or <code>'5min'</code>, in which case this frequency will be
used to resample, overriding above numeric limitation.
Note, all this only works for data with a datetime index.</p>
<p>If <code>reverse_indicators</code> is <code>True</code>, the indicators below the OHLC chart
are plotted in reverse order of declaration.</p>
<p>If <code>show_legend</code> is <code>True</code>, the resulting plot graphs will contain
labeled legends.</p>
<p>If <code>open_browser</code> is <code>True</code>, the resulting <code>filename</code> will be
opened in the default web browser.</p>
<p>If <code>plot_allocation</code> is <code>True</code>, the resulting plot will contain
an equity allocation graph section. </p>
<p>If <code>relative_allocation</code> is <code>True</code>, scale and label equity allocation graph axis
with return percent, not absolute cash-equivalent values.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1924">1924</a></span>
<span class="normal"><a href="#__codelineno-0-1925">1925</a></span>
<span class="normal"><a href="#__codelineno-0-1926">1926</a></span>
<span class="normal"><a href="#__codelineno-0-1927">1927</a></span>
<span class="normal"><a href="#__codelineno-0-1928">1928</a></span>
<span class="normal"><a href="#__codelineno-0-1929">1929</a></span>
<span class="normal"><a href="#__codelineno-0-1930">1930</a></span>
<span class="normal"><a href="#__codelineno-0-1931">1931</a></span>
<span class="normal"><a href="#__codelineno-0-1932">1932</a></span>
<span class="normal"><a href="#__codelineno-0-1933">1933</a></span>
<span class="normal"><a href="#__codelineno-0-1934">1934</a></span>
<span class="normal"><a href="#__codelineno-0-1935">1935</a></span>
<span class="normal"><a href="#__codelineno-0-1936">1936</a></span>
<span class="normal"><a href="#__codelineno-0-1937">1937</a></span>
<span class="normal"><a href="#__codelineno-0-1938">1938</a></span>
<span class="normal"><a href="#__codelineno-0-1939">1939</a></span>
<span class="normal"><a href="#__codelineno-0-1940">1940</a></span>
<span class="normal"><a href="#__codelineno-0-1941">1941</a></span>
<span class="normal"><a href="#__codelineno-0-1942">1942</a></span>
<span class="normal"><a href="#__codelineno-0-1943">1943</a></span>
<span class="normal"><a href="#__codelineno-0-1944">1944</a></span>
<span class="normal"><a href="#__codelineno-0-1945">1945</a></span>
<span class="normal"><a href="#__codelineno-0-1946">1946</a></span>
<span class="normal"><a href="#__codelineno-0-1947">1947</a></span>
<span class="normal"><a href="#__codelineno-0-1948">1948</a></span>
<span class="normal"><a href="#__codelineno-0-1949">1949</a></span>
<span class="normal"><a href="#__codelineno-0-1950">1950</a></span>
<span class="normal"><a href="#__codelineno-0-1951">1951</a></span>
<span class="normal"><a href="#__codelineno-0-1952">1952</a></span>
<span class="normal"><a href="#__codelineno-0-1953">1953</a></span>
<span class="normal"><a href="#__codelineno-0-1954">1954</a></span>
<span class="normal"><a href="#__codelineno-0-1955">1955</a></span>
<span class="normal"><a href="#__codelineno-0-1956">1956</a></span>
<span class="normal"><a href="#__codelineno-0-1957">1957</a></span>
<span class="normal"><a href="#__codelineno-0-1958">1958</a></span>
<span class="normal"><a href="#__codelineno-0-1959">1959</a></span>
<span class="normal"><a href="#__codelineno-0-1960">1960</a></span>
<span class="normal"><a href="#__codelineno-0-1961">1961</a></span>
<span class="normal"><a href="#__codelineno-0-1962">1962</a></span>
<span class="normal"><a href="#__codelineno-0-1963">1963</a></span>
<span class="normal"><a href="#__codelineno-0-1964">1964</a></span>
<span class="normal"><a href="#__codelineno-0-1965">1965</a></span>
<span class="normal"><a href="#__codelineno-0-1966">1966</a></span>
<span class="normal"><a href="#__codelineno-0-1967">1967</a></span>
<span class="normal"><a href="#__codelineno-0-1968">1968</a></span>
<span class="normal"><a href="#__codelineno-0-1969">1969</a></span>
<span class="normal"><a href="#__codelineno-0-1970">1970</a></span>
<span class="normal"><a href="#__codelineno-0-1971">1971</a></span>
<span class="normal"><a href="#__codelineno-0-1972">1972</a></span>
<span class="normal"><a href="#__codelineno-0-1973">1973</a></span>
<span class="normal"><a href="#__codelineno-0-1974">1974</a></span>
<span class="normal"><a href="#__codelineno-0-1975">1975</a></span>
<span class="normal"><a href="#__codelineno-0-1976">1976</a></span>
<span class="normal"><a href="#__codelineno-0-1977">1977</a></span>
<span class="normal"><a href="#__codelineno-0-1978">1978</a></span>
<span class="normal"><a href="#__codelineno-0-1979">1979</a></span>
<span class="normal"><a href="#__codelineno-0-1980">1980</a></span>
<span class="normal"><a href="#__codelineno-0-1981">1981</a></span>
<span class="normal"><a href="#__codelineno-0-1982">1982</a></span>
<span class="normal"><a href="#__codelineno-0-1983">1983</a></span>
<span class="normal"><a href="#__codelineno-0-1984">1984</a></span>
<span class="normal"><a href="#__codelineno-0-1985">1985</a></span>
<span class="normal"><a href="#__codelineno-0-1986">1986</a></span>
<span class="normal"><a href="#__codelineno-0-1987">1987</a></span>
<span class="normal"><a href="#__codelineno-0-1988">1988</a></span>
<span class="normal"><a href="#__codelineno-0-1989">1989</a></span>
<span class="normal"><a href="#__codelineno-0-1990">1990</a></span>
<span class="normal"><a href="#__codelineno-0-1991">1991</a></span>
<span class="normal"><a href="#__codelineno-0-1992">1992</a></span>
<span class="normal"><a href="#__codelineno-0-1993">1993</a></span>
<span class="normal"><a href="#__codelineno-0-1994">1994</a></span>
<span class="normal"><a href="#__codelineno-0-1995">1995</a></span>
<span class="normal"><a href="#__codelineno-0-1996">1996</a></span>
<span class="normal"><a href="#__codelineno-0-1997">1997</a></span>
<span class="normal"><a href="#__codelineno-0-1998">1998</a></span>
<span class="normal"><a href="#__codelineno-0-1999">1999</a></span>
<span class="normal"><a href="#__codelineno-0-2000">2000</a></span>
<span class="normal"><a href="#__codelineno-0-2001">2001</a></span>
<span class="normal"><a href="#__codelineno-0-2002">2002</a></span>
<span class="normal"><a href="#__codelineno-0-2003">2003</a></span>
<span class="normal"><a href="#__codelineno-0-2004">2004</a></span>
<span class="normal"><a href="#__codelineno-0-2005">2005</a></span>
<span class="normal"><a href="#__codelineno-0-2006">2006</a></span>
<span class="normal"><a href="#__codelineno-0-2007">2007</a></span>
<span class="normal"><a href="#__codelineno-0-2008">2008</a></span>
<span class="normal"><a href="#__codelineno-0-2009">2009</a></span>
<span class="normal"><a href="#__codelineno-0-2010">2010</a></span>
<span class="normal"><a href="#__codelineno-0-2011">2011</a></span>
<span class="normal"><a href="#__codelineno-0-2012">2012</a></span>
<span class="normal"><a href="#__codelineno-0-2013">2013</a></span>
<span class="normal"><a href="#__codelineno-0-2014">2014</a></span>
<span class="normal"><a href="#__codelineno-0-2015">2015</a></span>
<span class="normal"><a href="#__codelineno-0-2016">2016</a></span>
<span class="normal"><a href="#__codelineno-0-2017">2017</a></span>
<span class="normal"><a href="#__codelineno-0-2018">2018</a></span>
<span class="normal"><a href="#__codelineno-0-2019">2019</a></span>
<span class="normal"><a href="#__codelineno-0-2020">2020</a></span>
<span class="normal"><a href="#__codelineno-0-2021">2021</a></span>
<span class="normal"><a href="#__codelineno-0-2022">2022</a></span>
<span class="normal"><a href="#__codelineno-0-2023">2023</a></span>
<span class="normal"><a href="#__codelineno-0-2024">2024</a></span>
<span class="normal"><a href="#__codelineno-0-2025">2025</a></span>
<span class="normal"><a href="#__codelineno-0-2026">2026</a></span>
<span class="normal"><a href="#__codelineno-0-2027">2027</a></span>
<span class="normal"><a href="#__codelineno-0-2028">2028</a></span>
<span class="normal"><a href="#__codelineno-0-2029">2029</a></span>
<span class="normal"><a href="#__codelineno-0-2030">2030</a></span>
<span class="normal"><a href="#__codelineno-0-2031">2031</a></span>
<span class="normal"><a href="#__codelineno-0-2032">2032</a></span>
<span class="normal"><a href="#__codelineno-0-2033">2033</a></span>
<span class="normal"><a href="#__codelineno-0-2034">2034</a></span>
<span class="normal"><a href="#__codelineno-0-2035">2035</a></span>
<span class="normal"><a href="#__codelineno-0-2036">2036</a></span>
<span class="normal"><a href="#__codelineno-0-2037">2037</a></span>
<span class="normal"><a href="#__codelineno-0-2038">2038</a></span>
<span class="normal"><a href="#__codelineno-0-2039">2039</a></span>
<span class="normal"><a href="#__codelineno-0-2040">2040</a></span>
<span class="normal"><a href="#__codelineno-0-2041">2041</a></span>
<span class="normal"><a href="#__codelineno-0-2042">2042</a></span>
<span class="normal"><a href="#__codelineno-0-2043">2043</a></span>
<span class="normal"><a href="#__codelineno-0-2044">2044</a></span>
<span class="normal"><a href="#__codelineno-0-2045">2045</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1924" name="__codelineno-0-1924"></a><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1925" name="__codelineno-0-1925"></a>         <span class="n">plot_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_return</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_pl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1926" name="__codelineno-0-1926"></a>         <span class="n">plot_volume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_drawdown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_trades</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1927" name="__codelineno-0-1927"></a>         <span class="n">smooth_equity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_equity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1928" name="__codelineno-0-1928"></a>         <span class="n">superimpose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1929" name="__codelineno-0-1929"></a>         <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse_indicators</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1930" name="__codelineno-0-1930"></a>         <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">open_browser</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1931" name="__codelineno-0-1931"></a>         <span class="n">plot_allocation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative_allocation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-1932" name="__codelineno-0-1932"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1933" name="__codelineno-0-1933"></a><span class="sd">    Plot the progression of the last backtest run.</span>
<a id="__codelineno-0-1934" name="__codelineno-0-1934"></a>
<a id="__codelineno-0-1935" name="__codelineno-0-1935"></a><span class="sd">    If `results` is provided, it should be a particular result</span>
<a id="__codelineno-0-1936" name="__codelineno-0-1936"></a><span class="sd">    `pd.Series` such as returned by</span>
<a id="__codelineno-0-1937" name="__codelineno-0-1937"></a><span class="sd">    `minitrade.backtest.core.backtesting.Backtest.run` or</span>
<a id="__codelineno-0-1938" name="__codelineno-0-1938"></a><span class="sd">    `minitrade.backtest.core.backtesting.Backtest.optimize`, otherwise the last</span>
<a id="__codelineno-0-1939" name="__codelineno-0-1939"></a><span class="sd">    run&#39;s results are used.</span>
<a id="__codelineno-0-1940" name="__codelineno-0-1940"></a>
<a id="__codelineno-0-1941" name="__codelineno-0-1941"></a><span class="sd">    `filename` is the path to save the interactive HTML plot to.</span>
<a id="__codelineno-0-1942" name="__codelineno-0-1942"></a><span class="sd">    By default, a strategy/parameter-dependent file is created in the</span>
<a id="__codelineno-0-1943" name="__codelineno-0-1943"></a><span class="sd">    current working directory.</span>
<a id="__codelineno-0-1944" name="__codelineno-0-1944"></a>
<a id="__codelineno-0-1945" name="__codelineno-0-1945"></a><span class="sd">    `plot_width` is the width of the plot in pixels. If None (default),</span>
<a id="__codelineno-0-1946" name="__codelineno-0-1946"></a><span class="sd">    the plot is made to span 100% of browser width. The height is</span>
<a id="__codelineno-0-1947" name="__codelineno-0-1947"></a><span class="sd">    currently non-adjustable.</span>
<a id="__codelineno-0-1948" name="__codelineno-0-1948"></a>
<a id="__codelineno-0-1949" name="__codelineno-0-1949"></a><span class="sd">    If `plot_equity` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1950" name="__codelineno-0-1950"></a><span class="sd">    an equity (initial cash plus assets) graph section. This is the same</span>
<a id="__codelineno-0-1951" name="__codelineno-0-1951"></a><span class="sd">    as `plot_return` plus initial 100%.</span>
<a id="__codelineno-0-1952" name="__codelineno-0-1952"></a>
<a id="__codelineno-0-1953" name="__codelineno-0-1953"></a><span class="sd">    If `plot_return` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1954" name="__codelineno-0-1954"></a><span class="sd">    a cumulative return graph section. This is the same</span>
<a id="__codelineno-0-1955" name="__codelineno-0-1955"></a><span class="sd">    as `plot_equity` minus initial 100%.</span>
<a id="__codelineno-0-1956" name="__codelineno-0-1956"></a>
<a id="__codelineno-0-1957" name="__codelineno-0-1957"></a><span class="sd">    If `plot_pl` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1958" name="__codelineno-0-1958"></a><span class="sd">    a profit/loss (P/L) indicator section.</span>
<a id="__codelineno-0-1959" name="__codelineno-0-1959"></a>
<a id="__codelineno-0-1960" name="__codelineno-0-1960"></a><span class="sd">    If `plot_volume` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1961" name="__codelineno-0-1961"></a><span class="sd">    a trade volume section.</span>
<a id="__codelineno-0-1962" name="__codelineno-0-1962"></a>
<a id="__codelineno-0-1963" name="__codelineno-0-1963"></a><span class="sd">    If `plot_drawdown` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-1964" name="__codelineno-0-1964"></a><span class="sd">    a separate drawdown graph section.</span>
<a id="__codelineno-0-1965" name="__codelineno-0-1965"></a>
<a id="__codelineno-0-1966" name="__codelineno-0-1966"></a><span class="sd">    If `plot_trades` is `True`, the stretches between trade entries</span>
<a id="__codelineno-0-1967" name="__codelineno-0-1967"></a><span class="sd">    and trade exits are marked by hash-marked tractor beams.</span>
<a id="__codelineno-0-1968" name="__codelineno-0-1968"></a>
<a id="__codelineno-0-1969" name="__codelineno-0-1969"></a><span class="sd">    If `smooth_equity` is `True`, the equity graph will be</span>
<a id="__codelineno-0-1970" name="__codelineno-0-1970"></a><span class="sd">    interpolated between fixed points at trade closing times,</span>
<a id="__codelineno-0-1971" name="__codelineno-0-1971"></a><span class="sd">    unaffected by any interim asset volatility.</span>
<a id="__codelineno-0-1972" name="__codelineno-0-1972"></a>
<a id="__codelineno-0-1973" name="__codelineno-0-1973"></a><span class="sd">    If `relative_equity` is `True`, scale and label equity graph axis</span>
<a id="__codelineno-0-1974" name="__codelineno-0-1974"></a><span class="sd">    with return percent, not absolute cash-equivalent values.</span>
<a id="__codelineno-0-1975" name="__codelineno-0-1975"></a>
<a id="__codelineno-0-1976" name="__codelineno-0-1976"></a><span class="sd">    If `superimpose` is `True`, superimpose larger-timeframe candlesticks</span>
<a id="__codelineno-0-1977" name="__codelineno-0-1977"></a><span class="sd">    over the original candlestick chart. Default downsampling rule is:</span>
<a id="__codelineno-0-1978" name="__codelineno-0-1978"></a><span class="sd">    monthly for daily data, daily for hourly data, hourly for minute data,</span>
<a id="__codelineno-0-1979" name="__codelineno-0-1979"></a><span class="sd">    and minute for (sub-)second data.</span>
<a id="__codelineno-0-1980" name="__codelineno-0-1980"></a><span class="sd">    `superimpose` can also be a valid [Pandas offset string],</span>
<a id="__codelineno-0-1981" name="__codelineno-0-1981"></a><span class="sd">    such as `&#39;5T&#39;` or `&#39;5min&#39;`, in which case this frequency will be</span>
<a id="__codelineno-0-1982" name="__codelineno-0-1982"></a><span class="sd">    used to superimpose.</span>
<a id="__codelineno-0-1983" name="__codelineno-0-1983"></a><span class="sd">    Note, this only works for data with a datetime index.</span>
<a id="__codelineno-0-1984" name="__codelineno-0-1984"></a>
<a id="__codelineno-0-1985" name="__codelineno-0-1985"></a><span class="sd">    If `resample` is `True`, the OHLC data is resampled in a way that</span>
<a id="__codelineno-0-1986" name="__codelineno-0-1986"></a><span class="sd">    makes the upper number of candles for Bokeh to plot limited to 10_000.</span>
<a id="__codelineno-0-1987" name="__codelineno-0-1987"></a><span class="sd">    This may, in situations of overabundant data,</span>
<a id="__codelineno-0-1988" name="__codelineno-0-1988"></a><span class="sd">    improve plot&#39;s interactive performance and avoid browser&#39;s</span>
<a id="__codelineno-0-1989" name="__codelineno-0-1989"></a><span class="sd">    `Javascript Error: Maximum call stack size exceeded` or similar.</span>
<a id="__codelineno-0-1990" name="__codelineno-0-1990"></a><span class="sd">    Equity &amp; dropdown curves and individual trades data is,</span>
<a id="__codelineno-0-1991" name="__codelineno-0-1991"></a><span class="sd">    likewise, [reasonably _aggregated_][TRADES_AGG].</span>
<a id="__codelineno-0-1992" name="__codelineno-0-1992"></a><span class="sd">    `resample` can also be a [Pandas offset string],</span>
<a id="__codelineno-0-1993" name="__codelineno-0-1993"></a><span class="sd">    such as `&#39;5T&#39;` or `&#39;5min&#39;`, in which case this frequency will be</span>
<a id="__codelineno-0-1994" name="__codelineno-0-1994"></a><span class="sd">    used to resample, overriding above numeric limitation.</span>
<a id="__codelineno-0-1995" name="__codelineno-0-1995"></a><span class="sd">    Note, all this only works for data with a datetime index.</span>
<a id="__codelineno-0-1996" name="__codelineno-0-1996"></a>
<a id="__codelineno-0-1997" name="__codelineno-0-1997"></a><span class="sd">    If `reverse_indicators` is `True`, the indicators below the OHLC chart</span>
<a id="__codelineno-0-1998" name="__codelineno-0-1998"></a><span class="sd">    are plotted in reverse order of declaration.</span>
<a id="__codelineno-0-1999" name="__codelineno-0-1999"></a>
<a id="__codelineno-0-2000" name="__codelineno-0-2000"></a><span class="sd">    [Pandas offset string]: \</span>
<a id="__codelineno-0-2001" name="__codelineno-0-2001"></a><span class="sd">        https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects</span>
<a id="__codelineno-0-2002" name="__codelineno-0-2002"></a>
<a id="__codelineno-0-2003" name="__codelineno-0-2003"></a><span class="sd">    [TRADES_AGG]: lib.html#backtesting.lib.TRADES_AGG</span>
<a id="__codelineno-0-2004" name="__codelineno-0-2004"></a>
<a id="__codelineno-0-2005" name="__codelineno-0-2005"></a><span class="sd">    If `show_legend` is `True`, the resulting plot graphs will contain</span>
<a id="__codelineno-0-2006" name="__codelineno-0-2006"></a><span class="sd">    labeled legends.</span>
<a id="__codelineno-0-2007" name="__codelineno-0-2007"></a>
<a id="__codelineno-0-2008" name="__codelineno-0-2008"></a><span class="sd">    If `open_browser` is `True`, the resulting `filename` will be</span>
<a id="__codelineno-0-2009" name="__codelineno-0-2009"></a><span class="sd">    opened in the default web browser.</span>
<a id="__codelineno-0-2010" name="__codelineno-0-2010"></a>
<a id="__codelineno-0-2011" name="__codelineno-0-2011"></a><span class="sd">    If `plot_allocation` is `True`, the resulting plot will contain</span>
<a id="__codelineno-0-2012" name="__codelineno-0-2012"></a><span class="sd">    an equity allocation graph section. </span>
<a id="__codelineno-0-2013" name="__codelineno-0-2013"></a>
<a id="__codelineno-0-2014" name="__codelineno-0-2014"></a><span class="sd">    If `relative_allocation` is `True`, scale and label equity allocation graph axis</span>
<a id="__codelineno-0-2015" name="__codelineno-0-2015"></a><span class="sd">    with return percent, not absolute cash-equivalent values.</span>
<a id="__codelineno-0-2016" name="__codelineno-0-2016"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-2017" name="__codelineno-0-2017"></a>    <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-2018" name="__codelineno-0-2018"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-2019" name="__codelineno-0-2019"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;First issue `backtest.run()` to obtain results.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-2020" name="__codelineno-0-2020"></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span>
<a id="__codelineno-0-2021" name="__codelineno-0-2021"></a>
<a id="__codelineno-0-2022" name="__codelineno-0-2022"></a>    <span class="n">indicators</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">_indicators</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">_registers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-2023" name="__codelineno-0-2023"></a>
<a id="__codelineno-0-2024" name="__codelineno-0-2024"></a>    <span class="k">return</span> <span class="n">plot</span><span class="p">(</span>
<a id="__codelineno-0-2025" name="__codelineno-0-2025"></a>        <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span>
<a id="__codelineno-0-2026" name="__codelineno-0-2026"></a>        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
<a id="__codelineno-0-2027" name="__codelineno-0-2027"></a>        <span class="n">baseline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ohlc_ref_data</span><span class="p">,</span>
<a id="__codelineno-0-2028" name="__codelineno-0-2028"></a>        <span class="n">indicators</span><span class="o">=</span><span class="n">indicators</span><span class="p">,</span>
<a id="__codelineno-0-2029" name="__codelineno-0-2029"></a>        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
<a id="__codelineno-0-2030" name="__codelineno-0-2030"></a>        <span class="n">plot_width</span><span class="o">=</span><span class="n">plot_width</span><span class="p">,</span>
<a id="__codelineno-0-2031" name="__codelineno-0-2031"></a>        <span class="n">plot_equity</span><span class="o">=</span><span class="n">plot_equity</span><span class="p">,</span>
<a id="__codelineno-0-2032" name="__codelineno-0-2032"></a>        <span class="n">plot_return</span><span class="o">=</span><span class="n">plot_return</span><span class="p">,</span>
<a id="__codelineno-0-2033" name="__codelineno-0-2033"></a>        <span class="n">plot_pl</span><span class="o">=</span><span class="n">plot_pl</span><span class="p">,</span>
<a id="__codelineno-0-2034" name="__codelineno-0-2034"></a>        <span class="n">plot_volume</span><span class="o">=</span><span class="n">plot_volume</span><span class="p">,</span>
<a id="__codelineno-0-2035" name="__codelineno-0-2035"></a>        <span class="n">plot_drawdown</span><span class="o">=</span><span class="n">plot_drawdown</span><span class="p">,</span>
<a id="__codelineno-0-2036" name="__codelineno-0-2036"></a>        <span class="n">plot_trades</span><span class="o">=</span><span class="n">plot_trades</span><span class="p">,</span>
<a id="__codelineno-0-2037" name="__codelineno-0-2037"></a>        <span class="n">smooth_equity</span><span class="o">=</span><span class="n">smooth_equity</span><span class="p">,</span>
<a id="__codelineno-0-2038" name="__codelineno-0-2038"></a>        <span class="n">relative_equity</span><span class="o">=</span><span class="n">relative_equity</span><span class="p">,</span>
<a id="__codelineno-0-2039" name="__codelineno-0-2039"></a>        <span class="n">superimpose</span><span class="o">=</span><span class="n">superimpose</span><span class="p">,</span>
<a id="__codelineno-0-2040" name="__codelineno-0-2040"></a>        <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
<a id="__codelineno-0-2041" name="__codelineno-0-2041"></a>        <span class="n">reverse_indicators</span><span class="o">=</span><span class="n">reverse_indicators</span><span class="p">,</span>
<a id="__codelineno-0-2042" name="__codelineno-0-2042"></a>        <span class="n">show_legend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span>
<a id="__codelineno-0-2043" name="__codelineno-0-2043"></a>        <span class="n">open_browser</span><span class="o">=</span><span class="n">open_browser</span><span class="p">,</span>
<a id="__codelineno-0-2044" name="__codelineno-0-2044"></a>        <span class="n">plot_allocation</span><span class="o">=</span><span class="n">plot_allocation</span><span class="p">,</span>
<a id="__codelineno-0-2045" name="__codelineno-0-2045"></a>        <span class="n">relative_allocation</span><span class="o">=</span><span class="n">relative_allocation</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Backtest.run" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Run the backtest. Returns <code>pd.Series</code> with results and statistics.</p>
<p>Keyword arguments are interpreted as strategy parameters.</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; Backtest(GOOG, SmaCross).run()
Start                     2004-08-19 00:00:00
End                       2013-03-01 00:00:00
Duration                   3116 days 00:00:00
Exposure Time [%]                     93.9944
Equity Final [$]                      51959.9
Equity Peak [$]                       75787.4
Return [%]                            419.599
Buy &amp; Hold Return [%]                 703.458
Return (Ann.) [%]                      21.328
Volatility (Ann.) [%]                 36.5383
Sharpe Ratio                         0.583718
Sortino Ratio                         1.09239
Calmar Ratio                         0.444518
Max. Drawdown [%]                    -47.9801
Avg. Drawdown [%]                    -5.92585
Max. Drawdown Duration      584 days 00:00:00
Avg. Drawdown Duration       41 days 00:00:00
# Trades                                   65
Win Rate [%]                          46.1538
Best Trade [%]                         53.596
Worst Trade [%]                      -18.3989
Avg. Trade [%]                        2.35371
Max. Trade Duration         183 days 00:00:00
Avg. Trade Duration          46 days 00:00:00
Profit Factor                         2.08802
Expectancy [%]                        8.79171
SQN                                  0.916893
Kelly Criterion                        0.6134
_strategy                            SmaCross
_equity_curve                           Eq...
_trades                       Size  EntryB...
_orders                              Ticke...
_positions                           {&#39;GOO...
dtype: object
</code></pre></div>
<p>.. warning::
    You may obtain different results for different strategy parameters.
    E.g. if you use 50- and 200-bar SMA, the trading simulation will
    begin on bar 201. The actual length of delay is equal to the lookback
    period of the <code>Strategy.I</code> indicator which lags the most.
    Obviously, this can affect results.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span>
<span class="normal"><a href="#__codelineno-0-1569">1569</a></span>
<span class="normal"><a href="#__codelineno-0-1570">1570</a></span>
<span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span>
<span class="normal"><a href="#__codelineno-0-1589">1589</a></span>
<span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1481" name="__codelineno-0-1481"></a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a><span class="sd">    Run the backtest. Returns `pd.Series` with results and statistics.</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a><span class="sd">    Keyword arguments are interpreted as strategy parameters.</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a><span class="sd">        &gt;&gt;&gt; Backtest(GOOG, SmaCross).run()</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a><span class="sd">        Start                     2004-08-19 00:00:00</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a><span class="sd">        End                       2013-03-01 00:00:00</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a><span class="sd">        Duration                   3116 days 00:00:00</span>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a><span class="sd">        Exposure Time [%]                     93.9944</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a><span class="sd">        Equity Final [$]                      51959.9</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a><span class="sd">        Equity Peak [$]                       75787.4</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a><span class="sd">        Return [%]                            419.599</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a><span class="sd">        Buy &amp; Hold Return [%]                 703.458</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a><span class="sd">        Return (Ann.) [%]                      21.328</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a><span class="sd">        Volatility (Ann.) [%]                 36.5383</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a><span class="sd">        Sharpe Ratio                         0.583718</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a><span class="sd">        Sortino Ratio                         1.09239</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a><span class="sd">        Calmar Ratio                         0.444518</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a><span class="sd">        Max. Drawdown [%]                    -47.9801</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a><span class="sd">        Avg. Drawdown [%]                    -5.92585</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a><span class="sd">        Max. Drawdown Duration      584 days 00:00:00</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a><span class="sd">        Avg. Drawdown Duration       41 days 00:00:00</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a><span class="sd">        # Trades                                   65</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a><span class="sd">        Win Rate [%]                          46.1538</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a><span class="sd">        Best Trade [%]                         53.596</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a><span class="sd">        Worst Trade [%]                      -18.3989</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a><span class="sd">        Avg. Trade [%]                        2.35371</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a><span class="sd">        Max. Trade Duration         183 days 00:00:00</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a><span class="sd">        Avg. Trade Duration          46 days 00:00:00</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a><span class="sd">        Profit Factor                         2.08802</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a><span class="sd">        Expectancy [%]                        8.79171</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a><span class="sd">        SQN                                  0.916893</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a><span class="sd">        Kelly Criterion                        0.6134</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a><span class="sd">        _strategy                            SmaCross</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a><span class="sd">        _equity_curve                           Eq...</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a><span class="sd">        _trades                       Size  EntryB...</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a><span class="sd">        _orders                              Ticke...</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a><span class="sd">        _positions                           {&#39;GOO...</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a><span class="sd">        dtype: object</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a><span class="sd">    .. warning::</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a><span class="sd">        You may obtain different results for different strategy parameters.</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a><span class="sd">        E.g. if you use 50- and 200-bar SMA, the trading simulation will</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a><span class="sd">        begin on bar 201. The actual length of delay is equal to the lookback</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a><span class="sd">        period of the `Strategy.I` indicator which lags the most.</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a><span class="sd">        Obviously, this can affect results.</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">_Data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>    <span class="n">broker</span><span class="p">:</span> <span class="n">_Broker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>    <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="p">(</span><span class="n">broker</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>    <span class="n">processed_orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>    <span class="n">final_positions</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>        <span class="n">strategy</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Strategy initialization throws exception&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>        <span class="k">return</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>    <span class="c1"># Indicators used in Strategy.next()</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>    <span class="n">indicator_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">indicator</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a>                       <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">indicator</span> <span class="ow">is</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">strategy</span><span class="o">.</span><span class="n">_indicators</span><span class="p">])}</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a>    <span class="c1"># Skip first few candles where indicators are still &quot;warming up&quot;</span>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a>    <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">indicator</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indicator</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a>                 <span class="k">else</span> <span class="n">indicator</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a>    <span class="c1"># Preprocess indicators to numpy array for better performance</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a>    <span class="k">def</span> <span class="nf">deframe</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">df</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>    <span class="n">indicator_attrs_np</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">deframe</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a>    <span class="c1"># Disable &quot;invalid value encountered in ...&quot; warnings. Comparison</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a>    <span class="c1"># np.nan &gt;= 3 is not invalid; it&#39;s False.</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)):</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>            <span class="c1"># Prepare data and indicators for `next` call</span>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>            <span class="n">data</span><span class="o">.</span><span class="n">_set_length</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicator_attrs_np</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>                <span class="nb">setattr</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>                        <span class="n">_Indicator</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">indicator</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">df</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">indicator_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>            <span class="c1"># Handle orders processing and broker stuff</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>                <span class="n">broker</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<a id="__codelineno-0-1569" name="__codelineno-0-1569"></a>            <span class="k">except</span> <span class="n">_OutOfMoneyError</span><span class="p">:</span>
<a id="__codelineno-0-1570" name="__codelineno-0-1570"></a>                <span class="k">break</span>
<a id="__codelineno-0-1571" name="__codelineno-0-1571"></a>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a>            <span class="c1"># Next tick, a moment before bar close</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a>            <span class="n">strategy</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a>            <span class="c1"># take note of the orders generated</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a>            <span class="n">processed_orders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a>            <span class="c1"># take note of the final positions</span>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>            <span class="n">final_positions</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a>                <span class="n">t</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">broker</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="o">|</span> <span class="p">{</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>                <span class="s1">&#39;Margin&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">margin_available</span><span class="p">)}</span>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a>            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">):</span>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a>                <span class="n">broker</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a>        <span class="c1"># Set data back to full length</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>        <span class="c1"># for future `indicator._opts[&#39;data&#39;].index` calls to work</span>
<a id="__codelineno-0-1589" name="__codelineno-0-1589"></a>        <span class="n">data</span><span class="o">.</span><span class="n">_set_length</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">))</span>
<a id="__codelineno-0-1590" name="__codelineno-0-1590"></a>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a>        <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">_equity</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a>                              <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Equity&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span> <span class="s1">&#39;Margin&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">_cash</span><span class="p">)</span>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a>        <span class="c1"># equal weighed average, as if buy and hold an equal weighed portfolio</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a>        <span class="n">weighted_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a>        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a>            <span class="n">weighted_data</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_data</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a>        <span class="n">weighted_data</span> <span class="o">=</span> <span class="n">weighted_data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ohlc_ref_data</span> <span class="o">=</span> <span class="n">weighted_data</span>
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">(</span>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a>            <span class="n">orders</span><span class="o">=</span><span class="n">processed_orders</span><span class="p">,</span>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a>            <span class="n">trades</span><span class="o">=</span><span class="n">broker</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">,</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a>            <span class="n">equity</span><span class="o">=</span><span class="n">equity</span><span class="p">,</span>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>            <span class="n">ohlc_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ohlc_ref_data</span><span class="p">,</span>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a>            <span class="n">risk_free_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a>            <span class="n">strategy_instance</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>            <span class="n">positions</span><span class="o">=</span><span class="n">final_positions</span><span class="p">,</span>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a>        <span class="p">)</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h3 id="minitrade.backtest.core.backtesting.Order" class="doc doc-heading">
          <code>Order</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>Place new orders through <code>Strategy.buy()</code> and <code>Strategy.sell()</code>.
Query existing orders through <code>Strategy.orders</code>.</p>
<p>When an order is executed or <a href="https://www.investopedia.com/terms/f/fill.asp">filled</a>, it results in a <code>Trade</code>.</p>
<p>If you wish to modify aspects of a placed but not yet filled order,
cancel it and place a new one instead.</p>
<p>All placed orders are <a href="https://www.investopedia.com/terms/g/gtc.asp">Good 'Til Canceled</a>.</p>

            <details class="quote">
              <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">    Place new orders through `Strategy.buy()` and `Strategy.sell()`.</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><span class="sd">    Query existing orders through `Strategy.orders`.</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">    When an order is executed or [filled], it results in a `Trade`.</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">    If you wish to modify aspects of a placed but not yet filled order,</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">    cancel it and place a new one instead.</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a><span class="sd">    All placed orders are [Good &#39;Til Canceled].</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a><span class="sd">    [filled]: https://www.investopedia.com/terms/f/fill.asp</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a><span class="sd">    [Good &#39;Til Canceled]: https://www.investopedia.com/terms/g/gtc.asp</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="s1">&#39;_Broker&#39;</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                 <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                 <span class="n">size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                 <span class="n">limit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                 <span class="n">stop_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                 <span class="n">sl_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                 <span class="n">tp_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                 <span class="n">parent_trade</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;Trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                 <span class="n">entry_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                 <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">broker</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span> <span class="o">=</span> <span class="n">ticker</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>        <span class="k">assert</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">size</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__limit_price</span> <span class="o">=</span> <span class="n">limit_price</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__stop_price</span> <span class="o">=</span> <span class="n">stop_price</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__sl_price</span> <span class="o">=</span> <span class="n">sl_price</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__tp_price</span> <span class="o">=</span> <span class="n">tp_price</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span> <span class="o">=</span> <span class="n">parent_trade</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__entry_time</span> <span class="o">=</span> <span class="n">entry_time</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span> <span class="o">=</span> <span class="n">tag</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;Order </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="si">}</span><span class="s1"> </span><span class="se">{{}}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                                                                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                                                                    <span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">),</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                                                                    <span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__limit_price</span><span class="p">),</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                                                                    <span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stop_price</span><span class="p">),</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                                                                    <span class="p">(</span><span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_price</span><span class="p">),</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                                                                    <span class="p">(</span><span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_price</span><span class="p">),</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                                                                    <span class="p">(</span><span class="s1">&#39;contingent&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_contingent</span><span class="p">),</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                                                                <span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel the order.&quot;&quot;&quot;</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>        <span class="n">trade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="k">if</span> <span class="n">trade</span><span class="p">:</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>            <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="p">:</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                <span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">sl_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>            <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="p">:</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                <span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">tp_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                <span class="c1"># XXX: https://github.com/kernc/backtesting.py/issues/251#issuecomment-835634984 ???</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                <span class="k">assert</span> <span class="kc">False</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>    <span class="c1"># Fields getters</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>    <span class="k">def</span> <span class="nf">ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="sd">        Order size (negative for short orders).</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a><span class="sd">        If size is a value between 0 and 1, it is interpreted as a fraction of current</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">        available liquidity (cash plus `Position.pl` minus used margin).</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">        A value greater than or equal to 1 indicates an absolute number of units.</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>    <span class="nd">@size</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Setter of order size &quot;&quot;&quot;</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">size</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">        Order limit price for [limit orders], or None for [market orders],</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="sd">        which are filled at next available price.</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">        [limit orders]: https://www.investopedia.com/terms/l/limitorder.asp</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><span class="sd">        [market orders]: https://www.investopedia.com/terms/m/marketorder.asp</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__limit_price</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        Order stop price for [stop-limit/stop-market][_] order,</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">        otherwise None if no stop was set, or the stop price has already been hit.</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">        [_]: https://www.investopedia.com/terms/s/stoporder.asp</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stop_price</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a><span class="sd">        A stop-loss price at which, if set, a new contingent stop-market order</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">        will be placed upon the `Trade` following this order&#39;s execution.</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="sd">        See also `Trade.sl`.</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_price</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a><span class="sd">        A take-profit price at which, if set, a new contingent limit order</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="sd">        will be placed upon the `Trade` following this order&#39;s execution.</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="sd">        See also `Trade.tp`.</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_price</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="k">def</span> <span class="nf">parent_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="sd">        Arbitrary value (such as a string) which, if set, enables tracking</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a><span class="sd">        of this order and the associated `Trade` (see `Trade.tag`).</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>    <span class="n">__pdoc__</span><span class="p">[</span><span class="s1">&#39;Order.parent_trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>    <span class="c1"># Extra properties</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>    <span class="k">def</span> <span class="nf">is_long</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the order is long (order size is positive).&quot;&quot;&quot;</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>    <span class="k">def</span> <span class="nf">is_short</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the order is short (order size is negative).&quot;&quot;&quot;</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">&lt;</span> <span class="mi">0</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>    <span class="k">def</span> <span class="nf">is_contingent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><span class="sd">        True for [contingent] orders, i.e. [OCO] stop-loss and take-profit bracket orders</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="sd">        placed upon an active trade. Remaining contingent orders are canceled when</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a><span class="sd">        their parent `Trade` is closed.</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a><span class="sd">        You can modify contingent orders through `Trade.sl` and `Trade.tp`.</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a><span class="sd">        [contingent]: https://www.investopedia.com/terms/c/contingentorder.asp</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a><span class="sd">        [OCO]: https://www.investopedia.com/terms/o/oco.asp</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span><span class="p">)</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>    <span class="k">def</span> <span class="nf">entry_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Time of when the order is created.&quot;&quot;&quot;</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_time</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.entry_time" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">entry_time</span><span class="p">:</span> <span class="n">datetime</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Time of when the order is created.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.is_contingent" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_contingent</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True for <a href="https://www.investopedia.com/terms/c/contingentorder.asp">contingent</a> orders, i.e. <a href="https://www.investopedia.com/terms/o/oco.asp">OCO</a> stop-loss and take-profit bracket orders
placed upon an active trade. Remaining contingent orders are canceled when
their parent <code>Trade</code> is closed.</p>
<p>You can modify contingent orders through <code>Trade.sl</code> and <code>Trade.tp</code>.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.is_long" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_long</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True if the order is long (order size is positive).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.is_short" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_short</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True if the order is short (order size is negative).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.limit" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Order limit price for <a href="https://www.investopedia.com/terms/l/limitorder.asp">limit orders</a>, or None for <a href="https://www.investopedia.com/terms/m/marketorder.asp">market orders</a>,
which are filled at next available price.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.size" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">size</span><span class="p">:</span> <span class="nb">float</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Order size (negative for short orders).</p>
<p>If size is a value between 0 and 1, it is interpreted as a fraction of current
available liquidity (cash plus <code>Position.pl</code> minus used margin).
A value greater than or equal to 1 indicates an absolute number of units.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.sl" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>A stop-loss price at which, if set, a new contingent stop-market order
will be placed upon the <code>Trade</code> following this order's execution.
See also <code>Trade.sl</code>.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.stop" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Order stop price for <a href="https://www.investopedia.com/terms/s/stoporder.asp">stop-limit/stop-market</a> order,
otherwise None if no stop was set, or the stop price has already been hit.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.tag" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tag</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Arbitrary value (such as a string) which, if set, enables tracking
of this order and the associated <code>Trade</code> (see <code>Trade.tag</code>).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Order.tp" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>A take-profit price at which, if set, a new contingent limit order
will be placed upon the <code>Trade</code> following this order's execution.
See also <code>Trade.tp</code>.</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Order.cancel" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cancel</span><span class="p">()</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Cancel the order.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-611" name="__codelineno-0-611"></a><span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cancel the order.&quot;&quot;&quot;</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>    <span class="n">trade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parent_trade</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>    <span class="k">if</span> <span class="n">trade</span><span class="p">:</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">trade</span><span class="o">.</span><span class="n">_sl_order</span><span class="p">:</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>            <span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">sl_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="k">elif</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">trade</span><span class="o">.</span><span class="n">_tp_order</span><span class="p">:</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>            <span class="n">trade</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">tp_order</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="c1"># XXX: https://github.com/kernc/backtesting.py/issues/251#issuecomment-835634984 ???</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>            <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h3 id="minitrade.backtest.core.backtesting.Position" class="doc doc-heading">
          <code>Position</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>Currently held asset position, available as
<code>minitrade.backtest.core.backtesting.Strategy.position</code> within
<code>minitrade.backtest.core.backtesting.Strategy.next</code>.
Can be used in boolean contexts, e.g.</p>
<div class="highlight"><pre><span></span><code>if self.position():
    ...  # we have a position, either long or short
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="k">class</span> <span class="nc">Position</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">    Currently held asset position, available as</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">    `minitrade.backtest.core.backtesting.Strategy.position` within</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">    `minitrade.backtest.core.backtesting.Strategy.next`.</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">    Can be used in boolean contexts, e.g.</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="sd">        if self.position():</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">            ...  # we have a position, either long or short</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="s1">&#39;_Broker&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">broker</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span> <span class="o">=</span> <span class="n">ticker</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Position size in units of asset. Negative if position is short.&quot;&quot;&quot;</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">])</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>    <span class="k">def</span> <span class="nf">pl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Profit (positive) or loss (negative) of the current position in cash units.&quot;&quot;&quot;</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">pl</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">])</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="k">def</span> <span class="nf">pl_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Profit (positive) or loss (negative) of the current position in percent.&quot;&quot;&quot;</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">]])</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="n">pl_pcts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trade</span><span class="o">.</span><span class="n">pl_pct</span> <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">]])</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">pl_pcts</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="k">def</span> <span class="nf">is_long</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the position is long (position size is positive).&quot;&quot;&quot;</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>    <span class="k">def</span> <span class="nf">is_short</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the position is short (position size is negative).&quot;&quot;&quot;</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">        Close portion of position by closing `portion` of each active trade. See `Trade.close`.</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">]:</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>            <span class="n">trade</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">portion</span><span class="p">)</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;Position: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">])</span><span class="si">}</span><span class="s1"> trades)&gt;&#39;</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Position.is_long" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_long</span><span class="p">:</span> <span class="nb">bool</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True if the position is long (position size is positive).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Position.is_short" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_short</span><span class="p">:</span> <span class="nb">bool</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True if the position is short (position size is negative).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Position.pl" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pl</span><span class="p">:</span> <span class="nb">float</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Profit (positive) or loss (negative) of the current position in cash units.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Position.pl_pct" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pl_pct</span><span class="p">:</span> <span class="nb">float</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Profit (positive) or loss (negative) of the current position in percent.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Position.size" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">size</span><span class="p">:</span> <span class="nb">float</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Position size in units of asset. Negative if position is short.</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Position.close" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">close</span><span class="p">(</span><span class="n">portion</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Close portion of position by closing <code>portion</code> of each active trade. See <code>Trade.close</code>.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">    Close portion of position by closing `portion` of each active trade. See `Trade.close`.</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>    <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">]:</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="n">trade</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">portion</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h3 id="minitrade.backtest.core.backtesting.Strategy" class="doc doc-heading">
          <code>Strategy</code>


</h3>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>A trading strategy base class. Extend this class and
override methods
<code>minitrade.backtest.core.backtesting.Strategy.init</code> and
<code>minitrade.backtest.core.backtesting.Strategy.next</code> to define
your own strategy.</p>

            <details class="quote">
              <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="k">class</span> <span class="nc">Strategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">    A trading strategy base class. Extend this class and</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">    override methods</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">    `minitrade.backtest.core.backtesting.Strategy.init` and</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">    `minitrade.backtest.core.backtesting.Strategy.next` to define</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">    your own strategy.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="p">:</span> <span class="n">_Broker</span> <span class="o">=</span> <span class="n">broker</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">_Data</span> <span class="o">=</span> <span class="n">data</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_alloc</span> <span class="o">=</span> <span class="n">Allocation</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data_index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="k">return</span> <span class="s1">&#39;&lt;Strategy &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                                                        <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">params</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}{</span><span class="n">params</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="k">def</span> <span class="nf">_check_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                    <span class="sa">f</span><span class="s2">&quot;Strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; is missing parameter &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                    <span class="s2">&quot;Strategy class should define parameters as class variables before they &quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="s2">&quot;can be optimized or run with.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">return</span> <span class="n">params</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># noqa: E743</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>          <span class="n">funcval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">Callable</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>          <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>          <span class="o">**</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">        Declare an indicator. An indicator is just an array of values,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">        but one that is revealed gradually in</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">        `minitrade.backtest.core.backtesting.Strategy.next` much like</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">        `minitrade.backtest.core.backtesting.Strategy.data` is.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">        Returns DataFrame in `init()` and `np.ndarray` of indicator values in `next()`.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">        `funcval` is either a function that returns the indicator array(s) of</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">        same length as `minitrade.backtest.core.backtesting.Strategy.data`, or</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        the indicator array(s) itself as a DataFrame, Series, or arrays.</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">        In the plot legend, the indicator is labeled with function name, </span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">        DataFrame column name, or Series name, unless `name` overrides it.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        If `plot` is `True`, the indicator is plotted on the resulting</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        `minitrade.backtest.core.backtesting.Backtest.plot`.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        If `overlay` is `True`, the indicator is plotted overlaying the</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        price candlestick chart (suitable e.g. for moving averages).</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        If `False`, the indicator is plotted standalone below the</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        candlestick chart. </span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        `color` can be string hex RGB triplet or X11 color name.</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">        By default, the next available color is assigned.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        If `scatter` is `True`, the plotted indicator marker will be a</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        circle instead of a connected line segment (default).</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        Additional `*args` and `**kwargs` are passed to `func` and can</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        be used for parameters.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        For example, using simple moving average function from TA-Lib:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">            def init():</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">                self.sma = self.I(ta.SMA, self.data.Close, self.n_sma)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">funcval</span><span class="p">):</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">chain</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="n">func_name</span> <span class="o">=</span> <span class="n">_as_str</span><span class="p">(</span><span class="n">funcval</span><span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">params</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                                   <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">funcval</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Indicator &quot;</span><span class="si">{</span><span class="n">funcval</span><span class="si">}</span><span class="s1">&quot; error&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">funcval</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                    <span class="s1">&#39;Indicators of pd.DataFrame or pd.Series must have the same index as&#39;</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                    <span class="sa">f</span><span class="s1">&#39; `data` (data shape: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span><span class="si">}</span><span class="s1">; indicator shape: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                    <span class="sa">f</span><span class="s1">&#39;`data` index: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                    <span class="sa">f</span><span class="s1">&#39;Indicator index: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">try_</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">is_arraylike</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="c1"># Optionally flip the array if the long side of array is not on the 1st dimension</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="k">if</span> <span class="n">is_arraylike</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_arraylike</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">Close</span><span class="p">):</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                    <span class="s1">&#39;Indicators of numpy.ndarray must have the same &#39;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                    <span class="sa">f</span><span class="s1">&#39;length as `data` (data shape: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span><span class="si">}</span><span class="s1">; indicator &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="sa">f</span><span class="s1">&#39;shape: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;shape&quot;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">, returned value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="c1"># Use an experimental feature to save DataFrame/Series metadata</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="c1"># https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.attrs.html</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">value</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="n">plot</span><span class="p">,</span> <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                           <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="n">scatter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">        Initialize the strategy.</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">        Override this method.</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">        Declare indicators (with `minitrade.backtest.core.backtesting.Strategy.I`).</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        Precompute what needs to be precomputed or can be precomputed</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">        in a vectorized fashion before the strategy starts.</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">        If you extend composable strategies from `minitrade.backtest.core.backtesting.lib`,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">        make sure to call: `super().init()`</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">        Main strategy runtime method, called as each new</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">        `minitrade.backtest.core.backtesting.Strategy.data`</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">        instance (row; full candlestick bar) becomes available.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        This is the main method where strategy decisions</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">        upon data precomputed in `minitrade.backtest.core.backtesting.Strategy.init`</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        take place.</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">        If you extend composable strategies from `minitrade.backtest.core.backtesting.lib`,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        make sure to call: `super().next()`</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">class</span> <span class="nc">__FULL_EQUITY</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>  <span class="c1"># noqa: N801</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;.9999&#39;</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="n">_FULL_EQUITY</span> <span class="o">=</span> <span class="n">__FULL_EQUITY</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="n">size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_FULL_EQUITY</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>            <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">        Place a new long order. For explanation of parameters, see `Order` and its properties.</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">        For single asset strategy, `ticker` can be left as None.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">        See `Position.close()` and `Trade.close()` for closing existing positions.</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">        See also `Strategy.sell()`.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">,</span> \
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="s2">&quot;size must be a positive fraction of equity, or a positive whole number of units&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>             <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>             <span class="n">size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_FULL_EQUITY</span><span class="p">,</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>             <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>             <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>             <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>             <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>             <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">        Place a new short order. For explanation of parameters, see `Order` and its properties.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">        For single asset strategy, `ticker` can be left as None.</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        See also `Strategy.buy()`.</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">        .. note::</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">            If you merely want to close an existing long position,</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">            use `Position.close()` or `Trade.close()`.</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">,</span> \
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="s2">&quot;size must be a positive fraction of equity, or a positive whole number of units&quot;</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">def</span> <span class="nf">rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">atol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        Rebalance the portfolio according to the current allocation plan.</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">            force: If True, rebalance will be performed even if the current allocation</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">                is the same as that of last cycle.</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">            rtol: Relative tolerance of the difference between current and previous</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">                allocation in term of total absolute value difference relative to total </span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">                portfolio value. If the difference is smaller than `rtol`, rebalance will</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">                not be performed.</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">            atol: Absolute tolerance of the difference between current and previous</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">                allocation in term of total absolute value difference. If the difference </span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">                is smaller than `atol`, rebalance will not be performed.</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">rebalance</span><span class="p">(</span><span class="n">alloc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alloc</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">        Record arbitrary key-value pairs as time series, which can be plotted later.</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        Value can be a scalar or a dict or a pd.Series.</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">:</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_index</span><span class="p">)</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">k</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="n">plot</span><span class="p">,</span> <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                                             <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="n">scatter</span><span class="p">})</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="k">def</span> <span class="nf">equity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Current account equity (cash plus assets).&quot;&quot;&quot;</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">equity</span><span class="p">()</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Data</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="sd">        Price data, roughly as passed into</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="sd">        `minitrade.backtest.core.backtesting.Backtest.__init__`,</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="sd">        but with two significant exceptions:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">        * `data` is _not_ a DataFrame, but a custom structure</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">          that serves customized numpy arrays for reasons of performance</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">          and convenience. Besides OHLCV columns, `.index` and length,</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">          it offers `.pip` property, the smallest price unit of change.</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">        * Within `minitrade.backtest.core.backtesting.Strategy.init`, `data` arrays</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">          are available in full length, as passed into</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">          `minitrade.backtest.core.backtesting.Backtest.__init__`</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">          (for precomputing indicators and such). However, within</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">          `minitrade.backtest.core.backtesting.Strategy.next`, `data` arrays are</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">          only as long as the current iteration, simulating gradual</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">          price point revelation. In each call of</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">          `minitrade.backtest.core.backtesting.Strategy.next` (iteratively called by</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">          `minitrade.backtest.core.backtesting.Backtest` internally),</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">          the last array value (e.g. `data.Close[-1]`)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">          is always the _most recent_ value.</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">        * If you need data arrays (e.g. `data.Close`) to be indexed</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">          **Pandas Series or DataFrame**, you can call their `.df` accessor</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">          (e.g. `data.Close.df`). If you need the whole of data</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">          as a **DataFrame**, use `.df` accessor (i.e. `data.df`).</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Position&#39;</span><span class="p">:</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Instance of `minitrade.backtest.core.backtesting.Position`.</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">        For single asset strategy, `ticker` can be left as None, which returns</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">        the position of the only asset.</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">the_ticker</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="k">def</span> <span class="nf">orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;List[Order]&#39;</span><span class="p">:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List of orders (see `Order`) waiting for execution.&quot;&quot;&quot;</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">orders</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>    <span class="k">def</span> <span class="nf">trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Tuple[Trade, ...]&#39;</span><span class="p">:</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List of active trades (see `Trade`).&quot;&quot;&quot;</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="k">if</span> <span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">all_trades</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="k">def</span> <span class="nf">closed_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Tuple[Trade, ...]&#39;</span><span class="p">:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;List of settled trades (see `Trade`).&quot;&quot;&quot;</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Allocation</span><span class="p">:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;An object that manages the value allocation among a multi-asset portfolio</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="sd">        `alloc` let&#39;s you build up an allocation plan incrementally, and keeps track of </span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="sd">        the past and expected future allocation of value among different assets. It&#39;s used </span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">        as an input to `Stategy.rebalance()`.</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alloc</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Strategy.alloc" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">alloc</span><span class="p">:</span> <span class="n">Allocation</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>An object that manages the value allocation among a multi-asset portfolio</p>
<p><code>alloc</code> let's you build up an allocation plan incrementally, and keeps track of 
the past and expected future allocation of value among different assets. It's used 
as an input to <code>Stategy.rebalance()</code>.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Strategy.closed_trades" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">closed_trades</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Trade</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>List of settled trades (see <code>Trade</code>).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Strategy.data" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">data</span><span class="p">:</span> <span class="n">_Data</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Price data, roughly as passed into
<code>minitrade.backtest.core.backtesting.Backtest.__init__</code>,
but with two significant exceptions:</p>
<ul>
<li><code>data</code> is <em>not</em> a DataFrame, but a custom structure
  that serves customized numpy arrays for reasons of performance
  and convenience. Besides OHLCV columns, <code>.index</code> and length,
  it offers <code>.pip</code> property, the smallest price unit of change.</li>
<li>Within <code>minitrade.backtest.core.backtesting.Strategy.init</code>, <code>data</code> arrays
  are available in full length, as passed into
  <code>minitrade.backtest.core.backtesting.Backtest.__init__</code>
  (for precomputing indicators and such). However, within
  <code>minitrade.backtest.core.backtesting.Strategy.next</code>, <code>data</code> arrays are
  only as long as the current iteration, simulating gradual
  price point revelation. In each call of
  <code>minitrade.backtest.core.backtesting.Strategy.next</code> (iteratively called by
  <code>minitrade.backtest.core.backtesting.Backtest</code> internally),
  the last array value (e.g. <code>data.Close[-1]</code>)
  is always the <em>most recent</em> value.</li>
<li>If you need data arrays (e.g. <code>data.Close</code>) to be indexed
  <strong>Pandas Series or DataFrame</strong>, you can call their <code>.df</code> accessor
  (e.g. <code>data.Close.df</code>). If you need the whole of data
  as a <strong>DataFrame</strong>, use <code>.df</code> accessor (i.e. <code>data.df</code>).</li>
</ul>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Strategy.equity" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">equity</span><span class="p">:</span> <span class="nb">float</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Current account equity (cash plus assets).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Strategy.orders" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>List of orders (see <code>Order</code>) waiting for execution.</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.I" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">I</span><span class="p">(</span><span class="n">funcval</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Declare an indicator. An indicator is just an array of values,
but one that is revealed gradually in
<code>minitrade.backtest.core.backtesting.Strategy.next</code> much like
<code>minitrade.backtest.core.backtesting.Strategy.data</code> is.
Returns DataFrame in <code>init()</code> and <code>np.ndarray</code> of indicator values in <code>next()</code>.</p>
<p><code>funcval</code> is either a function that returns the indicator array(s) of
same length as <code>minitrade.backtest.core.backtesting.Strategy.data</code>, or
the indicator array(s) itself as a DataFrame, Series, or arrays.</p>
<p>In the plot legend, the indicator is labeled with function name, 
DataFrame column name, or Series name, unless <code>name</code> overrides it.</p>
<p>If <code>plot</code> is <code>True</code>, the indicator is plotted on the resulting
<code>minitrade.backtest.core.backtesting.Backtest.plot</code>.</p>
<p>If <code>overlay</code> is <code>True</code>, the indicator is plotted overlaying the
price candlestick chart (suitable e.g. for moving averages).
If <code>False</code>, the indicator is plotted standalone below the
candlestick chart. </p>
<p><code>color</code> can be string hex RGB triplet or X11 color name.
By default, the next available color is assigned.</p>
<p>If <code>scatter</code> is <code>True</code>, the plotted indicator marker will be a
circle instead of a connected line segment (default).</p>
<p>Additional <code>*args</code> and <code>**kwargs</code> are passed to <code>func</code> and can
be used for parameters.</p>
<p>For example, using simple moving average function from TA-Lib:</p>
<div class="highlight"><pre><span></span><code>def init():
    self.sma = self.I(ta.SMA, self.data.Close, self.n_sma)
</code></pre></div>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># noqa: E743</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>      <span class="n">funcval</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">Callable</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>      <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>      <span class="o">**</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">    Declare an indicator. An indicator is just an array of values,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">    but one that is revealed gradually in</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">    `minitrade.backtest.core.backtesting.Strategy.next` much like</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">    `minitrade.backtest.core.backtesting.Strategy.data` is.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">    Returns DataFrame in `init()` and `np.ndarray` of indicator values in `next()`.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    `funcval` is either a function that returns the indicator array(s) of</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">    same length as `minitrade.backtest.core.backtesting.Strategy.data`, or</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    the indicator array(s) itself as a DataFrame, Series, or arrays.</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">    In the plot legend, the indicator is labeled with function name, </span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">    DataFrame column name, or Series name, unless `name` overrides it.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">    If `plot` is `True`, the indicator is plotted on the resulting</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    `minitrade.backtest.core.backtesting.Backtest.plot`.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">    If `overlay` is `True`, the indicator is plotted overlaying the</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    price candlestick chart (suitable e.g. for moving averages).</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    If `False`, the indicator is plotted standalone below the</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">    candlestick chart. </span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">    `color` can be string hex RGB triplet or X11 color name.</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">    By default, the next available color is assigned.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    If `scatter` is `True`, the plotted indicator marker will be a</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">    circle instead of a connected line segment (default).</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">    Additional `*args` and `**kwargs` are passed to `func` and can</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">    be used for parameters.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">    For example, using simple moving average function from TA-Lib:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">        def init():</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">            self.sma = self.I(ta.SMA, self.data.Close, self.n_sma)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">funcval</span><span class="p">):</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">chain</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="n">func_name</span> <span class="o">=</span> <span class="n">_as_str</span><span class="p">(</span><span class="n">funcval</span><span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">params</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                               <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="nb">map</span><span class="p">(</span><span class="n">_as_str</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">funcval</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Indicator &quot;</span><span class="si">{</span><span class="n">funcval</span><span class="si">}</span><span class="s1">&quot; error&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">value</span> <span class="o">=</span> <span class="n">funcval</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                <span class="s1">&#39;Indicators of pd.DataFrame or pd.Series must have the same index as&#39;</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                <span class="sa">f</span><span class="s1">&#39; `data` (data shape: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span><span class="si">}</span><span class="s1">; indicator shape: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                <span class="sa">f</span><span class="s1">&#39;`data` index: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="sa">f</span><span class="s1">&#39;Indicator index: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">try_</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">is_arraylike</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="c1"># Optionally flip the array if the long side of array is not on the 1st dimension</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="k">if</span> <span class="n">is_arraylike</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_arraylike</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">Close</span><span class="p">):</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="s1">&#39;Indicators of numpy.ndarray must have the same &#39;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="sa">f</span><span class="s1">&#39;length as `data` (data shape: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span><span class="si">}</span><span class="s1">; indicator &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                <span class="sa">f</span><span class="s1">&#39;shape: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;shape&quot;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">, returned value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="c1"># Use an experimental feature to save DataFrame/Series metadata</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="c1"># https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.attrs.html</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="n">value</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="n">plot</span><span class="p">,</span> <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                       <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="n">scatter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_indicators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.buy" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">buy</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">_FULL_EQUITY</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Place a new long order. For explanation of parameters, see <code>Order</code> and its properties.</p>
<p>For single asset strategy, <code>ticker</code> can be left as None.</p>
<p>See <code>Position.close()</code> and <code>Trade.close()</code> for closing existing positions.</p>
<p>See also <code>Strategy.sell()</code>.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="n">size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_FULL_EQUITY</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">    Place a new long order. For explanation of parameters, see `Order` and its properties.</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">    For single asset strategy, `ticker` can be left as None.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">    See `Position.close()` and `Trade.close()` for closing existing positions.</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">    See also `Strategy.sell()`.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">,</span> \
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="s2">&quot;size must be a positive fraction of equity, or a positive whole number of units&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.init" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">init</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Initialize the strategy.
Override this method.
Declare indicators (with <code>minitrade.backtest.core.backtesting.Strategy.I</code>).
Precompute what needs to be precomputed or can be precomputed
in a vectorized fashion before the strategy starts.</p>
<p>If you extend composable strategies from <code>minitrade.backtest.core.backtesting.lib</code>,
make sure to call: <code>super().init()</code></p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="nd">@abstractmethod</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">    Initialize the strategy.</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">    Override this method.</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">    Declare indicators (with `minitrade.backtest.core.backtesting.Strategy.I`).</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">    Precompute what needs to be precomputed or can be precomputed</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">    in a vectorized fashion before the strategy starts.</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">    If you extend composable strategies from `minitrade.backtest.core.backtesting.lib`,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">    make sure to call: `super().init()`</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.next" class="doc doc-heading">
          <code class="highlight language-python"><span class="nb">next</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Main strategy runtime method, called as each new
<code>minitrade.backtest.core.backtesting.Strategy.data</code>
instance (row; full candlestick bar) becomes available.
This is the main method where strategy decisions
upon data precomputed in <code>minitrade.backtest.core.backtesting.Strategy.init</code>
take place.</p>
<p>If you extend composable strategies from <code>minitrade.backtest.core.backtesting.lib</code>,
make sure to call: <code>super().next()</code></p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="nd">@abstractmethod</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">    Main strategy runtime method, called as each new</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">    `minitrade.backtest.core.backtesting.Strategy.data`</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">    instance (row; full candlestick bar) becomes available.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">    This is the main method where strategy decisions</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">    upon data precomputed in `minitrade.backtest.core.backtesting.Strategy.init`</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">    take place.</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">    If you extend composable strategies from `minitrade.backtest.core.backtesting.lib`,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">    make sure to call: `super().next()`</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.position" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">position</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Instance of <code>minitrade.backtest.core.backtesting.Position</code>.</p>
<p>For single asset strategy, <code>ticker</code> can be left as None, which returns
the position of the only asset.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Position&#39;</span><span class="p">:</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Instance of `minitrade.backtest.core.backtesting.Position`.</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">    For single asset strategy, `ticker` can be left as None, which returns</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    the position of the only asset.</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">the_ticker</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.rebalance" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">rebalance</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Rebalance the portfolio according to the current allocation plan.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>force</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If True, rebalance will be performed even if the current allocation
is the same as that of last cycle.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>rtol</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Relative tolerance of the difference between current and previous
allocation in term of total absolute value difference relative to total 
portfolio value. If the difference is smaller than <code>rtol</code>, rebalance will
not be performed.</p>
            </div>
          </td>
          <td>
                <code>0.01</code>
          </td>
        </tr>
        <tr>
          <td><code>atol</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Absolute tolerance of the difference between current and previous
allocation in term of total absolute value difference. If the difference 
is smaller than <code>atol</code>, rebalance will not be performed.</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="k">def</span> <span class="nf">rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">atol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">    Rebalance the portfolio according to the current allocation plan.</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">        force: If True, rebalance will be performed even if the current allocation</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">            is the same as that of last cycle.</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">        rtol: Relative tolerance of the difference between current and previous</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">            allocation in term of total absolute value difference relative to total </span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">            portfolio value. If the difference is smaller than `rtol`, rebalance will</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">            not be performed.</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        atol: Absolute tolerance of the difference between current and previous</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">            allocation in term of total absolute value difference. If the difference </span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">            is smaller than `atol`, rebalance will not be performed.</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">rebalance</span><span class="p">(</span><span class="n">alloc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_alloc</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.record" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">record</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Record arbitrary key-value pairs as time series, which can be plotted later.
Value can be a scalar or a dict or a pd.Series.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">    Record arbitrary key-value pairs as time series, which can be plotted later.</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">    Value can be a scalar or a dict or a pd.Series.</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">:</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_index</span><span class="p">)</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">k</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_registers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span> <span class="n">plot</span><span class="p">,</span> <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="n">overlay</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                                         <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s1">&#39;scatter&#39;</span><span class="p">:</span> <span class="n">scatter</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.sell" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">sell</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">_FULL_EQUITY</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Place a new short order. For explanation of parameters, see <code>Order</code> and its properties.</p>
<p>For single asset strategy, <code>ticker</code> can be left as None.</p>
<p>See also <code>Strategy.buy()</code>.</p>
<p>.. note::
    If you merely want to close an existing long position,
    use <code>Position.close()</code> or <code>Trade.close()</code>.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>         <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>         <span class="n">size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">_FULL_EQUITY</span><span class="p">,</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>         <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>         <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>         <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>         <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>         <span class="n">tag</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">    Place a new short order. For explanation of parameters, see `Order` and its properties.</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">    For single asset strategy, `ticker` can be left as None.</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">    See also `Strategy.buy()`.</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">    .. note::</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        If you merely want to close an existing long position,</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        use `Position.close()` or `Trade.close()`.</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">,</span> \
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="s2">&quot;size must be a positive fraction of equity, or a positive whole number of units&quot;</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Strategy.trades" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">trades</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>List of active trades (see <code>Trade</code>).</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-476" name="__codelineno-0-476"></a><span class="k">def</span> <span class="nf">trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Tuple[Trade, ...]&#39;</span><span class="p">:</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;List of active trades (see `Trade`).&quot;&quot;&quot;</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="k">if</span> <span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broker</span><span class="o">.</span><span class="n">all_trades</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h3 id="minitrade.backtest.core.backtesting.Trade" class="doc doc-heading">
          <code>Trade</code>


</h3>


  <div class="doc doc-contents ">

  
      <p>When an <code>Order</code> is filled, it results in an active <code>Trade</code>.
Find active trades in <code>Strategy.trades</code> and closed, settled trades in <code>Strategy.closed_trades</code>.</p>

            <details class="quote">
              <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="k">class</span> <span class="nc">Trade</span><span class="p">:</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">    When an `Order` is filled, it results in an active `Trade`.</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">    Find active trades in `Strategy.trades` and closed, settled trades in `Strategy.closed_trades`.</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="s1">&#39;_Broker&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry_bar</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span> <span class="o">=</span> <span class="n">broker</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span> <span class="o">=</span> <span class="n">ticker</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">size</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span> <span class="o">=</span> <span class="n">entry_price</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">entry_bar</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span> <span class="o">=</span> <span class="n">tag</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;Trade size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="si">}</span><span class="s1"> time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> &#39;</span> \
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>               <span class="sa">f</span><span class="s1">&#39;price=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1"> pl=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pl</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span> \
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot; tag=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Place new `Order` to close `portion` of the trade at next market price.&quot;&quot;&quot;</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">portion</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;portion must be a fraction between 0 and 1&quot;</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span> <span class="o">*</span> <span class="n">portion</span><span class="p">)),</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">parent_trade</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>                      <span class="n">entry_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="p">)</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="k">if</span> <span class="n">finalize</span><span class="p">:</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>            <span class="k">return</span> <span class="n">order</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>    <span class="c1"># Fields getters</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>    <span class="k">def</span> <span class="nf">ticker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade size (volume; negative for short trades).&quot;&quot;&quot;</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>    <span class="k">def</span> <span class="nf">entry_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade entry price.&quot;&quot;&quot;</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>    <span class="k">def</span> <span class="nf">exit_price</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade exit price (or None if the trade is still active).&quot;&quot;&quot;</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>    <span class="k">def</span> <span class="nf">entry_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Candlestick bar index of when the trade was entered.&quot;&quot;&quot;</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>    <span class="k">def</span> <span class="nf">exit_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a><span class="sd">        Candlestick bar index of when the trade was exited</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a><span class="sd">        (or None if the trade is still active).</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a><span class="sd">        A tag value inherited from the `Order` that opened</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a><span class="sd">        this trade.</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a><span class="sd">        This can be used to track trades and apply conditional</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a><span class="sd">        logic / subgroup analysis.</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a><span class="sd">        See also `Order.tag`.</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tag</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>    <span class="k">def</span> <span class="nf">_sl_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>    <span class="k">def</span> <span class="nf">_tp_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>    <span class="c1"># Extra properties</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>    <span class="k">def</span> <span class="nf">entry_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Datetime of when the trade was entered.&quot;&quot;&quot;</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__entry_bar</span><span class="p">]</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>    <span class="k">def</span> <span class="nf">exit_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Datetime of when the trade was exited.&quot;&quot;&quot;</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__exit_bar</span><span class="p">]</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>    <span class="k">def</span> <span class="nf">is_long</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the trade is long (trade size is positive).&quot;&quot;&quot;</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>    <span class="k">def</span> <span class="nf">is_short</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the trade is short (trade size is negative).&quot;&quot;&quot;</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_long</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>    <span class="k">def</span> <span class="nf">pl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade profit (positive) or loss (negative) in cash units.&quot;&quot;&quot;</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">last_price</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">)</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">*</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span><span class="p">)</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a>    <span class="k">def</span> <span class="nf">pl_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade profit (positive) or loss (negative) in percent.&quot;&quot;&quot;</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">last_price</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">)</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a>        <span class="k">return</span> <span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">price</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entry_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a>    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Trade total value in cash (volume × price).&quot;&quot;&quot;</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a>        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__exit_price</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">last_price</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">)</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">*</span> <span class="n">price</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>    <span class="c1"># SL/TP management API</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>    <span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a><span class="sd">        Stop-loss price at which to close the trade.</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a><span class="sd">        This variable is writable. By assigning it a new price value,</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a><span class="sd">        you create or modify the existing SL order.</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a><span class="sd">        By assigning it `None`, you cancel it.</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sl_order</span><span class="o">.</span><span class="n">stop</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>    <span class="nd">@sl</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>    <span class="k">def</span> <span class="nf">sl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__set_contingent</span><span class="p">(</span><span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a><span class="sd">        Take-profit price at which to close the trade.</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a><span class="sd">        This property is writable. By assigning it a new price value,</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a><span class="sd">        you create or modify the existing TP order.</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a><span class="sd">        By assigning it `None`, you cancel it.</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tp_order</span><span class="o">.</span><span class="n">limit</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>    <span class="nd">@tp</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__set_contingent</span><span class="p">(</span><span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>    <span class="k">def</span> <span class="nf">__set_contingent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>        <span class="k">assert</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">)</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>        <span class="k">assert</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>        <span class="n">attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s1">__</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">_order&#39;</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>            <span class="n">order</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>        <span class="k">if</span> <span class="n">price</span><span class="p">:</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">}</span> <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;sl&#39;</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">}</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">new_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">trade</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.entry_bar" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">entry_bar</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Candlestick bar index of when the trade was entered.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.entry_price" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Trade entry price.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.entry_time" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">entry_time</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Datetime of when the trade was entered.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.exit_bar" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">exit_bar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Candlestick bar index of when the trade was exited
(or None if the trade is still active).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.exit_price" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">exit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Trade exit price (or None if the trade is still active).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.exit_time" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">exit_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Datetime of when the trade was exited.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.is_long" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_long</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True if the trade is long (trade size is positive).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.is_short" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_short</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>True if the trade is short (trade size is negative).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.pl" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pl</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Trade profit (positive) or loss (negative) in cash units.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.pl_pct" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pl_pct</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Trade profit (positive) or loss (negative) in percent.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.size" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">size</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Trade size (volume; negative for short trades).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.sl" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">sl</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Stop-loss price at which to close the trade.</p>
<p>This variable is writable. By assigning it a new price value,
you create or modify the existing SL order.
By assigning it <code>None</code>, you cancel it.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.tag" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tag</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>A tag value inherited from the <code>Order</code> that opened
this trade.</p>
<p>This can be used to track trades and apply conditional
logic / subgroup analysis.</p>
<p>See also <code>Order.tag</code>.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.tp" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tp</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Take-profit price at which to close the trade.</p>
<p>This property is writable. By assigning it a new price value,
you create or modify the existing TP order.
By assigning it <code>None</code>, you cancel it.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h4 id="minitrade.backtest.core.backtesting.Trade.value" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">value</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  
      <p>Trade total value in cash (volume × price).</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h4 id="minitrade.backtest.core.backtesting.Trade.close" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">close</span><span class="p">(</span><span class="n">portion</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


  <div class="doc doc-contents ">
  
      <p>Place new <code>Order</code> to close <code>portion</code> of the trade at next market price.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/core/backtesting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-762" name="__codelineno-0-762"></a><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Place new `Order` to close `portion` of the trade at next market price.&quot;&quot;&quot;</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">portion</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;portion must be a fraction between 0 and 1&quot;</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>    <span class="n">size</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span> <span class="o">*</span> <span class="n">portion</span><span class="p">)),</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__size</span><span class="p">)</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ticker</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">parent_trade</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>                  <span class="n">entry_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__tag</span><span class="p">)</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>    <span class="k">if</span> <span class="n">finalize</span><span class="p">:</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="k">return</span> <span class="n">order</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__broker</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div><h2 id="minitradebacktestutils">minitrade.backtest.utils</h2>


<div class="doc doc-object doc-module">



<a id="minitrade.backtest.utils"></a>
  <div class="doc doc-contents first">
  
      <p><code>minitrade.backtest.utils</code> provides some helper functions for strategy research.</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="minitrade.backtest.utils.backtest_strategy_on_portfolios" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">backtest_strategy_on_portfolios</span><span class="p">(</span><span class="n">data_lst</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">goal</span><span class="o">=</span><span class="s1">&#39;Return [%]&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Run strategy over a list of portfolios and collect their best performance after optimized strategy parameters.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data_lst</code></td>
          <td>
                <code>list[<span title="pandas.DataFrame">DataFrame</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of price data used in <code>Backtest</code>, which implicitly define the portfolio and time range of backtesting.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>strategy</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="minitrade.backtest.core.Strategy" href="#minitrade.backtest.core.backtesting.Strategy">Strategy</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A <code>Strategy</code> class under study</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>goal</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Goal to be optimized for, as required by <code>Backtest.optimize()</code></p>
            </div>
          </td>
          <td>
                <code>&#39;Return [%]&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code>dict[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Parameters to be passed to <code>Backtest.optimize()</code>, which should specify value range for strategy parameters.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>stats</code></td>          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>best performance for each portfolio</p>
            </div>
          </td>
        </tr>
        <tr>
<td><code>heatmap</code></td>          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a heatmap of portfolio performance vs. strategy parameters</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">def</span> <span class="nf">backtest_strategy_on_portfolios</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">data_lst</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span> <span class="n">goal</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Return [%]&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Run strategy over a list of portfolios and collect their best performance after optimized strategy parameters.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        data_lst: A list of price data used in `Backtest`, which implicitly define the portfolio and time range of backtesting.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        strategy: A `Strategy` class under study</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        goal: Goal to be optimized for, as required by `Backtest.optimize()`</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        **kwargs: Parameters to be passed to `Backtest.optimize()`, which should specify value range for strategy parameters.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        stats: best performance for each portfolio</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        heatmap: a heatmap of portfolio performance vs. strategy parameters</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">label_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_lst</span><span class="p">}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="n">_stats</span><span class="p">,</span> <span class="n">_heatmap</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">tq</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">label_data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tq</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">tq</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">bt</span> <span class="o">=</span> <span class="n">Backtest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span> <span class="n">fail_fast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">s</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">maximize</span><span class="o">=</span><span class="n">goal</span><span class="p">,</span> <span class="n">return_heatmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">_stats</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">_heatmap</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">h</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="n">stats</span><span class="p">,</span> <span class="n">heatmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">_stats</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">_heatmap</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">heatmap</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;goal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">goal</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="k">return</span> <span class="n">stats</span><span class="p">,</span> <span class="n">heatmap</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="minitrade.backtest.utils.backtest_strategy_parameters" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">backtest_strategy_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">goals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return [%]&#39;</span><span class="p">,</span> <span class="s1">&#39;Max. Drawdown [%]&#39;</span><span class="p">,</span> <span class="s1">&#39;Calmar Ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;SQN&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Plot the strategy performance vs. a range of strategy parameters for visual inspection.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Price data used in <code>Backtest</code></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>strategy</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="minitrade.backtest.core.Strategy" href="#minitrade.backtest.core.backtesting.Strategy">Strategy</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A <code>Strategy</code> class under study</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>goals</code></td>
          <td>
                <code>list[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of goals as required by <code>Backtest.optimize()</code>. A plot is generated for each.</p>
            </div>
          </td>
          <td>
                <code>[&#39;Return [%]&#39;, &#39;Max. Drawdown [%]&#39;, &#39;Calmar Ratio&#39;, &#39;SQN&#39;]</code>
          </td>
        </tr>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code>dict[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Parameters to be passed to <code>Backtest.optimize()</code>, which should specify value range for strategy parameters.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="k">def</span> <span class="nf">backtest_strategy_parameters</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>                                 <span class="n">goals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Return [%]&#39;</span><span class="p">,</span> <span class="s1">&#39;Max. Drawdown [%]&#39;</span><span class="p">,</span> <span class="s1">&#39;Calmar Ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;SQN&#39;</span><span class="p">],</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Plot the strategy performance vs. a range of strategy parameters for visual inspection.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        data: Price data used in `Backtest`</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        strategy: A `Strategy` class under study</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        goals: A list of goals as required by `Backtest.optimize()`. A plot is generated for each.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        **kwargs: Parameters to be passed to `Backtest.optimize()`, which should specify value range for strategy parameters.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">bt_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rebalance_tolerance&#39;</span><span class="p">,</span> <span class="s1">&#39;rebalance_cash_reserve&#39;</span><span class="p">,</span> <span class="s1">&#39;lot_size&#39;</span><span class="p">]}</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">opt_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rebalance_tolerance&#39;</span><span class="p">,</span> <span class="s1">&#39;rebalance_cash_reserve&#39;</span><span class="p">,</span> <span class="s1">&#39;lot_size&#39;</span><span class="p">]}</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">bt</span> <span class="o">=</span> <span class="n">Backtest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span> <span class="n">fail_fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">bt_args</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">for</span> <span class="n">goal</span> <span class="ow">in</span> <span class="n">goals</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">stats</span><span class="p">,</span> <span class="n">heatmap</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">maximize</span><span class="o">=</span><span class="n">goal</span><span class="p">,</span> <span class="n">return_heatmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">opt_args</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">if</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">heatmap</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">display</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="minitrade.backtest.utils.calculate_positions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">calculate_positions</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">orders</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Calculate the final portfolio based on initial portfolio and order executed.</p>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="k">def</span> <span class="nf">calculate_positions</span><span class="p">(</span><span class="n">plan</span><span class="p">:</span> <span class="s1">&#39;TradePlan&#39;</span><span class="p">,</span> <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculate the final portfolio based on initial portfolio and order executed.&#39;&#39;&#39;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">tickers</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">ticker_css</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">positions</span> <span class="o">=</span> <span class="p">{</span><span class="n">ticker</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">}</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">cash</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">initial_cash</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="k">if</span> <span class="n">plan</span><span class="o">.</span><span class="n">initial_holding</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">plan</span><span class="o">.</span><span class="n">initial_holding</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">positions</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">+=</span> <span class="n">size</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">positions</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">cash</span> <span class="o">-=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">cash</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="minitrade.backtest.utils.calculate_trade_stats" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">calculate_trade_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cash</span><span class="p">,</span> <span class="n">orders</span><span class="p">,</span> <span class="n">holding</span><span class="o">=</span><span class="p">{})</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Create a day-by-day portolio report based on initial cash and order executed.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Price data used in <code>Backtest</code></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>cash</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The initial cash to start with</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>holding</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The asset holding to start with</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>orders</code></td>
          <td>
                <code>list[dict]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of orders executed. Each order is a dictionary like 
{
    'ticker': ...,
    'entry_time': ...,
    'size': ...,
    'entry_price': ...,
    'commission': ...
}</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="k">def</span> <span class="nf">calculate_trade_stats</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cash</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">holding</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}):</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Create a day-by-day portolio report based on initial cash and order executed.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        data: Price data used in `Backtest`</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        cash: The initial cash to start with</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        holding: The asset holding to start with</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        orders: A list of orders executed. Each order is a dictionary like </span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">            {</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">                &#39;ticker&#39;: ...,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">                &#39;entry_time&#39;: ...,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">                &#39;size&#39;: ...,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">                &#39;entry_price&#39;: ...,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">                &#39;commission&#39;: ...</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">            }</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="k">def</span> <span class="nf">close_trade_helper</span><span class="p">(</span><span class="n">open_orders</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Match order with previous orders on the opposite side to make completed trades&#39;&#39;&#39;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">closed_trades</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">for</span> <span class="n">open_order</span> <span class="ow">in</span> <span class="n">open_orders</span><span class="p">[:]:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="k">if</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="k">if</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                    <span class="c1"># if trade in the opposite direction, calculate how much of the original order can be closed</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="n">closed_size</span> <span class="o">=</span> <span class="n">copysign</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])),</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="c1"># create a trade record for the closed part</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                             <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">closed_size</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                             <span class="s1">&#39;entry_bar&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_bar&#39;</span><span class="p">],</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                             <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_time&#39;</span><span class="p">],</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                             <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                             <span class="s1">&#39;exit_bar&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_bar&#39;</span><span class="p">],</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                             <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_time&#39;</span><span class="p">],</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                             <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                             <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">closed_size</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                             <span class="s1">&#39;return_pct[%]&#39;</span><span class="p">:</span> <span class="p">((</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                                               <span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">closed_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                    <span class="n">closed_trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                    <span class="c1"># reduce the size of the original order</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                    <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">closed_size</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                    <span class="k">if</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                        <span class="n">open_orders</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">open_order</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                    <span class="c1"># update the size of the incoming order</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">closed_size</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                        <span class="k">break</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="c1"># if position of the same side exists, break</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="k">break</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">return</span> <span class="n">closed_trades</span><span class="p">,</span> <span class="n">order</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">close_prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="n">orders</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;entry_time&#39;</span><span class="p">])</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="n">open_orders</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="k">if</span> <span class="n">holding</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">holding</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="c1"># Handle the preexisting assets as if they are bought at the first bar</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">open_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="p">{</span><span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;entry_bar&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                 <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">close_prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;commission&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="k">if</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">order_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">order_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;entry_price&#39;</span><span class="p">,</span> <span class="s1">&#39;commission&#39;</span><span class="p">])</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="c1"># match orders that close positions to those open positions in FIFO order to create completed trades</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">while</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="c1"># each bar is denoted by the start time of the bar, therefore minus 1 to get the index</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_bar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;entry_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">closed_trades</span><span class="p">,</span> <span class="n">remaining_order</span> <span class="o">=</span> <span class="n">close_trade_helper</span><span class="p">(</span><span class="n">open_orders</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">trades</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">closed_trades</span><span class="p">)</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="k">if</span> <span class="n">remaining_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">open_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remaining_order</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="c1"># create incompleted trades for remaining open positions</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">alt_trades</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="k">for</span> <span class="n">open_order</span> <span class="ow">in</span> <span class="n">open_orders</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="s1">&#39;entry_bar&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_bar&#39;</span><span class="p">],</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                 <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_time&#39;</span><span class="p">],</span> <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                 <span class="s1">&#39;exit_bar&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;return_pct[%]&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="c1"># alternatively assuming all trades are closed on the last day using its close price</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="n">exit_price</span> <span class="o">=</span> <span class="n">close_prices</span><span class="p">[</span><span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">alt_trade</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="s1">&#39;ticker&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">],</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="s1">&#39;entry_bar&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_bar&#39;</span><span class="p">],</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_time&#39;</span><span class="p">],</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="s1">&#39;exit_bar&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="n">exit_price</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="s1">&#39;return_pct[%]&#39;</span><span class="p">:</span> <span class="p">((</span><span class="n">exit_price</span> <span class="o">/</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">copysign</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="k">if</span> <span class="n">open_order</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="p">}</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">alt_trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_trade</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="c1"># format into dataframe</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="k">if</span> <span class="n">trades</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">trade_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;entry_time&#39;</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="n">alt_trade_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">alt_trades</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">trade_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;entry_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                                         <span class="s1">&#39;entry_price&#39;</span><span class="p">,</span> <span class="s1">&#39;exit_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;exit_time&#39;</span><span class="p">,</span> <span class="s1">&#39;exit_price&#39;</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;return_pct[%]&#39;</span><span class="p">])</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">alt_trade_df</span> <span class="o">=</span> <span class="n">trade_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="c1"># calculate equity value over time</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="n">equity</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">issued_orders</span> <span class="o">=</span> <span class="n">order_df</span><span class="p">[</span><span class="n">order_df</span><span class="p">[</span><span class="s1">&#39;entry_time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="n">issued_orders</span> <span class="o">=</span> <span class="n">order_df</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">cost</span> <span class="o">=</span> <span class="n">issued_orders</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">issued_orders</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">issued_orders</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="n">commission</span> <span class="o">=</span> <span class="n">issued_orders</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="n">positions</span> <span class="o">=</span> <span class="n">issued_orders</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ticker&#39;</span><span class="p">)[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">close_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="k">if</span> <span class="n">holding</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="n">positions</span> <span class="o">=</span> <span class="p">(</span><span class="n">positions</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">holding</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="n">position_value</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">close_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="n">equity</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cash</span> <span class="o">+</span> <span class="n">position_value</span> <span class="o">-</span> <span class="n">cost</span> <span class="o">-</span> <span class="n">commission</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="c1"># calculate ticker performance</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">position_size</span> <span class="o">=</span> <span class="n">trade_df</span><span class="p">[</span><span class="n">trade_df</span><span class="p">[</span><span class="s1">&#39;exit_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ticker&#39;</span><span class="p">)[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Position Size&#39;</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="n">realized_pnl</span> <span class="o">=</span> <span class="n">trade_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ticker&#39;</span><span class="p">)[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Realized PnL&#39;</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="n">total_pnl</span> <span class="o">=</span> <span class="n">alt_trade_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ticker&#39;</span><span class="p">)[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Total PnL&#39;</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">unrealized_pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_pnl</span> <span class="o">-</span> <span class="n">realized_pnl</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Unrealized PnL&#39;</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">pnl</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">position_size</span><span class="p">,</span> <span class="n">unrealized_pnl</span><span class="p">,</span> <span class="n">realized_pnl</span><span class="p">,</span> <span class="n">total_pnl</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="c1"># calculate effective commission rate</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">commission</span> <span class="o">=</span> <span class="n">order_df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">trade_value</span> <span class="o">=</span> <span class="n">order_df</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">order_df</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">commission_rate</span> <span class="o">=</span> <span class="n">commission</span> <span class="o">/</span> <span class="n">trade_value</span> <span class="k">if</span> <span class="n">trade_value</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="k">return</span> <span class="n">trade_df</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="n">pnl</span><span class="p">,</span> <span class="n">commission_rate</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="minitrade.backtest.utils.generate_random_portfolios" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">generate_random_portfolios</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Generate randome portfolios with each containing k assets.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>universe</code></td>
          <td>
                <code>list[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of tickers</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>k</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The desired number of assets in portfolio</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>limit</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The maximum number of samples to generate. If None, generate all possible combinations. </p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list[tuple]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of tuples, each being a portfolio of k assets.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="k">def</span> <span class="nf">generate_random_portfolios</span><span class="p">(</span><span class="n">universe</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Generate randome portfolios with each containing k assets.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        universe: A list of tickers</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        k: The desired number of assets in portfolio</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        limit: The maximum number of samples to generate. If None, generate all possible combinations. </span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        A list of tuples, each being a portfolio of k assets.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">k</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">samples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="n">samples</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">k</span><span class="p">))))</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="minitrade.backtest.utils.plot_heatmap" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">plot_heatmap</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Plot a grid of heatmaps.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>heatmap</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A DataFrame as returned by <code>minitrade.backtest.utils.backtest_strategy_on_portfolios</code></p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>smooth</code></td>
          <td>
                <code>int | None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If smooth is not None, use the lowest performance across a small window centered at a value as the performance for the parameter at the value</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>minitrade/backtest/utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="k">def</span> <span class="nf">plot_heatmap</span><span class="p">(</span><span class="n">heatmap</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">smooth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Plot a grid of heatmaps.</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        heatmap: A DataFrame as returned by `minitrade.backtest.utils.backtest_strategy_on_portfolios`</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        smooth: If smooth is not None, use the lowest performance across a small window centered at a value as the performance for the parameter at the value</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="c1"># If smooth is given, use the lowest performance across a small window centered</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="c1"># at a value as the performance for the parameter at the value</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="c1"># sort portfolio by a rough sense of &quot;overall&quot; performance</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">heatmap</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="c1"># break plot into pages as too big a plot can have memory issue.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">heatmap</span><span class="p">),</span> <span class="mi">50</span><span class="p">):</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">50</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">pg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">heatmap</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goal&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> (rank </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;performance_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>


  




                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../contributing/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Contributing" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Contributing
            </div>
          </div>
        </a>
      
      
        
        <a href="../datasource/" class="md-footer__link md-footer__link--next" aria-label="Next: minitrade.datasource" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              minitrade.datasource
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.indexes", "toc.follow", "navigation.top"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>